{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/夏だからGatsbyのランタイム全部消す/","result":{"data":{"site":{"siteMetadata":{"siteUrl":"https://sititou70.github.io"}},"markdownRemark":{"excerpt":"夏――  日本人にとって，夏の風物詩といえば花火ですよね． ―― ―――― ――――――  一方，フロントエンドエンジニアにとって夏の風物詩といえばLighthouseの花火です． LighthouseはWebページのパフォーマンスや品質を計測するツールであり，このツールには「すべての計測項目で10…","html":"<p>夏――</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 728px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/58a325178249990ce5274f24f2b45376/9dbab/fireworks.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.75824175824175%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAMBAgQF/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAL/2gAMAwEAAhADEAAAAeUzLKllxP8A/8QAGhAAAgMBAQAAAAAAAAAAAAAAAAECAxIRIf/aAAgBAQABBQKuK7Yq3I0a9P/EABYRAAMAAAAAAAAAAAAAAAAAAAEQEf/aAAgBAwEBPwGhf//EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAECAQE/AVf/xAAZEAADAAMAAAAAAAAAAAAAAAAAEBEhIjH/2gAIAQEABj8CyaqQ4v/EABkQAAMBAQEAAAAAAAAAAAAAAAABESEQMf/aAAgBAQABPyF9bw3CJcWAXpGqFP/aAAwDAQACAAMAAAAQTw//xAAXEQADAQAAAAAAAAAAAAAAAAAAAREh/9oACAEDAQE/EMJCM//EABcRAAMBAAAAAAAAAAAAAAAAAAABESH/2gAIAQIBAT8Qbwg//8QAHBABAQADAAMBAAAAAAAAAAAAAREAITFBUXGR/9oACAEBAAE/EEYOXeMyIqHucuIVnMC4Rm60+ZVadJNcl+5B4f3P/9k='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/58a325178249990ce5274f24f2b45376/f4a91/fireworks.webp 728w,\n/static/58a325178249990ce5274f24f2b45376/306fb/fireworks.webp 1300w\"\n              sizes=\"(max-width: 728px) 100vw, 728px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/58a325178249990ce5274f24f2b45376/83881/fireworks.jpg 728w,\n/static/58a325178249990ce5274f24f2b45376/9dbab/fireworks.jpg 1300w\"\n            sizes=\"(max-width: 728px) 100vw, 728px\"\n            type=\"image/jpeg\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/58a325178249990ce5274f24f2b45376/83881/fireworks.jpg\"\n            alt=\"夏の風物詩といえば？\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>日本人にとって，夏の風物詩といえば花火ですよね．</p>\n<p>――</p>\n<p>――――</p>\n<p>――――――</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 728px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c3a03591b1d030d1d2d4610434170f76/daf62/lighthouse_fireworks.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.59340659340659%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAC4jAAAuIwF4pT92AAABUklEQVR42kWQu44TQRBF/RdYmOnnvDzPnhmPseX1sjbSBmAERIhHQkhGxAcQ8Ntna1paEZSqqvvU7du1ssZgqwx1DZi2wCmDmbYkDx15VVCXFdnDiD61OGMxuUddesxQYpSmKAqGridLM6y1rGyi2dw3rL8e2DwG7Ebx8jby4vsR87qiCS3Zj3vW345oZ1GHmvUXYT/OqFcJ837mz7+/3J1OaK1ZLa9udx3l7Ui570iNY3ueqG4nwjwyDRPD7Uz//o4iz7F5SvnugN830WHXdvz8/Yu3j1e88yLoHEMf2I0TQS5zGRrDwH43C9zSyFnoAvO4o64qdKIiX2ZFdHS5XPn84RNvzmfSVASXfyulUAIqrTCy00R6K3We5eSpEWcO71NM5qjqWmonnI47W8KLkJG8zEbBxeVzREhyKVAvy+5qzxS20alvSsI4RKfPYjHM//oJrW60LQp0zFAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/c3a03591b1d030d1d2d4610434170f76/f4a91/lighthouse_fireworks.webp 728w,\n/static/c3a03591b1d030d1d2d4610434170f76/872f1/lighthouse_fireworks.webp 795w\"\n              sizes=\"(max-width: 728px) 100vw, 728px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/c3a03591b1d030d1d2d4610434170f76/beb58/lighthouse_fireworks.png 728w,\n/static/c3a03591b1d030d1d2d4610434170f76/daf62/lighthouse_fireworks.png 795w\"\n            sizes=\"(max-width: 728px) 100vw, 728px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/c3a03591b1d030d1d2d4610434170f76/beb58/lighthouse_fireworks.png\"\n            alt=\"Lightouseの花火\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>一方，フロントエンドエンジニアにとって夏の風物詩といえばLighthouseの花火です．</p>\n<p>LighthouseはWebページのパフォーマンスや品質を計測するツールであり，このツールには「すべての計測項目で100点を取ると花火が上がる」という演出があります．</p>\n<p>というわけで，最近低下気味だった当ブログのパフォーマンスを改善し，Lighthouseで花火を上げてみました．</p>\n<h2 id=\"パフォーマンス低下の原因tbt\" style=\"position:relative;\"><a href=\"#%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E4%BD%8E%E4%B8%8B%E3%81%AE%E5%8E%9F%E5%9B%A0tbt\" aria-label=\"パフォーマンス低下の原因tbt permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>パフォーマンス低下の原因：TBT</h2>\n<p>当ブログの最近のパフォーマンスは80点台後半をウロウロするというものでした．そもそもLighthouseのパフォーマンスは，FCPやSIといったメトリックの組み合わせによって以下のように計算されます．</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f1815d51e8d0c13c3e6191dca6b7b96b/3546d/lighthouse_perf_calc.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.4406779661017%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAC4jAAAuIwF4pT92AAAB7UlEQVR42o2TW4vbMBCF8///UenSlz4VWmihsCzLpvEmsa2LL/JNlmT5dCTHjndpYUUCY3t09OnMzAEfXOM4opASTdNinuf/5h3WoJsNhCrQ1Io2NWjbNm5WSsV4mjy01ui7Dt5/QLD1I8peoSORmkTquoYQElVVoiiKmBPInHNbvK59vAma2aEdOgx9H0nGURPV9Ob0sPH9u/u3m2BUp5/yGoyuLDmHkILoBDT59l7QGBPjhmyoyxKpbvEsGebbQRuhA3lkRlhjYe3y13rEMAzoiTo8z7gTKiZx/pOANRV+XCROTwN99ThkeYrkdIIwDdKKoZQF8jyHpIryQMsZcsZicQLhEAhbDfvziKTh+Mp/40g58iWhK2gc+m6k6y3qjk631sERTTB/is/2bvocGAF94dAkeOw4PqXf8VgJeP4Ab6rgIWV4oJw6ZEqQhwtZIMxzhizLqU38Tc/HYtXUVvbbE5okh2jIKvYL/eULut7cPfR0tnELmXOLh0vsNt8C6ewXSmiL7PGCz2cF2z6TgI7vD2sHlVOPE7+ioN5L0yuu12v0MhCGxg4rCA9Dv1ng/QQ/ubUH3lZ5rWC4nqepWOIpTkig3VPumy8Ozb6x11D4Fi/slTwUSLMM5/MZLBDmGdFeaHJUzNsT/mv0/gLovfLWytyC+QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/f1815d51e8d0c13c3e6191dca6b7b96b/557d2/lighthouse_perf_calc.webp 590w\"\n              sizes=\"(max-width: 590px) 100vw, 590px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/f1815d51e8d0c13c3e6191dca6b7b96b/3546d/lighthouse_perf_calc.png 590w\"\n            sizes=\"(max-width: 590px) 100vw, 590px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/f1815d51e8d0c13c3e6191dca6b7b96b/3546d/lighthouse_perf_calc.png\"\n            alt=\"Lighthouseパフォーマンスのメトリクス\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>これらの中でも，当ブログで足を引っ張っていたのがTBT（Total Blocking Time）でした．TBTはユーザー操作のブロッキングに関するメトリックです．例えば，ランタイムのJSで重い処理を実行するようなサイトでは，ユーザー操作へ即座に反応できないとしてスコアが下がります．TBTは，現状のLighthouseではパフォーマンススコアに最も大きな影響を与える重要なメトリックです．詳しい定義は<a href=\"https://web.dev/lighthouse-total-blocking-time/\">本家の解説</a>を参照してください．</p>\n<h2 id=\"ランタイムの調査\" style=\"position:relative;\"><a href=\"#%E3%83%A9%E3%83%B3%E3%82%BF%E3%82%A4%E3%83%A0%E3%81%AE%E8%AA%BF%E6%9F%BB\" aria-label=\"ランタイムの調査 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ランタイムの調査</h2>\n<p>では何がTBTスコアを下げてしまっているのかを知るために，まずは <em>そもそもランタイムでどのようなコードが読み込まれているのか</em> を調査してみました．</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 728px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e8ea3560f551836011dd05c82668c26c/07133/runtime.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.31868131868132%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAQFA//EABYBAQEBAAAAAAAAAAAAAAAAAAIABP/aAAwDAQACEAMQAAABoLUcBJFI1D//xAAZEAEAAgMAAAAAAAAAAAAAAAABAAIQMUH/2gAIAQEAAQUCsRHDroE//8QAGBEAAgMAAAAAAAAAAAAAAAAAAAECESH/2gAIAQMBAT8Bc3Rp/8QAGBEAAwEBAAAAAAAAAAAAAAAAAAECERP/2gAIAQIBAT8Bl5SOp//EABcQAAMBAAAAAAAAAAAAAAAAAAAgITH/2gAIAQEABj8Ci4f/xAAbEAEAAgIDAAAAAAAAAAAAAAABABEhMVFhkf/aAAgBAQABPyHNhH3eu4AGyHKBanAeT//aAAwDAQACAAMAAAAQRN//xAAYEQACAwAAAAAAAAAAAAAAAAAAAREhUf/aAAgBAwEBPxCoFPD/xAAXEQADAQAAAAAAAAAAAAAAAAAAARFR/9oACAECAQE/EGtEYf/EAB4QAQACAgEFAAAAAAAAAAAAAAEAESFRMWFxgbHB/9oACAEBAAE/EFdTWfcfpAInhMwS8iDSQhrb7sJaXg+ylXD0an//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/e8ea3560f551836011dd05c82668c26c/f4a91/runtime.webp 728w,\n/static/e8ea3560f551836011dd05c82668c26c/cf89a/runtime.webp 2560w\"\n              sizes=\"(max-width: 728px) 100vw, 728px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/e8ea3560f551836011dd05c82668c26c/83881/runtime.jpg 728w,\n/static/e8ea3560f551836011dd05c82668c26c/07133/runtime.jpg 2560w\"\n            sizes=\"(max-width: 728px) 100vw, 728px\"\n            type=\"image/jpeg\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/e8ea3560f551836011dd05c82668c26c/83881/runtime.jpg\"\n            alt=\"ランタイムの内訳\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>ふむふむ．結果を次の3つに分類しました．</p>\n<ol>\n<li>Gatsbyのランタイム（コア機能）\n<ul>\n<li>例：Fast Page Navigation関連（<code class=\"language-text\">@reach/router</code>，<code class=\"language-text\">gatsby-link</code>，各種<code class=\"language-text\">tsx</code>ファイルなど）</li>\n<li>およびそれらのポリフィル（<code class=\"language-text\">polyfills.js</code>← でかい）</li>\n</ul>\n</li>\n<li>Gatsbyプラグインのランタイム\n<ul>\n<li>例：画像の遅延読み込み，レスポンシブ画像（<code class=\"language-text\">lazysizes.js</code>など）</li>\n</ul>\n</li>\n<li>ムダなもの\n<ul>\n<li>例：使用していないソーシャルアイコンのSVGデータ（<code class=\"language-text\">_networks-db.js</code>）</li>\n</ul>\n</li>\n</ol>\n<p>3に関しては今すぐ削ればいいですね．2に関しても，最近はブラウザネイティブの機能で実現できるものが多く，正直プラグインは不要そうです．</p>\n<p>そして，1に関しても不要であるという結論になりました．このランタイムの内訳を見ると，主に<a href=\"https://www.gatsbyjs.com/docs/reference/built-in-components/gatsby-link/\">Fast Page Navigation</a>（以下FPN）のためのコードが多いようです．つまり，当ブログでFPNを捨てるかどうかが問題になります．</p>\n<p>FPNとは，ページ遷移を高速に行うための機能です．リンクをクリックしたときに次のページの描画に必要な情報 <strong>のみ</strong> （たとえばmarkdownテキスト <strong>だけ</strong> ）をfetchし，Reactを使って画面を動的に書き換えるというものです．この機能は，Gatsbyが登場した当時は特に目玉機能として注目されていた記憶があります．</p>\n<p>そもそも当ブログにおいてページ遷移の速さは重要なのでしょうか．過去3ヶ月のGoogle Analyticsのデータを見ると，<strong>当ブログの直帰率は約85％</strong> であり，</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 667px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6df652027e94416cd3a92b485f0a1b36/6ab01/ga_return_ratio.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.12443778110944%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAC4jAAAuIwF4pT92AAABnklEQVR42n2SW27bMBBFtdr+Fl1Lt9EsIECRHdj9KNpKH3aMyI2efFMUJUq6HTKu0SRGBQwojq7O3Bkyk1Li31BKoe86/D6fobVOe3NZlXrR6OteoW1bNE1zzWWMMfR9fw3OOcqyxG63S2td18iLAofjgX6s0VGxoshRUsEI+PXzB/b7bylfVRUy5xzG8RL0PgwDrLXJiRACnAq2z2fIvoHoamjWoWub5CwWYz1L2miMkaFsXlb4sGIOW4oNwLqu2LYN0+ST8MQt8kpgfyjxvWwhTCw+JKj3HvGJsJ5LZNrPqNUMaRZwExJwWRZyPCanSgp83j3j08MjPj6c8OH+iH1tE2Ql8TRNcKQ1NN9TJ5BNwcFQIiy4PhEYK0foYAzu8hZfTyJ9iz1E939jnuek1dR2xelQxjBCUWIOt4FusPiSd7g/ioRbt/fAkbRGqxfgYg2stJhuOPQEZFzgrujgaM7/BVLLT7HlZXKIJz2F7T3Qj9DU8pOikayvQW+BcTStNMhCEJADXejhNXBMQA8hFZibL4dwGxh1ku7vY8PxBwpH/d1JtE7rAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/6df652027e94416cd3a92b485f0a1b36/6a7ad/ga_return_ratio.webp 667w\"\n              sizes=\"(max-width: 667px) 100vw, 667px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/6df652027e94416cd3a92b485f0a1b36/6ab01/ga_return_ratio.png 667w\"\n            sizes=\"(max-width: 667px) 100vw, 667px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/6df652027e94416cd3a92b485f0a1b36/6ab01/ga_return_ratio.png\"\n            alt=\"直帰率のデータ\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p><strong>ページ遷移はおおよそ数回しか行われていない</strong> ことがわかりました．</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 728px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0ad82054d739a9b0789fcd52b32345a3/3f64a/ga_page_navigation_flow.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.01648351648352%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAC4jAAAuIwF4pT92AAABs0lEQVR42o1RTY/TMBTM//8NcIYrSIsEQgjxcVgO0JZtN42TON9NYiduvuykexhe3NUC4sLhHWY0npn37OzZDmFxhJ+7qMsYRmv4IUMY+yjqHN3QwRiDkAdI8xRVXaIfesvxKESSJahEhXEaLOd8dm/wlb/Gp/gVwh9vMA8TmXHIVqI9N1DnFv04ghOnOkXTous7y8VpfNWpxoZoKuMcsx1YtQUTO5yin5iGEZ7vISuojSifDF3vHkVVoJInCFmTwQAWeDitHOkkcUopOPfRDlwcwFsXVbyHHicSMruGaGpruCYzClkfNkpCNhIDhQR0htVQtoJwT2tPcLbsG7xqA09uUdqGE1zfRVamto0k0/GxYSWoXVujpTUH2uToH21rQYZnOofRdMNDvEFQ3iGQB5T8DpoMWeShEAlkV9KnKEyTBk9CCEVmnaSADpo+IC9yul9r22k9XT/Fiw7IJEeuYoiUUcMBy3LBMl9nNrMVXi4rXuyYR27VzYTn+Yqt4Zf9O3xPPmBTfUQW3GKZjE3XRpNAPwnXO/6Jf3Pmr3He+y/w1n+GG/4c7u1LPIwknM0/wv+dX5CdobSnUvaaAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/0ad82054d739a9b0789fcd52b32345a3/f4a91/ga_page_navigation_flow.webp 728w,\n/static/0ad82054d739a9b0789fcd52b32345a3/93a97/ga_page_navigation_flow.webp 1114w\"\n              sizes=\"(max-width: 728px) 100vw, 728px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/0ad82054d739a9b0789fcd52b32345a3/beb58/ga_page_navigation_flow.png 728w,\n/static/0ad82054d739a9b0789fcd52b32345a3/3f64a/ga_page_navigation_flow.png 1114w\"\n            sizes=\"(max-width: 728px) 100vw, 728px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/0ad82054d739a9b0789fcd52b32345a3/beb58/ga_page_navigation_flow.png\"\n            alt=\"ページ遷移のフロー\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>つまり，約85％のユーザーにとってFPNは不要な機能であり，それ以外のユーザーにとっても，たった数回のページ遷移がちょこっと早くなる程度の恩恵しか無いわけです．それどころか，この機能のためにルーターやらコンポーネントやらポリフィルやらがドバドバ読み込まれるのは迷惑でしか無いはずです．</p>\n<p>ということで， <strong>ランタイムは全部要らん</strong> という結論になりました．</p>\n<p>本来ならこの後TBTに関する詳しい調査もしていく予定だったのですが，そもそもランタイムがゼロになったらTBTもゼロになるので調査はここまでとしました．</p>\n<h2 id=\"実装gatsbyのランタイム全部消す\" style=\"position:relative;\"><a href=\"#%E5%AE%9F%E8%A3%85gatsby%E3%81%AE%E3%83%A9%E3%83%B3%E3%82%BF%E3%82%A4%E3%83%A0%E5%85%A8%E9%83%A8%E6%B6%88%E3%81%99\" aria-label=\"実装gatsbyのランタイム全部消す permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>実装：Gatsbyのランタイム全部消す</h2>\n<p><a href=\"https://www.gatsbyjs.com/plugins/gatsby-plugin-no-javascript-utils/\">gatsby-plugin-no-javascript-utils</a>というGatsbyプラグインを使ってランタイムを全部消します．他に<a href=\"https://www.gatsbyjs.com/plugins/gatsby-plugin-no-javascript/\">gatsby-plugin-no-javascript</a>というプラグインもあったのですが，こちらは最新のGatsbyに正式には対応していないとのことでした．<a href=\"https://github.com/itmayziii/gatsby-plugin-no-javascript/issues/26\">依存関係を無理やり解決させれば動く</a>らしいのですが，なんとなく気持ち悪かったのでやめました．</p>\n<p>基本的にこのプラグインを導入するだけでランタイムが全て消えます．しかしこれだけではブログの一部が壊れるので，追加の調整や実装が必要です．ここから先は細かい話になるので，実装に興味のない方は読み飛ばしていただいて結構です．</p>\n<h3 id=\"gatsby-plugin-dark-modeの置き換え\" style=\"position:relative;\"><a href=\"#gatsby-plugin-dark-mode%E3%81%AE%E7%BD%AE%E3%81%8D%E6%8F%9B%E3%81%88\" aria-label=\"gatsby plugin dark modeの置き換え permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">gatsby-plugin-dark-mode</code>の置き換え</h3>\n<p><a href=\"https://www.gatsbyjs.com/plugins/gatsby-plugin-dark-mode/\">gatsby-plugin-dark-mode</a>はテーマの切り替えボタンを実装するためのプラグインです．このプラグインでは<code class=\"language-text\">ThemeToggler</code>というカスタムコンポーネントが与えられ，そこにテーマ切り替えのAPIが渡ってきます．しかし，今回はランタイムにReactがいないので，これらのカスタムコンポーネントやAPIは使えません．</p>\n<p>ではどうしようかと，このプラグインの実装を詳しく読んでみると，<code class=\"language-text\">window</code>にAPIが公開されていることがわかりました．</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">setTheme</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">newTheme</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">//...</span>\n  window<span class=\"token punctuation\">.</span>__theme <span class=\"token operator\">=</span> newTheme<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">//...</span>\n<span class=\"token punctuation\">}</span>\n\nwindow<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">__setPreferredTheme</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">newTheme</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">setTheme</span><span class=\"token punctuation\">(</span>newTheme<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">//...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>そこで，次のように書くことで静的ビルドにおけるハンドラを無理やり宣言しました．</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">ThemeToggleButton</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">className</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>theme-toggle-button<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span>\n      <span class=\"token attr-name\">dangerouslySetInnerHTML</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">__html</span><span class=\"token operator\">:</span>\n          <span class=\"token string\">\"(\"</span> <span class=\"token operator\">+</span>\n          <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            document\n              <span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".theme-toggle-button\"</span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"click\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n                <span class=\"token function\">__setPreferredTheme</span><span class=\"token punctuation\">(</span>__theme <span class=\"token operator\">===</span> <span class=\"token string\">\"light\"</span> <span class=\"token operator\">?</span> <span class=\"token string\">\"dark\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"light\"</span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span>\n          <span class=\"token string\">\")()\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span>\n    <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>ヤバいコードを書いている自覚はあります．罰は甘んじて受けます．</p>\n<h3 id=\"gatsby-plugin-google-analyticsの置き換え\" style=\"position:relative;\"><a href=\"#gatsby-plugin-google-analytics%E3%81%AE%E7%BD%AE%E3%81%8D%E6%8F%9B%E3%81%88\" aria-label=\"gatsby plugin google analyticsの置き換え permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">gatsby-plugin-google-analytics</code>の置き換え</h3>\n<p>GatsbyのようなSPAでGoogle Analyticsを正しく運用するには工夫が必要です．前述したとおり，通常のGatsbyにおいてリンクをクリックしても，Reactによるコンポーネントのレンダリングが発生するだけで実際にページ遷移は発生しません．<a href=\"https://www.gatsbyjs.com/plugins/gatsby-plugin-google-analytics/\">gatsby-plugin-google-analytics</a>は，そのナビゲーション関連の処理にハンドラを仕込み，リンクがクリックされたタイミングでトラッキングも行ってくれるプラグインです．</p>\n<p>しかし，今回の件で当ブログはもはやSPAではなくなりましたので，こんな大層なプラグインは必要なくなりました．代わりに以下のようなローカルプラグインを作りました．</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// gatsby-ssr.js</span>\n<span class=\"token keyword\">const</span> React <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"react\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> isProduction <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">===</span> <span class=\"token string\">\"production\"</span><span class=\"token punctuation\">;</span>\n\nexports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onPreRenderHTML</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> getHeadComponents<span class=\"token punctuation\">,</span> replaceHeadComponents <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isProduction<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> head <span class=\"token operator\">=</span> <span class=\"token function\">getHeadComponents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  head<span class=\"token punctuation\">.</span><span class=\"token function\">unshift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    React<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"link\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">rel</span><span class=\"token operator\">:</span> <span class=\"token string\">\"preconnect\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">href</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://www.googletagmanager.com\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    React<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"link\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">rel</span><span class=\"token operator\">:</span> <span class=\"token string\">\"dns-prefetch\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">href</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://www.googletagmanager.com\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  head<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    React<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"script\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">async</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n      <span class=\"token literal-property property\">src</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://www.googletagmanager.com/gtag/js?id=UA-93342312-1\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    React<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"script\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">dangerouslySetInnerHTML</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">__html</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n          window.dataLayer = window.dataLayer || [];\n          function gtag(){dataLayer.push(arguments);}\n          gtag('js', new Date());\n          gtag('config', 'UA-93342312-1');</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">replaceHeadComponents</span><span class=\"token punctuation\">(</span>head<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"gatsby-plugin-twitterの置き換え\" style=\"position:relative;\"><a href=\"#gatsby-plugin-twitter%E3%81%AE%E7%BD%AE%E3%81%8D%E6%8F%9B%E3%81%88\" aria-label=\"gatsby plugin twitterの置き換え permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">gatsby-plugin-twitter</code>の置き換え</h3>\n<p>ツイッターの埋め込みスクリプトを配置してくれる<a href=\"https://www.gatsbyjs.com/plugins/gatsby-plugin-twitter/\">gatsby-plugin-twitter</a>ですが，どうやらランタイムでスクリプトタグを生成する仕様らしいため置き換えることにしました．以下のようなローカルプラグインを作りました．</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// gatsby-node.js</span>\nexports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onCreateNode</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> node <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>type <span class=\"token operator\">!==</span> <span class=\"token string\">\"MarkdownRemark\"</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n    node<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>content<span class=\"token punctuation\">.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">^&lt;blockquote class=\"twitter-tweet\"</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">m</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">)</span>\n    node<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>content <span class=\"token operator\">+=</span>\n      <span class=\"token string\">'\\n&lt;script async src=\"https://platform.twitter.com/widgets.js\" charset=\"utf-8\">&lt;/script>\\n'</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"gatsby-plugin-offlineの後始末\" style=\"position:relative;\"><a href=\"#gatsby-plugin-offline%E3%81%AE%E5%BE%8C%E5%A7%8B%E6%9C%AB\" aria-label=\"gatsby plugin offlineの後始末 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">gatsby-plugin-offline</code>の後始末</h3>\n<p><a href=\"https://www.gatsbyjs.com/plugins/gatsby-plugin-offline/\">gatsby-plugin-offline</a>は，Service Worker（以下SW）によってオフラインでもサイトを表示できるようにしてくれるプラグインです．当たり前ですが，今回のランタイム削除でこちらのプラグインも動作しなくなりました．それどころか，以前のSWが残っている状態でランタイム無しのサイトを開こうとすると，<a href=\"https://en.wikipedia.org/wiki/Screen_of_death#White\">死の真っ白画面</a>になってしまいました．今回の事とは関係ないですが，このプラグインは以前から挙動が不安定であったため，いっそのこと消してしまいたいと思います．</p>\n<p>SWがあれば問答無用で消すという以下のプラグインを仕込みます．</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// gatsby-ssr.js</span>\n<span class=\"token keyword\">const</span> React <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"react\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> isProduction <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">===</span> <span class=\"token string\">\"production\"</span><span class=\"token punctuation\">;</span>\n\nexports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onPreRenderHTML</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> getHeadComponents<span class=\"token punctuation\">,</span> replaceHeadComponents <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>isProduction<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> head <span class=\"token operator\">=</span> <span class=\"token function\">getHeadComponents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  head<span class=\"token punctuation\">.</span><span class=\"token function\">unshift</span><span class=\"token punctuation\">(</span>\n    React<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"script\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">dangerouslySetInnerHTML</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">__html</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          navigator<span class=\"token punctuation\">.</span>serviceWorker<span class=\"token punctuation\">.</span><span class=\"token function\">getRegistrations</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">registrations</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> registration <span class=\"token keyword\">of</span> registrations<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              registration<span class=\"token punctuation\">.</span><span class=\"token function\">unregister</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">).toString()})()</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">replaceHeadComponents</span><span class=\"token punctuation\">(</span>head<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"最後にパフォーマンスを計測\" style=\"position:relative;\"><a href=\"#%E6%9C%80%E5%BE%8C%E3%81%AB%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E3%82%92%E8%A8%88%E6%B8%AC\" aria-label=\"最後にパフォーマンスを計測 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>最後にパフォーマンスを計測</h2>\n<p>――</p>\n<p>――――</p>\n<p>――――――</p>\n<p><img src=\"/0f4331442b961612ee7ed38eeb1fd064/lighthouse_fireworks.gif\" alt=\"Lihthouseの花火\"></p>\n<p><em>風流ですね…</em></p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>Gatsbyブログのランタイムを全消しすることでLighthouseの花火を上げました．</p>\n<p>私のブログは機能が少ないためGatsbyのコア機能を思い切って削ってみましたが，機能が多い他のサイトでは判断が異なってくると思います．また，コア機能を使用しなくなったからといってGatsbyを使う意味がなくなったかというとそんなことはありません．プラグインシステムやコンテンツ管理，GraphQLと型など，気に入っている部分はまだまだ多いです．</p>\n<p>また，今回の件を通して，Gatsbyというフレームワーク自体がパフォーマンスに弱いと誤解しないでください．実際に，<a href=\"https://gatsbystarterblogsource.gatsbyjs.io/\">Gatsby's blog starterの公式サンプル</a>は良い点数を取ります．ただ，何も考えずにプラグインやコンポーネントを追加していくと，私のサイトのようにパフォーマンスが悪くなることもあるのだということです．さらに，今回はパフォーマンスの指標としてLighthouseを用いましたが，これがあらゆる場面において大正義というわけでもありません．あくまで <em>風流だなぁ</em> という認識です．</p>\n<p>何はともあれ，夏に花火を上げられて良かったです．</p>\n<hr>\n<p>トップ画像：<a href=\"https://www.pakutaso.com/20181224346post-18936.html\">https://www.pakutaso.com/20181224346post-18936.html</a></p>","frontmatter":{"title":"夏だからGatsbyのランタイム全部消す","date":"2021/08/02"},"fields":{"slug":"/夏だからGatsbyのランタイム全部消す/"},"id":"0c5568c9-6d87-56ed-ab0e-caeb9c1aafa4"},"firstImage":{"imageFile":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#080808","images":{"fallback":{"src":"/static/58a325178249990ce5274f24f2b45376/3d85c/fireworks.jpg","srcSet":"/static/58a325178249990ce5274f24f2b45376/3a9da/fireworks.jpg 325w,\n/static/58a325178249990ce5274f24f2b45376/a9612/fireworks.jpg 650w,\n/static/58a325178249990ce5274f24f2b45376/3d85c/fireworks.jpg 1300w","sizes":"(min-width: 1300px) 1300px, 100vw"},"sources":[{"srcSet":"/static/58a325178249990ce5274f24f2b45376/47c81/fireworks.webp 325w,\n/static/58a325178249990ce5274f24f2b45376/82ccd/fireworks.webp 650w,\n/static/58a325178249990ce5274f24f2b45376/1ba16/fireworks.webp 1300w","type":"image/webp","sizes":"(min-width: 1300px) 1300px, 100vw"}]},"width":1300,"height":867}}}},"relatedMarkdownRemarks":{"posts":[{"id":"9f24363b-ee3e-54bf-8a18-46ea3b269bea","frontmatter":{"draft":null}},{"id":"73d6ab42-b3e6-5663-a175-b1f3d69c29e1","frontmatter":{"draft":null}},{"id":"48c65a15-67ca-57d0-9edc-ebcb868f7ad2","frontmatter":{"draft":true}},{"id":"75550af2-8134-5467-a07d-abbb5a4f6b7c","frontmatter":{"draft":true}},{"id":"e4fb8478-b1ad-59eb-95e8-8c5e0500d3f4","frontmatter":{"draft":true}},{"id":"3908aafc-c8d3-5c67-821f-0866592449f2","frontmatter":{"draft":true}},{"id":"63f3c7ad-6c59-52b5-9816-78fd348955ff","frontmatter":{"draft":true}},{"id":"49cf25c1-03f6-575e-8c2f-638ccd6198ea","frontmatter":{"draft":null}},{"id":"50d3cc2a-de7a-5b9a-a8d8-754415fe4d94","frontmatter":{"draft":null}},{"id":"2f30c3f1-0d66-590b-8dba-7836df701d46","frontmatter":{"draft":null}},{"id":"6b318bb6-2c5f-5f38-93c7-5ed1cca1fff8","frontmatter":{"draft":null}},{"id":"a6c64123-b824-5224-8027-90eb12040396","frontmatter":{"draft":null}},{"id":"1162dccb-e1bf-576d-a5c6-0993394feb0a","frontmatter":{"draft":true}},{"id":"0116f663-28d1-507a-b5ab-b189801dd408","frontmatter":{"draft":true}},{"id":"f5a25ce1-67a6-51b2-9bf1-f9fbacb41ad1","frontmatter":{"draft":true}},{"id":"4d43646f-8aa6-52b6-b0b6-5160f0be2b05","frontmatter":{"draft":null}},{"id":"01deffb8-0d62-54c6-9e41-20832cbc3c6e","frontmatter":{"draft":null}},{"id":"067a602f-4581-5707-b896-73190dd8c889","frontmatter":{"draft":null}},{"id":"1086a735-7173-58cc-a813-c540a563aedf","frontmatter":{"draft":false}},{"id":"12222bfa-2e8e-51ee-99d8-8a19902351f5","frontmatter":{"draft":null}},{"id":"1509de3c-7308-5e40-a885-f5ebdb089774","frontmatter":{"draft":null}},{"id":"27f10a38-0ecb-539f-a717-7e40a41bbd10","frontmatter":{"draft":null}},{"id":"29b79017-f96d-5b04-8d01-5b8ee761ebed","frontmatter":{"draft":null}},{"id":"2cfd9e33-b4e1-53e4-884d-d8a6760f3387","frontmatter":{"draft":true}},{"id":"3a3c4125-9986-53bb-8b96-ae29936c96ab","frontmatter":{"draft":null}},{"id":"3b696b96-130d-50de-a673-dc1367f32387","frontmatter":{"draft":null}},{"id":"3c14921d-1ba3-5a7a-93a2-757f3a03ee3a","frontmatter":{"draft":null}},{"id":"3d71b3f9-8d6b-58a4-b6cb-8293daf99d74","frontmatter":{"draft":null}},{"id":"46a22c41-5455-557c-85d4-973a6e2220ee","frontmatter":{"draft":null}},{"id":"4ed3b747-2001-54f4-9661-3acab89ce275","frontmatter":{"draft":null}},{"id":"4edc1b46-b395-5783-af6a-818b8fc9c2dc","frontmatter":{"draft":null}},{"id":"4efc4f86-56aa-5ff4-8994-3946583906ad","frontmatter":{"draft":null}},{"id":"5010f43b-fdb5-5b2b-8f0c-3b7434219588","frontmatter":{"draft":null}},{"id":"50951bb1-eb92-5663-a3d8-8f35f73a1322","frontmatter":{"draft":null}},{"id":"5888c50d-8414-5e8f-b0dc-28a31b29053d","frontmatter":{"draft":null}},{"id":"5dba01b8-593d-5295-b135-16df1c6295e5","frontmatter":{"draft":null}},{"id":"69a4aa90-b728-522c-b34f-abee49825c45","frontmatter":{"draft":true}},{"id":"73ab4455-f04d-5320-bf3a-90b9f7441d13","frontmatter":{"draft":null}},{"id":"75696ec6-74a3-5046-8a3c-f39b36d92311","frontmatter":{"draft":null}},{"id":"7778d041-a5bf-536a-a36f-c0dbc5e08ac7","frontmatter":{"draft":true}},{"id":"78349b16-6e41-5fef-ae38-bcdc5ff297ef","frontmatter":{"draft":true}},{"id":"7a8fc278-a847-5b68-8b74-a83193ba3f55","frontmatter":{"draft":null}},{"id":"7d6499d9-277c-5f07-b8b1-98ae40c50c42","frontmatter":{"draft":true}},{"id":"7d79eb4b-cd4a-5621-a67a-91d9a24dce05","frontmatter":{"draft":null}},{"id":"82d43655-ea2a-52cd-97a3-16b7b28ad150","frontmatter":{"draft":null}},{"id":"84bf9a79-dd68-55d1-a1b3-60ffd3784554","frontmatter":{"draft":null}},{"id":"871ac696-39ea-5c64-94f3-5dc4b73b5770","frontmatter":{"draft":true}},{"id":"89ddbcc0-ed71-5a69-9d55-9677eab3e6cf","frontmatter":{"draft":null}},{"id":"8b3e46c2-1a1e-5af0-8900-7972c7285d15","frontmatter":{"draft":null}},{"id":"8f7b1b24-7738-5b97-bfb6-fd763f11a664","frontmatter":{"draft":true}},{"id":"961ec1e6-3f2b-59d9-a33f-dad76cf67f47","frontmatter":{"draft":null}},{"id":"97f01467-e3a1-58e1-b2a4-db77354cc1a3","frontmatter":{"draft":null}},{"id":"9f02de74-61a0-5daf-a048-1c1022e08fe4","frontmatter":{"draft":null}},{"id":"a091877c-69b8-59f9-8963-1af334fd573c","frontmatter":{"draft":null}},{"id":"a190aac4-0483-5e02-b1d3-261f3b5f313a","frontmatter":{"draft":null}},{"id":"b4251348-b618-5b5b-a2c8-e4c6b2431b83","frontmatter":{"draft":true}},{"id":"be594923-185e-5cca-95b6-5267b3c9fc8c","frontmatter":{"draft":null}},{"id":"bfee69af-7d7f-5d87-9680-d2e9b60f8416","frontmatter":{"draft":null}},{"id":"c2249b7b-b97e-5cf4-8ea9-8024e96851b7","frontmatter":{"draft":true}},{"id":"c2db052c-95c6-5094-935b-9eb39f5c762a","frontmatter":{"draft":null}},{"id":"c5e2431a-cf05-5024-b833-e1c69f680d44","frontmatter":{"draft":null}},{"id":"c6def021-b8da-5dbe-ad3e-811d9286424d","frontmatter":{"draft":true}},{"id":"c7a5adfb-149b-5469-ba35-7421e2101951","frontmatter":{"draft":null}},{"id":"cbdf3192-973c-5d87-9cf1-bb9110e9a169","frontmatter":{"draft":null}},{"id":"d29b4513-0609-5cfc-af49-817467dbed1f","frontmatter":{"draft":null}},{"id":"d4d1afa4-f2f9-5942-ae36-2826fb938af5","frontmatter":{"draft":null}},{"id":"db26c6b9-37b4-5cc4-b1ec-c61dc667863e","frontmatter":{"draft":null}},{"id":"dd0c41cf-0a03-5b89-b5a2-f64859aeae63","frontmatter":{"draft":null}},{"id":"e322eac2-bd89-5347-b20d-d050d303a6be","frontmatter":{"draft":null}},{"id":"e376b2d4-df91-5b82-af7a-a8d02763e922","frontmatter":{"draft":true}},{"id":"e83330dc-2312-5ae6-95fa-53e86909f42b","frontmatter":{"draft":true}},{"id":"eba9aa6a-6e21-5f1b-a0eb-7b6bfb1e04f1","frontmatter":{"draft":null}},{"id":"ebae7878-c4ee-505e-81e2-3d3fc47ea826","frontmatter":{"draft":true}},{"id":"ed7af7f9-75f5-59be-9063-de564576eed7","frontmatter":{"draft":true}},{"id":"f06a6ae0-e961-504c-8dab-a60489c0557a","frontmatter":{"draft":true}},{"id":"f49ce388-e81c-5425-af59-9902f125c20f","frontmatter":{"draft":null}},{"id":"f920a8a8-f5fe-57c9-8792-95c93d2b74eb","frontmatter":{"draft":null}},{"id":"fc7ce496-d3b3-5f39-a04e-8e2dfb960626","frontmatter":{"draft":null}},{"id":"fd6eab68-17d3-5395-8b2b-54a6efe43ebb","frontmatter":{"draft":null}}]}},"pageContext":{"id":"0c5568c9-6d87-56ed-ab0e-caeb9c1aafa4"}},"staticQueryHashes":["1800451590","2576926420","63159454"],"slicesMap":{}}