{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/「クロージャは関数と環境のペア」とは？（JavaScript）/","result":{"data":{"site":{"siteMetadata":{"siteUrl":"https://sititou70.github.io"}},"markdownRemark":{"excerpt":"はじめに クロージャは「関数と環境のペア」と言われます。最初は意味がわかりません。 クロージャ（クロージャー、英語: closure）、関数閉包はプログラミング言語における関数オブジェクトの一種。……（中略）…… 関数とそれを評価する環境のペア であるともいえる。 出典：クロージャ - Wikipedia…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 651px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/566007376866e5cae189b6c99d0e61f1/dfb18/top.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.20890937019969%; position: relative; bottom: 0; left: 0; background-image: url('data:image/svg+xml,%3csvg%20xmlns=\\'http://www.w3.org/2000/svg\\'%20width=\\'400\\'%20height=\\'257\\'%20viewBox=\\'0%200%20400%20257\\'%20preserveAspectRatio=\\'none\\'%3e%3cpath%20d=\\'M74%2091l-1%2032a239%20239%200%2001-32-11l-1%205v5H0v5h40v10l32-12c2%200%202%202%202%2032l1%2032h60v68h6v-68h61l1-2V61l-65-1H74v31m130-30v65l1%2063h128v-62h67v-5h-66l-1-31V61l-64-1-65%201M77%20125v61h123V63H77v62m130%200v61h123V63H207v62m-80%201v17h3c2%200%202%200%202-7v-7h10c8%200%209%200%209-2s-1-2-9-2h-10v-12h10c8%200%2010-1%2010-2%200-2-1-2-12-2h-13v17m128%200v17h14c13%200%2014%200%2014-2s-1-2-12-2h-11v-6l1-5%2010-1c9%200%2010%200%2010-2%200-1-2-2-11-2h-10v-10h11c10%200%2011%200%2011-2s-1-2-13-2h-14v17\\'%20fill=\\'%23d3d3d3\\'%20fill-rule=\\'evenodd\\'/%3e%3c/svg%3e'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/566007376866e5cae189b6c99d0e61f1/737bd/top.webp 651w\"\n              sizes=\"(max-width: 651px) 100vw, 651px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/566007376866e5cae189b6c99d0e61f1/dfb18/top.png 651w\"\n            sizes=\"(max-width: 651px) 100vw, 651px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/566007376866e5cae189b6c99d0e61f1/dfb18/top.png\"\n            alt=\"クロージャを表す画像。2つの正方形が横方向にペアになっており、左の正方形の中にはF、右の正方形の中にはEと書かれている。\"\n            title=\"クロージャを表す画像。2つの正方形が横方向にペアになっており、左の正方形の中にはF、右の正方形の中にはEと書かれている。\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h2 id=\"はじめに\" style=\"position:relative;\"><a href=\"#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB\" aria-label=\"はじめに permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>はじめに</h2>\n<p>クロージャは「関数と環境のペア」と言われます。最初は意味がわかりません。</p>\n<blockquote>\n<p>クロージャ（クロージャー、英語: closure）、関数閉包はプログラミング言語における関数オブジェクトの一種。……（中略）…… <strong>関数とそれを評価する環境のペア</strong> であるともいえる。</p>\n<p>出典：<a href=\"https://ja.wikipedia.org/wiki/%E3%82%AF%E3%83%AD%E3%83%BC%E3%82%B8%E3%83%A3\">クロージャ - Wikipedia</a>、強調と中略は筆者による</p>\n</blockquote>\n<blockquote>\n<p>クロージャは、組み合わされた（囲まれた） <strong>関数と、その周囲の状態（レキシカル環境）への参照の組み合わせ</strong> です。</p>\n<p>出典：<a href=\"https://developer.mozilla.org/ja/docs/Web/JavaScript/Closures\">クロージャ - JavaScript | MDN</a>、強調は筆者による</p>\n</blockquote>\n<p>これを理解するために調べたことをまとめました。</p>\n<h2 id=\"サンプルプログラム\" style=\"position:relative;\"><a href=\"#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0\" aria-label=\"サンプルプログラム permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>サンプルプログラム</h2>\n<p>本記事を通して、以下のプログラムを使用します。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">makeCounter</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> cnt <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    cnt<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> cnt<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> counter1 <span class=\"token operator\">=</span> <span class=\"token function\">makeCounter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> counter2 <span class=\"token operator\">=</span> <span class=\"token function\">makeCounter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">counter1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">counter2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">counter1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 2</span></code></pre></div>\n<p>クロージャの説明として定番のやつですね。</p>\n<h2 id=\"sicpでの説明\" style=\"position:relative;\"><a href=\"#sicp%E3%81%A7%E3%81%AE%E8%AA%AC%E6%98%8E\" aria-label=\"sicpでの説明 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SICPでの説明</h2>\n<p><a href=\"https://mitp-content-server.mit.edu/books/content/sectbyfn/books_pres_0/6515/sicp.zip/full-text/book/book.html\">SICP（Structure and Interpretation of Computer Programs）</a>という本における説明がわかりやすいので紹介します。</p>\n<p>この本で使用されている言語はSchemeですが、JavaScriptに置き換えて説明します。<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup></p>\n<h3 id=\"この章で説明したいこと\" style=\"position:relative;\"><a href=\"#%E3%81%93%E3%81%AE%E7%AB%A0%E3%81%A7%E8%AA%AC%E6%98%8E%E3%81%97%E3%81%9F%E3%81%84%E3%81%93%E3%81%A8\" aria-label=\"この章で説明したいこと permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>この章で説明したいこと</h3>\n<p>クロージャは、</p>\n<ul>\n<li>関数を評価すると作成される</li>\n<li>関数と環境のペアである\n<ul>\n<li>関数：関数への参照。具体的に何なのかは処理系によって異なる</li>\n<li>環境：クロージャが作成されたときの環境への参照</li>\n</ul>\n</li>\n<li>呼び出されたとき、\n<ol>\n<li>新しい環境が作成され、その「外側の環境」はクロージャの環境になる</li>\n<li>新しい環境でクロージャの関数が評価される</li>\n</ol>\n</li>\n</ul>\n<p>環境とは、「束縛の集合」と「外側の環境への参照」のペア。</p>\n<p>束縛とは、「変数」と「値」のペア。</p>\n<h3 id=\"step-0グローバル環境の作成\" style=\"position:relative;\"><a href=\"#step-0%E3%82%B0%E3%83%AD%E3%83%BC%E3%83%90%E3%83%AB%E7%92%B0%E5%A2%83%E3%81%AE%E4%BD%9C%E6%88%90\" aria-label=\"step 0グローバル環境の作成 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 0：グローバル環境の作成</h3>\n<p>プログラムを実行する準備として、次のようなグローバル環境が作成されます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 324px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b533be0c0f38472c5ddd67a1c98dc5ec/03970/env1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 105.24691358024691%; position: relative; bottom: 0; left: 0; background-image: url('data:image/svg+xml,%3csvg%20xmlns=\\'http://www.w3.org/2000/svg\\'%20width=\\'400\\'%20height=\\'421\\'%20viewBox=\\'0%200%20400%20421\\'%20preserveAspectRatio=\\'none\\'%3e%3cpath%20d=\\'M177%2025l-7%208%207%207%206%207-6%207-7%208c0%201%2013%2014%2015%2014l7-7%207-7%207%207%207%207%208-7%207-8-7-7-7-7%207-7%207-8-13-13c-2-1-3-1-9%206l-7%206-7-6-8-7-7%207m17%2068l-5%2013%204%201h4v26h-69c-53%200-69%201-72%202-16%205-28%2017-32%2032-1%208-2%20189%200%20198%203%2015%2015%2029%2030%2034%209%203%20279%203%20288%200%2015-5%2026-16%2031-30%203-9%202-196%200-204-6-16-20-28-36-31l-71-1h-65v-26h4c4%200%204-1%201-9a182%20182%200%2001-7-16c0-1-3%204-5%2011M55%20138c-13%204-23%2014-28%2028-2%205-3%20184-1%20196%203%2019%2018%2034%2037%2036h272c15-2%2027-11%2033-25l4-6V168l-4-7c-5-11-15-20-27-24-8-2-278-1-286%201m64%2026l-1%2014c0%2013%200%2014%202%2014l2-1h3c9%204%2014-9%208-18-1-2-8-3-10-1-1%201-1%200-1-4%200-5-1-6-3-4m42%2014c0%2013%200%2014%202%2014%201%200%202-2%202-14%200-13-1-15-2-15-2%200-2%201-2%2015m-97-11c-3%201-6%207-6%2011%200%2011%2013%2018%2022%2012%203-2%204-3%204-7v-4l-6-1c-5%200-6%200-6%202l4%202c8%200%204%206-4%206-5%200-7-2-9-7-3-9%207-17%2014-11%204%203%207%202%205-1-2-4-13-5-18-2m116%2012v13h11c13-1%2014-2%202-3h-8l-1-5v-4h7c7%200%208%200%208-2s-1-2-8-2h-7v-4l1-3%207-1c5%200%208-1%209-2l-10-1h-11v14m-81-6c-4%204-4%2012%200%2017%203%203%209%203%2013%200%203-4%203-12%200-16s-10-4-13-1m43%200l-2%203h4c1-2%205-2%207-1%202%202%201%204-3%204-6%200-9%202-9%207s6%208%2011%205c2-2%202-2%203%200h5v-2c-1%200-2-3-2-8%200-6-1-8-2-9-3-2-10-1-12%201m63%209c0%209%200%2010%202%2010s2-1%202-8c0-8%200-8%203-9%204-2%205%200%206%209%200%207%200%208%202%208s2-1%202-8c0-9-1-12-6-13l-5%201h-2l-2-1c-2%200-2%201-2%2011m19-10a3070%203070%200%20019%2020%20700%20700%200%20018-21c-2%200-6%208-6%2012%200%205-2%203-4-4l-5-8-2%201m-123%205c-3%207%203%2016%208%2011v-13c-2-2-7-1-8%202m23-1c-4%205-1%2013%203%2013%206-1%206-14%201-15l-4%202\\'%20fill=\\'%23d3d3d3\\'%20fill-rule=\\'evenodd\\'/%3e%3c/svg%3e'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/b533be0c0f38472c5ddd67a1c98dc5ec/89bfd/env1.webp 324w\"\n              sizes=\"(max-width: 324px) 100vw, 324px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/b533be0c0f38472c5ddd67a1c98dc5ec/03970/env1.png 324w\"\n            sizes=\"(max-width: 324px) 100vw, 324px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/b533be0c0f38472c5ddd67a1c98dc5ec/03970/env1.png\"\n            alt=\"四角が1つある。四角の中にGlobal Envと書かれている。その下に区切り線があり、その下は空欄である。四角から矢印が出ており、バツ印を指している。\"\n            title=\"四角が1つある。四角の中にGlobal Envと書かれている。その下に区切り線があり、その下は空欄である。四角から矢印が出ており、バツ印を指している。\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>環境とは、「束縛の集合」と「外側の環境への参照」のペアです。この環境には「Global Env」という名前がついており、区切り線の上に書かれています。</p>\n<p>束縛とは、「変数」と「値」のペアです。束縛の集合は区切り線の下に書かれます。現状は束縛はありません。</p>\n<p>矢印は外側の環境への参照です。グローバル環境に外側は無いため、バツ印を指しています。</p>\n<p>以降は、このグローバル環境でサンプルプログラムを評価していきます。</p>\n<h3 id=\"step-1makecounterの作成\" style=\"position:relative;\"><a href=\"#step-1makecounter%E3%81%AE%E4%BD%9C%E6%88%90\" aria-label=\"step 1makecounterの作成 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 1：<code class=\"language-text\">makeCounter</code>の作成</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">makeCounter</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> cnt <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    cnt<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> cnt<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>上記のプログラムでは、アロー関数をグローバル環境で評価し、その結果をmakeCounterに代入しています。すると以下の図のようになります。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 728px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6b4d1365ec976649bb5166a9a17bf309/d5a17/env2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.989010989010985%; position: relative; bottom: 0; left: 0; background-image: url('data:image/svg+xml,%3csvg%20xmlns=\\'http://www.w3.org/2000/svg\\'%20width=\\'400\\'%20height=\\'144\\'%20viewBox=\\'0%200%20400%20144\\'%20preserveAspectRatio=\\'none\\'%3e%3cpath%20d=\\'M60%209l-2%202%202%202c3%201%203%203%200%206-2%201-2%201%201%204l2%203%203-3%203-2%202%203%202%203%203-3%202-3-2-2-2-3%202-3%202-2-2-3-3-2-2%202-3%202-2-2c-3-3-3-3-6%201m129%2014v8h203V16H189v7m-16-4l-7%201h-8v24h-8l-7%201-1%207c0%208%200%208-2%208l-4-2-2%201c0%202-6%201-6-1l-1-2v2c0%202-1%202-3%202h-4v32h-5l-7-1h-4c-2%203%201%206%204%204l8-1h6V62h5v33c0%2019%201%2025%201%2015V92h2a553%20553%200%20017%201l28-1h28V77l-1%206v7h-27l-28-1h-4l-4%201-1-14V62h3l3%201h4l4-2v8l1%209h24l17-1h-6l-1-16V45h31v16l1%2017V44h-49V22h6l7%201c1%201%208-1%208-2l-7-3-1%201M66%2032v4l1%205v4H44a263%20263%200%200024%202%20841%20841%200%200024-2H69v-4l1-5c1-1-1-8-2-8l-2%204m77%2014v16l1%2015h31V45h-16l-16%201m-75%2090l-49%201h49a599%20599%200%20000-1\\'%20fill=\\'%23d3d3d3\\'%20fill-rule=\\'evenodd\\'/%3e%3c/svg%3e'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/6b4d1365ec976649bb5166a9a17bf309/f4a91/env2.webp 728w,\n/static/6b4d1365ec976649bb5166a9a17bf309/e7b49/env2.webp 946w\"\n              sizes=\"(max-width: 728px) 100vw, 728px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/6b4d1365ec976649bb5166a9a17bf309/beb58/env2.png 728w,\n/static/6b4d1365ec976649bb5166a9a17bf309/d5a17/env2.png 946w\"\n            sizes=\"(max-width: 728px) 100vw, 728px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/6b4d1365ec976649bb5166a9a17bf309/beb58/env2.png\"\n            alt=\"先程の図のGlobal Envの区切り線の下にmakeCounterという項目が追加されている。makeCounterからは矢印が伸びて、正方形が横方向に2つくっついた物を指している。左の正方形の中にはFと書かれており、そこから矢印が伸びて「() =&gt; { let cnt = 0; ... }」というテキストを指している。右の正方形の中にはEと書かれていて、そこから矢印が伸びてGlobal Envの四角形を指している。\"\n            title=\"先程の図のGlobal Envの区切り線の下にmakeCounterという項目が追加されている。makeCounterからは矢印が伸びて、正方形が横方向に2つくっついた物を指している。左の正方形の中にはFと書かれており、そこから矢印が伸びて「() =&gt; { let cnt = 0; ... }」というテキストを指している。右の正方形の中にはEと書かれていて、そこから矢印が伸びてGlobal Envの四角形を指している。\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>関数を評価すると、クロージャが作成されます。正方形の2つのペアがクロージャです。</p>\n<p>左のFと書かれた正方形は、関数への参照です。参照先が具体的に何なのかは処理系によって異なりますが、例えばAST、バイトコード、マシンコードなどがあり得ます。</p>\n<p>右のEと書かれた正方形は、クロージャが作成されたときの環境への参照です。今回は関数をグローバル環境で評価したので、グローバル環境を指しています。</p>\n<p>評価結果であるクロージャをグローバル環境の<code class=\"language-text\">makeCounter</code>に代入します。グローバル環境に<code class=\"language-text\">makeCounter</code>とクロージャの束縛が追加されました。</p>\n<h3 id=\"step-2makecounterの呼び出しcounter1\" style=\"position:relative;\"><a href=\"#step-2makecounter%E3%81%AE%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97counter1\" aria-label=\"step 2makecounterの呼び出しcounter1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 2：<code class=\"language-text\">makeCounter</code>の呼び出し（<code class=\"language-text\">counter1</code>）</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> counter1 <span class=\"token operator\">=</span> <span class=\"token function\">makeCounter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">makeCounter</code>はクロージャなので、<code class=\"language-text\">makeCounter()</code>はクロージャを呼び出しています。</p>\n<p>クロージャが呼び出されると、</p>\n<ol>\n<li>新しい環境が作成され、その「外側の環境」はクロージャの環境になります</li>\n<li>新しい環境でクロージャの関数が評価されます</li>\n</ol>\n<h4 id=\"step-21新しい環境が作成されその外側の環境はクロージャの環境になる\" style=\"position:relative;\"><a href=\"#step-21%E6%96%B0%E3%81%97%E3%81%84%E7%92%B0%E5%A2%83%E3%81%8C%E4%BD%9C%E6%88%90%E3%81%95%E3%82%8C%E3%81%9D%E3%81%AE%E5%A4%96%E5%81%B4%E3%81%AE%E7%92%B0%E5%A2%83%E3%81%AF%E3%82%AF%E3%83%AD%E3%83%BC%E3%82%B8%E3%83%A3%E3%81%AE%E7%92%B0%E5%A2%83%E3%81%AB%E3%81%AA%E3%82%8B\" aria-label=\"step 21新しい環境が作成されその外側の環境はクロージャの環境になる permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 2.1：新しい環境が作成され、その「外側の環境」はクロージャの環境になる</h4>\n<p>新しい環境Env 1を作成します。今回のクロージャの環境はGlobal Envを指しているので、それをEnv 1の外側の環境とします。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 728px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3b652ba23b35e2df8033accf6edd5d6f/d5a17/env3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.36813186813187%; position: relative; bottom: 0; left: 0; background-image: url('data:image/svg+xml,%3csvg%20xmlns=\\'http://www.w3.org/2000/svg\\'%20width=\\'400\\'%20height=\\'178\\'%20viewBox=\\'0%200%20400%20178\\'%20preserveAspectRatio=\\'none\\'%3e%3cpath%20d=\\'M60%209l-2%202%202%203%202%202-2%203-2%202%202%203%203%202%202-2%203-2%203%202%202%202%203-2%202-3-2-2-2-3%202-3%202-2-2-3-3-2-2%202-3%202-2-2c-3-3-3-3-6%201m129%2015c0%207%200%208%202%208%201%200%202%200%201-2h1c2%202%206%203%206%201h1l93%201c98%200%2094%200%2095-4%201-2%201-1%201%201-1%202%200%203%201%203%202%200%202-1%202-8v-8H189v8m-16-5l-7%201-7%201-1%2011v12h-8l-7%201-1%208v8l-4-2h-4c0%202-6%201-6-1l-1-3v2c0%203%200%203-3%203h-4v32h-5l-7-1c-2-2-5%201-4%203%200%202%203%203%205%201l7-1h6V62h5v33a338%20338%200%20002-3l4%202%204%201v-1c0-2%208-2%2065-2h64v18h-11c-6%200-1%201%2012%201%2012%200%2017-1%2011-1h-11V91h-74V78h16V45l-17-1h-32V22h6l7%201h4c5-2%205-3%202-3l-4-2-2%201M66%2032v5l1%204v5l-21-1-24%201%2046%201%2047-1-25-1-21%201v-5l1-4v-4c-2-5-3-5-4-1m77%2030v15h32V46h-32v16m34%200v15h31V46h-31v16m-49%2015l1%2014%204-1c4-2%204-2%204%200l27%201h28V78h-50v-8c0-8%200-8-2-8-6%202-7%202-7%201%201-1%200-1-2-1h-3v15M17%20136\\'%20fill=\\'%23d3d3d3\\'%20fill-rule=\\'evenodd\\'/%3e%3c/svg%3e'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/3b652ba23b35e2df8033accf6edd5d6f/f4a91/env3.webp 728w,\n/static/3b652ba23b35e2df8033accf6edd5d6f/e7b49/env3.webp 946w\"\n              sizes=\"(max-width: 728px) 100vw, 728px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/3b652ba23b35e2df8033accf6edd5d6f/beb58/env3.png 728w,\n/static/3b652ba23b35e2df8033accf6edd5d6f/d5a17/env3.png 946w\"\n            sizes=\"(max-width: 728px) 100vw, 728px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/3b652ba23b35e2df8033accf6edd5d6f/beb58/env3.png\"\n            alt=\"先程の図に加えて新たにEnv 1という環境が書かれている。Env 1の下に区切り線があり、その下に空白がある。Env 1の環境からは矢印が伸び、Global Envの環境を指している。\"\n            title=\"先程の図に加えて新たにEnv 1という環境が書かれている。Env 1の下に区切り線があり、その下に空白がある。Env 1の環境からは矢印が伸び、Global Envの環境を指している。\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h4 id=\"step-22新しい環境でクロージャの関数が評価される\" style=\"position:relative;\"><a href=\"#step-22%E6%96%B0%E3%81%97%E3%81%84%E7%92%B0%E5%A2%83%E3%81%A7%E3%82%AF%E3%83%AD%E3%83%BC%E3%82%B8%E3%83%A3%E3%81%AE%E9%96%A2%E6%95%B0%E3%81%8C%E8%A9%95%E4%BE%A1%E3%81%95%E3%82%8C%E3%82%8B\" aria-label=\"step 22新しい環境でクロージャの関数が評価される permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 2.2：新しい環境でクロージャの関数が評価される</h4>\n<p>クロージャが指す関数の本体は以下です。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> cnt <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  cnt<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> cnt<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>これをEnv 1で評価していきます。</p>\n<p>まず、<code class=\"language-text\">let cnt = 0;</code>によって<code class=\"language-text\">cnt</code>と<code class=\"language-text\">0</code>の束縛が作成されます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 728px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/761d290b5a8877da9c98841194ce60d0/d5a17/env4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.36813186813187%; position: relative; bottom: 0; left: 0; background-image: url('data:image/svg+xml,%3csvg%20xmlns=\\'http://www.w3.org/2000/svg\\'%20width=\\'400\\'%20height=\\'178\\'%20viewBox=\\'0%200%20400%20178\\'%20preserveAspectRatio=\\'none\\'%3e%3cpath%20d=\\'M60%209l-2%202%202%203%202%202-2%203-2%202%202%203%203%202%202-2%203-2%203%202%202%202%203-2%202-3-2-2-2-3%202-3%202-2-2-3-3-2-2%202-3%202-2-2c-3-3-3-3-6%201m129%2015v8h5l5-1h1l93%201c98%200%2094%200%2095-4%201-2%201-1%201%201-1%202%200%203%201%203%202%200%202-1%202-8v-8H189v8m-16-5l-7%201-7%201-1%2011v12h-8l-7%201-1%208v8l-4-2h-4c0%202-6%201-6-1l-1-3v2c0%203%200%203-3%203h-4v32h-5l-7-1c-2-2-5%201-4%203%200%202%203%203%205%201l7-1h6V62h5v33a338%20338%200%20002-3l4%202%204%201v-1c0-2%208-2%2065-2h64v18h-11c-6%200-1%201%2012%201%2012%200%2017-1%2011-1h-11V91h-74V78h16V45l-17-1h-32V22h6l7%201h4c5-1%205-3%202-3l-4-2-2%201M66%2032v5l1%204v5l-21-1-24%201%2046%201%2047-1-25-1-21%201v-5l1-4v-4c-2-5-3-5-4-1m77%2030v15h32V46h-32v16m34%200v15h31V46h-31v16m-49%2015l1%2014%204-1c4-2%204-2%204%200l27%201h28V78h-50v-8c0-8%200-8-2-8-6%202-7%202-7%201%201-1%200-1-2-1h-3v15M17%20136\\'%20fill=\\'%23d3d3d3\\'%20fill-rule=\\'evenodd\\'/%3e%3c/svg%3e'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/761d290b5a8877da9c98841194ce60d0/f4a91/env4.webp 728w,\n/static/761d290b5a8877da9c98841194ce60d0/e7b49/env4.webp 946w\"\n              sizes=\"(max-width: 728px) 100vw, 728px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/761d290b5a8877da9c98841194ce60d0/beb58/env4.png 728w,\n/static/761d290b5a8877da9c98841194ce60d0/d5a17/env4.png 946w\"\n            sizes=\"(max-width: 728px) 100vw, 728px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/761d290b5a8877da9c98841194ce60d0/beb58/env4.png\"\n            alt=\"先程の図に加えて、Env 1にcnt: 0という束縛が増えている。\"\n            title=\"先程の図に加えて、Env 1にcnt: 0という束縛が増えている。\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>次に<code class=\"language-text\">return () => { cnt++; return cnt; };</code>の部分ですが、これは関数（アロー関数）の評価結果を<code class=\"language-text\">return</code>しています。</p>\n<p>おさらいですが、関数を評価するとクロージャが作成されます。</p>\n<p>クロージャは、「関数への参照」と「クロージャが作成されたときの環境（ここではEnv 1）への参照」のペアです。</p>\n<p>これが<code class=\"language-text\">return</code>されて最終的に<code class=\"language-text\">counter1</code>に代入されるため、結果は以下のようになります。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 728px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f1706348acd5949a4e56d3b52d5a4ae7/d5a17/env5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.51098901098901%; position: relative; bottom: 0; left: 0; background-image: url('data:image/svg+xml,%3csvg%20xmlns=\\'http://www.w3.org/2000/svg\\'%20width=\\'400\\'%20height=\\'206\\'%20viewBox=\\'0%200%20400%20206\\'%20preserveAspectRatio=\\'none\\'%3e%3cpath%20d=\\'M60%209l-2%202%202%203%202%202-2%203-2%202%202%203%203%202%202-2%203-2%203%202%202%202%203-2%202-3-2-2-2-3%202-3%202-2-2-3-3-2-2%202-3%202-2-2c-3-3-3-3-6%201m129%2015c0%207%200%208%202%208l2-1h1l2%201%203-1h1l20%201h20l-1-3c0-2%200-3%201-1%201%204-1%204%2074%204s73%200%2074-4c1-2%201-1%201%201-1%202%200%203%201%203%202%200%202-1%202-8v-8H189v8m-16-5l-7%201-7%201-1%2011v12h-8l-7%201-1%207c0%209%200%209-6%206l-2%201-3%201c-2%200-3%200-3-2l-1-3v2c0%203%200%203-3%203h-4v32h-5l-7-1h-4c-2%203%201%206%204%204l8-1h5V62h6v32c0%2019%201%2025%201%2015V92l5%201a321%20321%200%200169-1h64v18h-11c-6%200-1%201%2012%201%2015%200%2019-1%2012-1h-11l-1-10v-9h-73l-1-7v-6h16V44h-49V22h6l7%201c1%201%208-1%208-2l-2-1-4-2-2%201M66%2032v5c1-1%201%201%201%203v5H43c-18%200-25%201-27%202l-2%202%203-1%2052-1a781%20781%200%200022-2H69v-4l1-5c1-1-1-8-2-8l-2%204m77%2014v16l1%2015h31V46l-16-1-16%201m34%2015v16h31V45h-31v16m-49%2016v14l5-2h4l28%201h27V78h-49l-1-8c0-9%200-9-6-6l-2-1-3-1h-3v15m-52%2030c-1%203%204%206%206%203l16-1h15v27H65a738%20738%200%200081%206c6-2%206-2%206%207v8h16v31h4c3%200%204%200%204%202l5-1%204-2-3-1-4-2-2%201c0%202-1%202-3%202h-3l-1-15v-15h50v-16h5l4%201c0%201%201%201%207-1%202%200%202%200%202%2011a320%20320%200%20010-23c0%2011%201%2010-7%208l-2%201-4%201h-5v-16h-67v8c0%209%201%208-7%206l-2%201-14%201c-14%200-16-1-11-3l3-1-3%201h-3v-28l-17-1-17-1c-2-1-4-1-5%201m77%2033v16h31v-32h-31v16m33-15v16l1%2015h31v-32h-16l-16%201m7%2058l-1%208c0%206%200%207%202%207l2-1h8a158%20158%200%200041%200l49%201c50%200%2050%200%2051-4%201-2%201-1%201%201l-1%203h12v-15l-82-1-82%201\\'%20fill=\\'%23d3d3d3\\'%20fill-rule=\\'evenodd\\'/%3e%3c/svg%3e'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/f1706348acd5949a4e56d3b52d5a4ae7/f4a91/env5.webp 728w,\n/static/f1706348acd5949a4e56d3b52d5a4ae7/e7b49/env5.webp 946w\"\n              sizes=\"(max-width: 728px) 100vw, 728px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/f1706348acd5949a4e56d3b52d5a4ae7/beb58/env5.png 728w,\n/static/f1706348acd5949a4e56d3b52d5a4ae7/d5a17/env5.png 946w\"\n            sizes=\"(max-width: 728px) 100vw, 728px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/f1706348acd5949a4e56d3b52d5a4ae7/beb58/env5.png\"\n            alt=\"先程の図に加えて、Global Envにcounter1の束縛が増えている。counter1からはクロージャ（2つの正方形のペア）への矢印が伸びている。そのクロージャの関数（左の正方形）からは「() =&gt; { cnt++; ... };」というテキストへの矢印が、環境（右の正方形）からはEnv 1への矢印が伸びている。\"\n            title=\"先程の図に加えて、Global Envにcounter1の束縛が増えている。counter1からはクロージャ（2つの正方形のペア）への矢印が伸びている。そのクロージャの関数（左の正方形）からは「() =&gt; { cnt++; ... };」というテキストへの矢印が、環境（右の正方形）からはEnv 1への矢印が伸びている。\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"step-3makecounterの呼び出しcounter2\" style=\"position:relative;\"><a href=\"#step-3makecounter%E3%81%AE%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97counter2\" aria-label=\"step 3makecounterの呼び出しcounter2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 3：<code class=\"language-text\">makeCounter</code>の呼び出し（<code class=\"language-text\">counter2</code>）</h3>\n<p>同様に<code class=\"language-text\">counter2</code>が定義されます。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> counter2 <span class=\"token operator\">=</span> <span class=\"token function\">makeCounter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>結果は以下のようになります。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 728px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f138094341bbcfdeeee4b29f9f6dcf78/d5a17/env6.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 82.28021978021978%; position: relative; bottom: 0; left: 0; background-image: url('data:image/svg+xml,%3csvg%20xmlns=\\'http://www.w3.org/2000/svg\\'%20width=\\'400\\'%20height=\\'329\\'%20viewBox=\\'0%200%20400%20329\\'%20preserveAspectRatio=\\'none\\'%3e%3cpath%20d=\\'M60%209l-2%202%202%203%202%202-2%203-2%202%202%203%203%202%202-2%202-3%203%202%203%203%202-3%203-3-2-2-3-2%203-3%202-3-2-2-3-2-2%202-3%202-2-2c-3-3-3-3-6%201m129%2014v8h203V16H189v7m-16-4l-7%201h-8v24h-16v8c0%208%200%208-2%208l-4-2-2%201c0%202-6%201-6-1l-1-2v2c0%202-1%202-3%202h-4v32h-5l-6-1c-1-2-5-1-5%201-1%202%202%205%204%203l7-1h6V63l3-1h3v32c0%2019%201%2025%201%2015V92h2a564%20564%200%20017%201l65-1h64v18h-12c-6%200-1%201%2013%201%2015%200%2020-1%2012-1h-11l-1-10V90h-74V78h16V44h-49V22h6l7%201%205-1%204-1-3-2h-6M66%2032v4l1%205v4H43a1413%201413%200%200149%200H69v-4l1-5c1-1-1-8-2-8l-2%204m77%2028v16h31l1-15V46l-16-1h-16v15m34%200v16h31V45h-31v15m-39%203h-4l-3-1h-3v14c0%2015%200%2015%206%2013h3l28%201h27V78h-49l-1-9v-8l-4%202m-62%2044c-1%203%203%206%205%203l16-1h16v27H79v-5l1-6c2-2%201-5-2-5-2%200-4%203-2%204l1%207v5H19l24%201h24v2a562%20562%200%2001-1%207l1%2040v40h10v17l1%2019c0%202%204%202%2033%202l32%201h5l4-2v16h8l8%201v31h4l4%201h7l3-2-3-1c-6-2-7-2-7-1%200%202-1%202-3%202h-3v-30l24-1h25v-15h4l5%201h5l4-2v11a319%20319%200%20010-23c0%2011%200%2011-2%2011-5-2-7-2-7-1l-4%201h-5v-16h-67v8c0%209%201%208-7%206l-2%201-32%201H79v-36h187v7h-12c-6%200-1%201%2013%201%2015%200%2020-1%2012-1h-11l-1-5v-4H79v-87h17c16%200%2017%200%2017%202%201%202%202%202%2015%202l15%201h4l5-2v16h8l8%201v31h4l4%201h6l4-2-3-1c-6-2-7-2-7-1l-3%201h-3v-29l24-1h25v-15h5l4%201h5l4-2v11a319%20319%200%20010-23c0%2010%200%2011-2%2011-4-2-7-2-7-1l-4%201h-5v-16h-67v8c0%208%200%208-2%208-5-2-7-2-7-1l-14%201c-14%200-16-1-12-3l3-1h-3c-2%201-2%201-2-13v-14l-17-1-17-1c-2-1-4-1-5%201m77%2033v15h31v-31h-31v16m33%200v15h32v-31h-32v16m-117-2l1%205v3l-1%2039v39h9l-1-43v-44h-4l-4%201m123%2052c0%207%200%208%202%208%201%200%202-1%201-6%200-5%200-5%201-1%201%206%202%207%204%207l3-1h1a158%20158%200%200041%200%201129%201129%200%2000106%201h6v-16H192v8m-39%2072v16h31v-31h-31v15m34-14l-1%2015v15h32v-31h-15l-16%201m5%2065v8h5l6-1h1l20%201%2019-1h2l49%201a498%20498%200%200057%200h6v-16H192v8\\'%20fill=\\'%23d3d3d3\\'%20fill-rule=\\'evenodd\\'/%3e%3c/svg%3e'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/f138094341bbcfdeeee4b29f9f6dcf78/f4a91/env6.webp 728w,\n/static/f138094341bbcfdeeee4b29f9f6dcf78/e7b49/env6.webp 946w\"\n              sizes=\"(max-width: 728px) 100vw, 728px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/f138094341bbcfdeeee4b29f9f6dcf78/beb58/env6.png 728w,\n/static/f138094341bbcfdeeee4b29f9f6dcf78/d5a17/env6.png 946w\"\n            sizes=\"(max-width: 728px) 100vw, 728px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/f138094341bbcfdeeee4b29f9f6dcf78/beb58/env6.png\"\n            alt=\"先程の図に加えて、Env 2という環境が追加されている。Env 2にはcnt: 0という束縛があり、Global Envに向かって矢印が伸びている。Global Envにはcounter2という束縛が追加されている。counter2からは新しいクロージャに向かって矢印が伸びている。新しいクロージャの関数は「() =&gt; { cnt++; ... };」というテキストを、環境はEnv 2を指している。\"\n            title=\"先程の図に加えて、Env 2という環境が追加されている。Env 2にはcnt: 0という束縛があり、Global Envに向かって矢印が伸びている。Global Envにはcounter2という束縛が追加されている。counter2からは新しいクロージャに向かって矢印が伸びている。新しいクロージャの関数は「() =&gt; { cnt++; ... };」というテキストを、環境はEnv 2を指している。\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"step-4counterの呼び出し\" style=\"position:relative;\"><a href=\"#step-4counter%E3%81%AE%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97\" aria-label=\"step 4counterの呼び出し permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 4：counterの呼び出し</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">counter1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1</span></code></pre></div>\n<p><code class=\"language-text\">counter1()</code>はクロージャを呼び出しています。</p>\n<p>おさらいですが、クロージャが呼び出されると、クロージャの環境を外側の環境とする新しい環境が作成され、そこでクロージャの関数が評価されます。</p>\n<p>したがって、まず以下ようなEnv 3が作成されます。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 728px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b9c80711bcd5518caeffa11b7197de90/d5a17/env7.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 82.28021978021978%; position: relative; bottom: 0; left: 0; background-image: url('data:image/svg+xml,%3csvg%20xmlns=\\'http://www.w3.org/2000/svg\\'%20width=\\'400\\'%20height=\\'329\\'%20viewBox=\\'0%200%20400%20329\\'%20preserveAspectRatio=\\'none\\'%3e%3cpath%20d=\\'M60%209l-2%202%202%203%202%202-2%203-2%202%202%203%203%202%202-2%202-3%203%202%203%203%202-3%203-3-2-2-3-2%203-3%202-3-2-2-3-2-2%202-3%202-2-2c-3-3-3-3-6%201m129%2014v8h203V16H189v7m-16-4l-7%201h-8v24h-16v8c0%208%200%208-2%208l-4-2-2%201c0%202-6%201-6-1l-1-2v2c0%202-1%202-3%202h-4v32h-5l-6-1c-1-2-5-1-5%201-1%202%202%205%204%203l7-1h6V63l3-1h3v32c0%2019%201%2025%201%2015V92h2a564%20564%200%20017%201l65-1h64v18h-12c-6%200-1%201%2013%201%2015%200%2020-1%2012-1h-11l-1-10V90h-74V78h16V44h-49V22h6l7%201%205-1%204-1-3-2h-6M66%2032v4l1%205v4H44a263%20263%200%200024%202%20841%20841%200%200024-2H69v-4l1-5c1-1-1-8-2-8l-2%204m77%2028v16h31l1-15V46l-16-1h-16v15m34%200v16h31V45h-31v15m-39%203h-4l-3-1h-3v14c0%2015%200%2015%206%2013h3l28%201h27V78h-49l-1-9v-8l-4%202m195%2030v8h-10l-9%201-1%2018v19h-4l-4-1h-4l-4%201-1-11c0-9%200-12-2-14v1a240%20240%200%20012%2037v-12l4%202h5l5-1h5v-38h9c11%200%2010%200%2010-10l-1-7v7M76%20107c-1%203%203%206%205%203l16-1h16v27H79v-5l1-6c2-2%201-5-2-5-2%200-4%203-2%204l1%207v5H19l24%201h24v2a562%20562%200%2001-1%207l1%2040v40h10v19l1%2019h32a236%20236%200%200138%201l4-2v16h8l8%201v31h4l4%201h7l3-2-3-1c-6-2-7-2-7-1%200%202-1%202-3%202h-3v-30l24-1h25v-15h4l5%201h5l4-2v11a319%20319%200%20010-23c0%2011%200%2011-2%2011-5-2-7-2-7-1l-4%201h-5v-16h-67v8c0%209%201%208-7%206l-2%201-32%201H79v-36h187v7h-12c-6%200-1%201%2013%201%2015%200%2020-1%2012-1h-11l-1-5v-4H79v-87h17c16%200%2017%200%2017%202%201%202%202%202%2015%202l15%201h4l5-2v16h8l8%201v31h4l4%201h6l4-2-3-1c-6-2-7-2-7-1l-3%201h-3v-29l24-1h25v-15h5l4%201h5l4-2v11a319%20319%200%20010-23c0%2010%200%2011-2%2011-4-2-7-2-7-1l-4%201h-5v-16h-67v8c0%208%200%208-2%208-5-2-7-2-7-1l-14%201c-14%200-16-1-12-3l3-1h-3c-2%201-2%201-2-13v-14l-17-1-17-1c-2-1-4-1-5%201m77%2033v15h31v-31h-31v16m33%200v15h32v-31h-32v16m-117-2l1%205v3l-1%2039v39h9l-1-43v-44h-4l-4%201m123%2052c0%207%200%208%202%208%201%200%202-1%201-6%200-5%200-5%201-1%201%206%202%207%204%207l3-1h1a158%20158%200%200041%200%201129%201129%200%2000106%201h6v-16H192v8m-39%2072v16h31v-31h-31v15m34-14l-1%2015v15h32v-31h-15l-16%201m5%2065v8h5l6-1h1l20%201%2019-1h2l49%201a498%20498%200%200057%200h6v-16H192v8\\'%20fill=\\'%23d3d3d3\\'%20fill-rule=\\'evenodd\\'/%3e%3c/svg%3e'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/b9c80711bcd5518caeffa11b7197de90/f4a91/env7.webp 728w,\n/static/b9c80711bcd5518caeffa11b7197de90/e7b49/env7.webp 946w\"\n              sizes=\"(max-width: 728px) 100vw, 728px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/b9c80711bcd5518caeffa11b7197de90/beb58/env7.png 728w,\n/static/b9c80711bcd5518caeffa11b7197de90/d5a17/env7.png 946w\"\n            sizes=\"(max-width: 728px) 100vw, 728px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/b9c80711bcd5518caeffa11b7197de90/beb58/env7.png\"\n            alt=\"先程の図に加えて、Env 3という環境が追加されている。この環境に束縛はなく、Env 1に矢印が伸びている。\"\n            title=\"先程の図に加えて、Env 3という環境が追加されている。この環境に束縛はなく、Env 1に矢印が伸びている。\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>次に、クロージャの関数をEnv 3で評価します。クロージャが指す関数の本体は以下のとおりです。</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">cnt<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">return</span> cnt<span class=\"token punctuation\">;</span></code></pre></div>\n<p>まず、Env 3で<code class=\"language-text\">cnt++;</code>を評価します。Env 3に 変数<code class=\"language-text\">cnt</code>の束縛はないため、外側の環境である Env 1に探しに行きます。そこで<code class=\"language-text\">cnt</code>が見つかるため、Env 1の<code class=\"language-text\">cnt</code>をインクリメントして、以下のようになります。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 728px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/60758a51d2dd8e31a7e8c6752f72cca8/d5a17/env8.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 82.28021978021978%; position: relative; bottom: 0; left: 0; background-image: url('data:image/svg+xml,%3csvg%20xmlns=\\'http://www.w3.org/2000/svg\\'%20width=\\'400\\'%20height=\\'329\\'%20viewBox=\\'0%200%20400%20329\\'%20preserveAspectRatio=\\'none\\'%3e%3cpath%20d=\\'M60%209l-2%202%202%203%202%202-2%203-2%202%202%203%203%202%202-2%202-3%203%202%203%203%202-3%203-3-2-2-3-2%203-3%202-3-2-2-3-2-2%202-3%202-2-2c-3-3-3-3-6%201m129%2014v8h203V16H189v7m-16-4l-7%201h-8v24h-16v8c0%208%200%208-2%208l-4-2-2%201c0%202-6%201-6-1l-1-2v2c0%202-1%202-3%202h-4v32h-5l-6-1c-1-2-5-1-5%201-1%202%202%205%204%203l7-1h6V63l3-1h3v32c0%2019%201%2025%201%2015V92h2a564%20564%200%20017%201l65-1h64v18h-12c-6%200-1%201%2013%201%2015%200%2020-1%2012-1h-11l-1-10V90h-74V78h16V44h-49V22h6l7%201%205-1%204-1-3-2h-6M66%2032v4l1%205v4H44a263%20263%200%200024%202%20841%20841%200%200024-2H69v-4l1-5c1-1-1-8-2-8l-2%204m77%2028v16h31l1-15V46l-16-1h-16v15m34%200v16h31V45h-31v15m-39%203h-4l-3-1h-3v14c0%2015%200%2015%206%2013h3l28%201h27V78h-49l-1-9v-8l-4%202m195%2030v8h-10l-9%201-1%2018v19h-4l-4-1h-4l-4%201-1-11c0-9%200-12-2-14v1a240%20240%200%20012%2037v-12l4%202h5l5-1h5v-38h9c11%200%2010%200%2010-10l-1-7v7M76%20107c-1%203%203%206%205%203l16-1h16v27H79v-5l1-6c2-2%201-5-2-5-2%200-4%203-2%204l1%207v5H19l24%201h24v2a562%20562%200%2001-1%207l1%2040v40h10v19l1%2019h32a236%20236%200%200138%201l4-2v16h8l8%201v31h4l4%201h7l3-2-3-1c-6-2-7-2-7-1%200%202-1%202-3%202h-3v-30l24-1h25v-15h4l5%201h5l4-2v11a319%20319%200%20010-23c0%2011%200%2011-2%2011-5-2-7-2-7-1l-4%201h-5v-16h-67v8c0%209%201%208-7%206l-2%201-32%201H79v-36h187v7h-12c-6%200-1%201%2013%201%2015%200%2020-1%2012-1h-11l-1-5v-4H79v-87h17c16%200%2017%200%2017%202%201%202%202%202%2015%202l15%201h4l5-2v16h8l8%201v31h4l4%201h6l4-2-3-1c-6-2-7-2-7-1l-3%201h-3v-29l24-1h25v-15h5l4%201h5l4-2v11a319%20319%200%20010-23c0%2010%200%2011-2%2011-4-2-7-2-7-1l-4%201h-5v-16h-67v8c0%208%200%208-2%208-5-2-7-2-7-1l-14%201c-14%200-16-1-12-3l3-1h-3c-2%201-2%201-2-13v-14l-17-1-17-1c-2-1-4-1-5%201m77%2033v15h31v-31h-31v16m33%200v15h32v-31h-32v16m-117-2l1%205v3l-1%2039v39h9l-1-43v-44h-4l-4%201m123%2052c0%207%200%208%202%208%201%200%202-1%201-6%200-5%200-5%201-1%201%206%202%207%204%207l3-1h1a158%20158%200%200041%200%201129%201129%200%2000106%201h6v-16H192v8m-39%2072v16h31v-31h-31v15m34-14l-1%2015v15h32v-31h-15l-16%201m5%2065v8h5l6-1h1l20%201%2019-1h2l49%201a498%20498%200%200057%200h6v-16H192v8\\'%20fill=\\'%23d3d3d3\\'%20fill-rule=\\'evenodd\\'/%3e%3c/svg%3e'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/60758a51d2dd8e31a7e8c6752f72cca8/f4a91/env8.webp 728w,\n/static/60758a51d2dd8e31a7e8c6752f72cca8/e7b49/env8.webp 946w\"\n              sizes=\"(max-width: 728px) 100vw, 728px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/60758a51d2dd8e31a7e8c6752f72cca8/beb58/env8.png 728w,\n/static/60758a51d2dd8e31a7e8c6752f72cca8/d5a17/env8.png 946w\"\n            sizes=\"(max-width: 728px) 100vw, 728px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/60758a51d2dd8e31a7e8c6752f72cca8/beb58/env8.png\"\n            alt=\"先程の図とほぼ同じだが、Env 1のcntの値が1になっている。\"\n            title=\"先程の図とほぼ同じだが、Env 1のcntの値が1になっている。\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>次に、Env 3で<code class=\"language-text\">return cnt;</code>を評価します。先ほどと同じように<code class=\"language-text\">cnt</code>を探索すると、Env 1で束縛が見つかるため、最終的に<code class=\"language-text\">1</code>が<code class=\"language-text\">return</code>され、<code class=\"language-text\">console.log</code>によって表示されます。</p>\n<p>同じように、<code class=\"language-text\">counter2</code>を呼び出した場合は、Env 2の<code class=\"language-text\">cnt</code>がインクリメントされます。</p>\n<p>最終的に、すべてのサンプルプログラムの実行が終わった時点では、以下の図のようになっています。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 728px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f014a272088de35b9eed7beed0b3054f/d5a17/env9.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 82.28021978021978%; position: relative; bottom: 0; left: 0; background-image: url('data:image/svg+xml,%3csvg%20xmlns=\\'http://www.w3.org/2000/svg\\'%20width=\\'400\\'%20height=\\'329\\'%20viewBox=\\'0%200%20400%20329\\'%20preserveAspectRatio=\\'none\\'%3e%3cpath%20d=\\'M60%209l-2%202%202%203%202%202-2%203-2%202%202%203%203%202%202-2%202-3%203%202%203%203%202-3%203-3-2-2-3-2%203-3%202-3-2-2-3-2-2%202-3%202-2-2c-3-3-3-3-6%201m129%2014v8h203V16H189v7m-16-4l-7%201h-8v24h-16v8c0%208%200%208-2%208-6-2-7-2-7-1%201%201%200%201-2%201s-3-1-3-2l-1-2v2c0%202-1%202-3%202h-4v32h-5l-6-1c-1-2-5-1-5%201-1%202%202%205%204%203l7-1c7%200%207%200%207-18V62h5v32c0%2019%201%2025%201%2015V92h2a564%20564%200%20017%201l65-1h64v18h-12c-6%200-1%201%2013%201%2015%200%2020-1%2012-1h-11l-1-10V90h-74V78h16V44h-49V22h6l7%201%205-1%204-1-3-2h-6M66%2032v4l1%205v4H44a263%20263%200%200024%202%20841%20841%200%200024-2H69v-4l1-5c1-1-1-8-2-8l-2%204m77%2028v16h31l1-15V46l-16-1h-16v15m34%200v16h31V45h-31v15m-39%203h-4l-3-1h-3v14c0%2015%200%2015%206%2013h3l28%201h27V78h-49l-1-9v-8l-4%202m195%2030v7l-10%201-9%201-1%2018v19h-4l-4-1c0-2%200-2-4%200l-5%201v-11c0-9%200-12-2-14v1a240%20240%200%20012%2037v-12l4%202h5l4-1h5v12h9l10%201v7c0%2011-1%2011%2029%2011%2023%200%2028-1%2028-3h-2c-4%203-49%203-52%200-3-2-3-30%200-33v-2c-2%200-3%203-3%2010v8h-18v-49h18v8l1-9V86l-1%207M76%20107c-1%203%203%206%205%203l16-1h16v27H79v-5l1-6c2-2%201-5-2-5-2%200-4%203-2%204l1%207v5H19l24%201h24v2a562%20562%200%2001-1%207l1%2040v40h10v19l1%2019h32a236%20236%200%200138%201l4-2v16h8l8%201v31h4l4%201h7l3-2-3-1c-6-2-7-2-7-1%200%202-1%202-3%202h-3v-30l24-1h25v-15h4l5%201h5l4-2v11a319%20319%200%20010-23c0%2011%200%2011-2%2011-5-2-7-2-7-1l-4%201h-5v-16h-67v8c0%209%201%208-7%206l-2%201-32%201H79v-36h187v7h-12c-6%200-1%201%2013%201%2015%200%2020-1%2012-1h-11l-1-5v-4H79v-87h17c16%200%2017%200%2017%202%201%202%202%202%2015%202l15%201h4l5-2v16h8l8%201v31h4l4%201h6l4-2-3-1c-6-2-7-2-7-1l-3%201h-3v-29l24-1h25v-15h5l4%201h5l4-2v11a319%20319%200%20010-23c0%2010%200%2011-2%2011-4-2-7-2-7-1l-4%201h-5v-16h-67v8c0%208%200%208-2%208-5-2-7-2-7-1l-14%201c-14%200-16-1-12-3l3-1h-3c-2%201-2%201-2-13v-14l-17-1-17-1c-2-1-4-1-5%201m77%2033v15h31v-31h-31v16m33%200v15h32v-31h-32v16m-117-2l1%205v3l-1%2039v39h9l-1-43v-44h-4l-4%201m123%2052v8h5l6-1h1l20%201%2019-1h2a1129%201129%200%2000106%201h6v-16H192v8m102%2048a240%20240%200%20012%2037v-12l4%202h5l5-1h5v-10h19v-17l-1%208v7h-10l-9%201-1%204v5h-4l-4-1c0-1-2-1-7%201-2%200-2%200-2-11%200-9%200-12-2-14v1m-141%2024v16h31v-31h-31v15m34-14l-1%2015v15h32v-31h-15l-16%201m5%2065v8h5l6-1h1l20%201%2019-1h2l49%201a498%20498%200%200057%200h6v-16H192v8\\'%20fill=\\'%23d3d3d3\\'%20fill-rule=\\'evenodd\\'/%3e%3c/svg%3e'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/f014a272088de35b9eed7beed0b3054f/f4a91/env9.webp 728w,\n/static/f014a272088de35b9eed7beed0b3054f/e7b49/env9.webp 946w\"\n              sizes=\"(max-width: 728px) 100vw, 728px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/f014a272088de35b9eed7beed0b3054f/beb58/env9.png 728w,\n/static/f014a272088de35b9eed7beed0b3054f/d5a17/env9.png 946w\"\n            sizes=\"(max-width: 728px) 100vw, 728px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/f014a272088de35b9eed7beed0b3054f/beb58/env9.png\"\n            alt=\"先程の図に加えて、Env 4、Env 5が追加されている。いずれも束縛はない。Env 4からはEnv 2へ矢印が伸びている。Env 5からはEnv 2へ矢印が伸びている。また、Env 1のcntの値は2に、Env 2のcntの値は1になっている。\"\n            title=\"先程の図に加えて、Env 4、Env 5が追加されている。いずれも束縛はない。Env 4からはEnv 2へ矢印が伸びている。Env 5からはEnv 2へ矢印が伸びている。また、Env 1のcntの値は2に、Env 2のcntの値は1になっている。\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"sicpの説明まとめ\" style=\"position:relative;\"><a href=\"#sicp%E3%81%AE%E8%AA%AC%E6%98%8E%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"sicpの説明まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SICPの説明まとめ</h3>\n<p>クロージャは、</p>\n<ul>\n<li>関数を評価すると作成される</li>\n<li>関数と環境のペアである\n<ul>\n<li>関数：関数への参照。具体的に何なのかは処理系によって異なる</li>\n<li>環境：クロージャが作成されたときの環境への参照</li>\n</ul>\n</li>\n<li>呼び出されたとき、\n<ol>\n<li>新しい環境が作成され、その「外側の環境」はクロージャの環境になる</li>\n<li>新しい環境でクロージャの関数が評価される</li>\n</ol>\n</li>\n</ul>\n<p>環境とは、「束縛の集合」と「外側の環境への参照」のペア。</p>\n<p>束縛とは、「変数」と「値」のペア。</p>\n<h2 id=\"javascriptでは\" style=\"position:relative;\"><a href=\"#javascript%E3%81%A7%E3%81%AF\" aria-label=\"javascriptでは permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>JavaScriptでは</h2>\n<p>SICPの説明はSchemeを前提にしていました。</p>\n<p>実際のJavaScriptの挙動を確かめるために、<a href=\"https://tc39.es/ecma262/\">ECMAScript</a>を雰囲気で読んでみましょう。</p>\n<h3 id=\"クロージャの作成アロー関数の評価\" style=\"position:relative;\"><a href=\"#%E3%82%AF%E3%83%AD%E3%83%BC%E3%82%B8%E3%83%A3%E3%81%AE%E4%BD%9C%E6%88%90%E3%82%A2%E3%83%AD%E3%83%BC%E9%96%A2%E6%95%B0%E3%81%AE%E8%A9%95%E4%BE%A1\" aria-label=\"クロージャの作成アロー関数の評価 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>クロージャの作成（アロー関数の評価）</h3>\n<p>アロー関数についての章立ては以下のようになっています。</p>\n<ul>\n<li>15.3 Arrow Function Definitions\n<ul>\n<li>15.3.1 SS: Early Errors</li>\n<li>15.3.2 SS: ConciseBodyContainsUseStrict</li>\n<li>15.3.3 RS: EvaluateConciseBody</li>\n<li>15.3.4 RS: InstantiateArrowFunctionExpression</li>\n<li>15.3.5 RS: Evaluation</li>\n</ul>\n</li>\n</ul>\n<p>SSとRSは、それぞれStatic SemanticsとRuntime Semanticsのことみたいです。</p>\n<p>Static Semanticsには、プログラムを動かす前にわかるようなことが定義されています。例えば、非同期のアロー関数でないのに<code class=\"language-text\">await</code>が現れるなら文法エラー、などです。</p>\n<p>今回は、プログラム実行時の評価の挙動に興味があるので、<a href=\"https://tc39.es/ecma262/#sec-arrow-function-definitions-runtime-semantics-evaluation\">15.3.5 Runtime Semantics: Evaluation</a>から見ていくと良さそうですね。</p>\n<p>以下、今回関心のある部分のみ抜粋します。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># 15.3.5 Runtime Semantics: Evaluation\nArrowFunction : ArrowParameters => ConciseBody\n  1. Return InstantiateArrowFunctionExpression of ArrowFunction.\n\n# 15.3.4 Runtime Semantics: InstantiateArrowFunctionExpression\nArrowFunction : ArrowParameters => ConciseBody\n  // 現在の環境をenvとおく\n  2. Let env be the LexicalEnvironment of the running execution context.\n\n  // OrdinaryFunctionCreateを呼び出す。ここで関数（ConciseBody）と環境（env）を渡している\n  // その結果をclosureとおく\n  5. Let closure be OrdinaryFunctionCreate(%Function.prototype%, sourceText, ArrowParameters, ConciseBody, LEXICAL-THIS, env, privateEnv).\n\n  // closureを返す\n  7. Return closure.\n\n# 10.2.3 OrdinaryFunctionCreate ( functionPrototype, sourceText, ParameterList, Body, thisMode, env, privateEnv )\n  // 新規オブジェクト作成し、Fとおく\n  2. Let F be OrdinaryObjectCreate(functionPrototype, internalSlotsList).\n\n  // Fに関数のBodyをセットする\n  6. Set F.[[ECMAScriptCode]] to Body.\n\n  // Fに現在の環境をセットする\n  13. Set F.[[Environment]] to env.\n\n  // Fを返す（アロー関数の評価結果となる）\n  23. Return F.</code></pre></div>\n<p>おー、やってますね〜。</p>\n<p>アロー関数の評価時にオブジェクトを作成し、関数（<code class=\"language-text\">F.[[ECMAScriptCode]]</code>）と環境（<code class=\"language-text\">F.[[Environment]]</code>）を内部スロットにセットしていそうです。</p>\n<p>念のため、それぞれの内部スロットの説明を詳しく見てみます。</p>\n<blockquote>\n<ul>\n<li>[[ECMAScriptCode]]\n<ul>\n<li>Type：a Parse Node</li>\n<li>説明：関数のBodyを定義するソース・テキストのルート解析ノード。</li>\n</ul>\n</li>\n<li>[[Environment]]\n<ul>\n<li>Type：an Environment Record</li>\n<li>説明：関数が閉包されたEnvironment Record。関数のコードを評価する際の外部環境として使用されます。</li>\n</ul>\n</li>\n</ul>\n<p>出典：<a href=\"https://tc39.es/ecma262/#sec-ecmascript-function-objects\">10.2 ECMAScript Function Objects, ECMAScript</a>、ただし、表をリストに筆者が改変した。また翻訳はDeepLのものを筆者が修正したもの</p>\n</blockquote>\n<p>思ってたとおりですね。</p>\n<p>また、<code class=\"language-text\">F.[[Environment]]</code>の中身である、Environment Recordについては……</p>\n<blockquote>\n<p>Environment Recordは、（中略）識別子と特定の変数および関数との関連付けを定義するために使用される仕様タイプです。通常、（中略）FunctionDeclarationやBlockStatement、TryStatementのCatch節など（中略）が評価されるたびに、そのコードによって作成される識別子の束縛を記録する新しいEnvironment Recordが作成されます。</p>\n<p>すべてのEnvironment Recordには、[[OuterEnv]]フィールドがあり、これは NULL または外部のEnvironment Recordへの参照です。</p>\n<p>出典：<a href=\"https://tc39.es/ecma262/#sec-environment-records\">9.1 Environment Records, ECMAScript</a>、翻訳はDeepLのものを筆者が改変したもの</p>\n</blockquote>\n<p>SICPの説明で聞いたようなことが書かれてます。よしよし。</p>\n<p>ちなみに、<code class=\"language-text\">OrdinaryFunctionCreate</code>はアロー関数だけではなく、</p>\n<ul>\n<li><code class=\"language-text\">function</code>による（非同期）関数の評価</li>\n<li>（非同期）メソッドの評価</li>\n<li>getter / setterの評価</li>\n<li>（非同期）ジェネレータの評価</li>\n</ul>\n<p>でも使用されているようでした。</p>\n<p>しがたって、今回のサンプルプログラムではアロー関数を使用しましたが、他の書き方でもクロージャが生成されるのは変わらないということです。</p>\n<p>「JavaScriptのほとんど（あるいはすべて？）の関数はクロージャ」と言われる理由がわかります。</p>\n<h3 id=\"クロージャの呼び出し関数呼び出しの評価\" style=\"position:relative;\"><a href=\"#%E3%82%AF%E3%83%AD%E3%83%BC%E3%82%B8%E3%83%A3%E3%81%AE%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E9%96%A2%E6%95%B0%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E3%81%AE%E8%A9%95%E4%BE%A1\" aria-label=\"クロージャの呼び出し関数呼び出しの評価 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>クロージャの呼び出し（関数呼び出しの評価）</h3>\n<p>関数呼び出しの評価は、<a href=\"https://tc39.es/ecma262/#sec-function-calls-runtime-semantics-evaluation\">13.3.6.1 Runtime Semantics: Evaluation</a>から見ていくと良さそうです。</p>\n<p>以下、今回関心のある部分のみ抜粋します。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># 13.3.6.1 Runtime Semantics: Evaluation\nCallExpression : CallExpression Arguments\n  5. Return ? EvaluateCall(func, ref, Arguments, tailCall).\n\n# 13.3.6.2 EvaluateCall ( func, ref, arguments, tailPosition )\n  7. Return ? Call(func, thisValue, argList).\n\n# 7.3.14 Call ( F, V [ , argumentsList ] )\n  3. Return ? F.[[Call]](V, argumentsList).\n\n# 10.2.1 [[Call]] ( thisArgument, argumentsList )\n  2. Let calleeContext be PrepareForOrdinaryCall(F, undefined).\n\n# 10.2.1.1 PrepareForOrdinaryCall ( F, newTarget )\n  7. Let localEnv be NewFunctionEnvironment(F, newTarget).\n\n# 9.1.2.4 NewFunctionEnvironment ( F, newTarget )\n  // 束縛のない新しいEnvironment Recordを作成し、envとおく\n  1. Let env be a new Function Environment Record containing no bindings.\n\n  // envの外側の環境をクロージャの環境にする\n  6. Set env.[[OuterEnv]] to F.[[Environment]].</code></pre></div>\n<p>というわけで、クロージャの呼び出し時に、その環境を外側の環境とする新しい環境を作成していそうだとわかります。</p>\n<h3 id=\"javascriptまとめ\" style=\"position:relative;\"><a href=\"#javascript%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"javascriptまとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>JavaScriptまとめ</h3>\n<p>アロー関数の評価結果は関数オブジェクトでした。これは関数（<code class=\"language-text\">[[ECMAScriptCode]]</code>）と環境（<code class=\"language-text\">[[Environment]]</code>）を持っているためクロージャです。</p>\n<p><code class=\"language-text\">[[Environment]]</code>の中身であるEnvironment Recordは、束縛の集合と、外側の環境への参照（<code class=\"language-text\">[[OuterEnv]]</code>）を持ちます。これは環境に相当します。</p>\n<h2 id=\"v8では\" style=\"position:relative;\"><a href=\"#v8%E3%81%A7%E3%81%AF\" aria-label=\"v8では permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>V8では</h2>\n<p>最後に、実際のJSエンジン内部でクロージャがどのように実現されているか、ふんわり眺めてみましょう。</p>\n<h3 id=\"バイトコードを見てみる\" style=\"position:relative;\"><a href=\"#%E3%83%90%E3%82%A4%E3%83%88%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E8%A6%8B%E3%81%A6%E3%81%BF%E3%82%8B\" aria-label=\"バイトコードを見てみる permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>バイトコードを見てみる</h3>\n<p>はじめに、<code class=\"language-text\">makeCounter</code>のバイトコードを見てみます。<a href=\"https://v8.dev/docs/ignition\">バイトコードおよびインタプリタについての説明</a>は公式サイトに譲ります。ここでは、「V8がソースコードから生成したやることリスト」くらいの認識で行きましょう。</p>\n<p>ともかく、<code class=\"language-text\">--print-bytecode</code>オプションを使用してみます。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">node</span> <span class=\"token parameter variable\">-v</span>\nv18.3.0\n\n$ <span class=\"token function\">node</span> --print-bytecode --print-bytecode-filter<span class=\"token operator\">=</span>makeCounter sample.js\n<span class=\"token punctuation\">..</span>.\n   <span class=\"token number\">20</span> E<span class=\"token operator\">></span> 0x1c7f8fca6c8 @    <span class=\"token number\">0</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">83</span> 00 01          CreateFunctionContext <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>, <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n         0x1c7f8fca6cb @    <span class=\"token number\">3</span> <span class=\"token builtin class-name\">:</span> 1a fa             PushContext r0\n<span class=\"token punctuation\">..</span>.\n   <span class=\"token number\">40</span> S<span class=\"token operator\">></span> 0x1c7f8fca6d0 @    <span class=\"token number\">8</span> <span class=\"token builtin class-name\">:</span> 0c                LdaZero\n   <span class=\"token number\">40</span> E<span class=\"token operator\">></span> 0x1c7f8fca6d1 @    <span class=\"token number\">9</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">25</span> 02             StaCurrentContextSlot <span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span>\n   <span class=\"token number\">45</span> S<span class=\"token operator\">></span> 0x1c7f8fca6d3 @   <span class=\"token number\">11</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">80</span> 01 00 02       CreateClosure <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>, <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>, <span class=\"token comment\">#2</span>\n   <span class=\"token number\">91</span> S<span class=\"token operator\">></span> 0x1c7f8fca6d7 @   <span class=\"token number\">15</span> <span class=\"token builtin class-name\">:</span> a9                Return\n<span class=\"token punctuation\">..</span>.</code></pre></div>\n<p>ふむり。</p>\n<p>まず、<code class=\"language-text\">CreateFunctionContext</code>が気になります。<code class=\"language-text\">makeCounter</code>の呼び出し時に毎回Contextが作られるということで、これは環境やEnvironment Recordの作成に相当するものかと予想しました。</p>\n<p>その後の<code class=\"language-text\">PushContext</code>は、コードを実行する環境を新しいものに切り替えてるっぽいですね。</p>\n<p>続く<code class=\"language-text\">LdaZero</code>と<code class=\"language-text\">StaCurrentContextSlot</code>は、<code class=\"language-text\">let cnt = 0;</code>に対応してそうです。Zeroを生成して、Context（環境？）にストアしてる？</p>\n<p>残りの<code class=\"language-text\">CreateClosure</code>と<code class=\"language-text\">Return</code>はそのまんまですね。</p>\n<h3 id=\"デバッグプリントしてみる\" style=\"position:relative;\"><a href=\"#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%83%97%E3%83%AA%E3%83%B3%E3%83%88%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\" aria-label=\"デバッグプリントしてみる permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>デバッグプリントしてみる</h3>\n<p>次に、<code class=\"language-text\">--allow-natives-syntax</code>の<code class=\"language-text\">%DebugPrint</code>を使って、<code class=\"language-text\">CreateClosure</code>の結果がどのようになっているのかをデバッグプリントしてみます。</p>\n<p>サンプルコードの最後に<code class=\"language-text\">%DebugPrint(counter1);</code>を追加して、次のコマンドを実行します。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">node</span> --allow-natives-syntax sample.js\nDebugPrint: 0x2d73c590c5f9: <span class=\"token punctuation\">[</span>Function<span class=\"token punctuation\">]</span>\n - map: 0x11b664d813b9 <span class=\"token operator\">&lt;</span>Map<span class=\"token punctuation\">(</span>HOLEY_ELEMENTS<span class=\"token punctuation\">)</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>FastProperties<span class=\"token punctuation\">]</span>\n - prototype: 0x20596e7cb2e9 <span class=\"token operator\">&lt;</span>JSFunction <span class=\"token punctuation\">(</span>sfi <span class=\"token operator\">=</span> 0x358d345f99a1<span class=\"token punctuation\">)</span><span class=\"token operator\">></span>\n - elements: 0x1fd612d41329 <span class=\"token operator\">&lt;</span>FixedArray<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span>HOLEY_ELEMENTS<span class=\"token punctuation\">]</span>\n - <span class=\"token keyword\">function</span> prototype: <span class=\"token operator\">&lt;</span>no-prototype-slot<span class=\"token operator\">></span>\n<span class=\"token punctuation\">..</span>.</code></pre></div>\n<p>なるほどわからん。</p>\n<p>わからんなりに、V8のリポジトリを<code class=\"language-text\">- function prototype:</code>で全文検索してみます。</p>\n<p>すると、以下の1件だけヒットします。</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// ...</span>\n<span class=\"token keyword\">void</span> <span class=\"token class-name\">JSFunction</span><span class=\"token double-colon punctuation\">::</span><span class=\"token function\">JSFunctionPrint</span><span class=\"token punctuation\">(</span>std<span class=\"token double-colon punctuation\">::</span>ostream<span class=\"token operator\">&amp;</span> os<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  Isolate<span class=\"token operator\">*</span> isolate <span class=\"token operator\">=</span> <span class=\"token function\">GetIsolate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">JSObjectPrintHeader</span><span class=\"token punctuation\">(</span>os<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Function\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  os <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"\\n - function prototype: \"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ここにヒット</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">has_prototype_slot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token comment\">// ...</span></code></pre></div>\n<blockquote>\n<p>出典：<a href=\"https://github.com/v8/v8/blob/a619087d49b84eb2f98c7c13d5329c34eca17bde/src/diagnostics/objects-printer.cc#L1849\">v8/src/diagnostics/objects-printer.cc at a619087d49b84eb2f98c7c13d5329c34eca17bde · v8/v8</a>、補足のコメントは筆者による</p>\n</blockquote>\n<p>これは<code class=\"language-text\">JSFunction</code>をデバッグプリントするためのコードなので、<code class=\"language-text\">counter1</code>は<code class=\"language-text\">JSFunction</code>という構造で表現されているはずです。</p>\n<h3 id=\"重要そうな構造の定義を眺めてみる\" style=\"position:relative;\"><a href=\"#%E9%87%8D%E8%A6%81%E3%81%9D%E3%81%86%E3%81%AA%E6%A7%8B%E9%80%A0%E3%81%AE%E5%AE%9A%E7%BE%A9%E3%82%92%E7%9C%BA%E3%82%81%E3%81%A6%E3%81%BF%E3%82%8B\" aria-label=\"重要そうな構造の定義を眺めてみる permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>重要そうな構造の定義を眺めてみる</h3>\n<p>というわけで、<code class=\"language-text\">JSFunction</code>の定義に飛んで周辺を見てみますと、</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// JSFunction describes JavaScript functions.</span>\n<span class=\"token comment\">// 訳：JSFunctionはJavaScriptのfunctionsを表す</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">JSFunction</span> <span class=\"token operator\">:</span> <span class=\"token base-clause\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">TorqueGeneratedJSFunction</span><span class=\"token operator\">&lt;</span>\n                       <span class=\"token class-name\">JSFunction</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">JSFunctionOrBoundFunctionOrWrappedFunction</span><span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n <span class=\"token keyword\">public</span><span class=\"token operator\">:</span>\n\n  <span class=\"token comment\">// ...</span>\n\n  <span class=\"token comment\">// [context]: The context for this function.</span>\n  <span class=\"token comment\">// 訳：[context]: このfunctionのcontext</span>\n  <span class=\"token keyword\">inline</span> Tagged<span class=\"token operator\">&lt;</span>Context<span class=\"token operator\">></span> <span class=\"token function\">context</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// ...</span>\n\n  <span class=\"token comment\">// [code]: The generated code object for this function.  Executed</span>\n  <span class=\"token comment\">// when the function is invoked, e.g. foo() or new foo(). See</span>\n  <span class=\"token comment\">// [[Call]] and [[Construct]] description in ECMA-262, section</span>\n  <span class=\"token comment\">// 8.6.2, page 27.</span>\n  <span class=\"token comment\">// 訳：[code]: 生成されたこの関数のコードオブジェクト。</span>\n  <span class=\"token comment\">// foo()やnew foo()など、関数が呼び出されたときに実行される。</span>\n  <span class=\"token comment\">// ECMA-262の8.6.2（27ページ）における[[Call]]と[[Construct]]の説明を参照。</span>\n  <span class=\"token function\">DECL_ACCESSORS</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">,</span> Tagged<span class=\"token operator\">&lt;</span>Code<span class=\"token operator\">></span><span class=\"token punctuation\">)</span></code></pre></div>\n<blockquote>\n<p>出典：<a href=\"https://github.com/v8/v8/blob/a619087d49b84eb2f98c7c13d5329c34eca17bde/src/objects/js-function.h#L89\">v8/src/objects/js-function.h at a619087d49b84eb2f98c7c13d5329c34eca17bde · v8/v8</a>、コメントの翻訳はDeepLのものを筆者が改変したもの</p>\n</blockquote>\n<p>冒頭のコメントを見るに、<code class=\"language-text\">JSFunction</code>はJavaScriptの関数を表す内部表現で間違っていなさそうですね。</p>\n<p><code class=\"language-text\">[code]</code>と<code class=\"language-text\">[context]</code>というメンバは、なんとなくですが関数と環境であるように見えます。なんとなくですけど。</p>\n<p>次に<code class=\"language-text\">Context</code>の定義周辺も見てみます。</p>\n<div class=\"gatsby-highlight\" data-language=\"cpp\"><pre class=\"language-cpp\"><code class=\"language-cpp\"><span class=\"token comment\">// JSFunctions are pairs (context, function code), sometimes also called</span>\n<span class=\"token comment\">// closures.</span>\n<span class=\"token comment\">// 訳：JSFunctionsは(context, function code)のペアであり、これはクロージャとも呼ばれる。</span>\n\n<span class=\"token comment\">// [ previous       ]  A pointer to the previous context.</span>\n<span class=\"token comment\">// 訳：[ previous       ]  前のコンテキストへの参照</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Context</span> <span class=\"token operator\">:</span> <span class=\"token base-clause\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">TorqueGeneratedContext</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Context</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">HeapObject</span><span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n <span class=\"token keyword\">public</span><span class=\"token operator\">:</span>\n\n  <span class=\"token comment\">//...</span>\n\n  <span class=\"token keyword\">inline</span> Tagged<span class=\"token operator\">&lt;</span>Context<span class=\"token operator\">></span> <span class=\"token function\">previous</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">const</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>出典：<a href=\"https://github.com/v8/v8/blob/a619087d49b84eb2f98c7c13d5329c34eca17bde/src/objects/contexts.h#L396\">v8/src/objects/contexts.h at a619087d49b84eb2f98c7c13d5329c34eca17bde · v8/v8</a>、コメントの翻訳はDeepLのものを筆者が改変したもの</p>\n</blockquote>\n<p>さきほど、<code class=\"language-text\">Context</code>は環境に相当するものだと予想していましたが、冒頭のコメントを見る限り正解っぽいです。ﾖｯｼｬ</p>\n<p><code class=\"language-text\">previous</code>というメンバには他の環境への参照が入ると書かれています。明示的に書かれていませんが、外側の環境への参照ですかね？</p>\n<h3 id=\"より詳しくデバッグプリントしてみる\" style=\"position:relative;\"><a href=\"#%E3%82%88%E3%82%8A%E8%A9%B3%E3%81%97%E3%81%8F%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%83%97%E3%83%AA%E3%83%B3%E3%83%88%E3%81%97%E3%81%A6%E3%81%BF%E3%82%8B\" aria-label=\"より詳しくデバッグプリントしてみる permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>より詳しくデバッグプリントしてみる</h3>\n<p>先程の<code class=\"language-text\">JSFunctionPrint</code>は<code class=\"language-text\">context</code>の内容を詳しく表示してくれないようでした。</p>\n<p>おもむろに<code class=\"language-text\">objects-printer.cc</code>を散歩していたところ、<code class=\"language-text\">ContextPrint</code>という、いかにも<code class=\"language-text\">context</code>を良い感じに表示してくれそうな処理を見つけました。</p>\n<p>というわけで、<code class=\"language-text\">JSFunctionPrint</code>を改造して、<code class=\"language-text\">context</code>とその<code class=\"language-text\">previous</code>に関する詳しい情報を表示するようにしてみます。</p>\n<details>\n<summary>V8のビルド環境を構築します</summary>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token builtin class-name\">cd</span> <span class=\"token environment constant\">$HOME</span>\n<span class=\"token function\">mkdir</span> ws <span class=\"token comment\"># ワークスペースを作成</span>\n<span class=\"token builtin class-name\">cd</span> ws\n\n<span class=\"token function\">git</span> clone https://chromium.googlesource.com/chromium/tools/depot_tools.git <span class=\"token parameter variable\">--depth</span> <span class=\"token number\">1</span>\n<span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token environment constant\">$PATH</span>:<span class=\"token environment constant\">$HOME</span>/ws/depot_tools/\"</span>\n\nfetch v8\n<span class=\"token builtin class-name\">cd</span> v8\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> instal ccache</code></pre></div>\n<p>ccacheを導入するために以下のように変更します。</p>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre class=\"language-diff\"><code class=\"language-diff\">diff --git a/.gn b/.gn\nindex 3a73ff4e2a1..572d1e3caf6 100644\n<span class=\"token coord\">--- a/.gn</span>\n<span class=\"token coord\">+++ b/.gn</span>\n@@ -27,6 +27,7 @@ no_check_targets = [\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>default_args = {\n<span class=\"token prefix unchanged\"> </span>  # Disable rust dependencies.\n<span class=\"token prefix unchanged\"> </span>  enable_rust = false\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>  cc_wrapper = \"ccache\"\n</span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>}\n</span>\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span># These are the list of GN files that run exec_script. This whitelist exists</span></code></pre></div>\n</details>\n<p>以下のようにコードを変更します。</p>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre class=\"language-diff\"><code class=\"language-diff\">diff --git a/src/diagnostics/objects-printer.cc b/src/diagnostics/objects-printer.cc\nindex 51c4d991d17..3d9c03d64a7 100644\n<span class=\"token coord\">--- a/src/diagnostics/objects-printer.cc</span>\n<span class=\"token coord\">+++ b/src/diagnostics/objects-printer.cc</span>\n@@ -1905,6 +1905,12 @@ void JSFunction::JSFunctionPrint(std::ostream&amp; os) {\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>  } else {\n<span class=\"token prefix unchanged\"> </span>    os &lt;&lt; \"not available\\n\";\n<span class=\"token prefix unchanged\"> </span>  }\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>\n<span class=\"token prefix inserted\">+</span>  os &lt;&lt; \"\\n--- context ---\\n\";\n<span class=\"token prefix inserted\">+</span>  context()->ContextPrint(os);\n<span class=\"token prefix inserted\">+</span>\n<span class=\"token prefix inserted\">+</span>  os &lt;&lt; \"\\n--- previous context ---\\n\";\n<span class=\"token prefix inserted\">+</span>  context()->previous()->ContextPrint(os);\n</span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>}\n</span>\n<span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>void SharedFunctionInfo::PrintSourceCode(std::ostream&amp; os) {</span></code></pre></div>\n<p>サンプルコードの最後に<code class=\"language-text\">%DebugPrint(counter2);</code>も追加します。</p>\n<p>V8をビルドし、改造したデバッグプリントを実行した結果が以下です。ただし関心のない部分を省略しています。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ ./tools/dev/gm.py x64.release <span class=\"token operator\">&amp;&amp;</span> ./out/x64.release/d8 --allow-natives-syntax <span class=\"token punctuation\">..</span>/sample.js\n\n<span class=\"token comment\"># counter1 (0x3b160004aa55) のデバッグプリント</span>\nDebugPrint: 0x3b160004aa55: <span class=\"token punctuation\">[</span>Function<span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\"># counter1のcontext</span>\n--- context ---\n0x10580004aa4d: <span class=\"token punctuation\">[</span>Context<span class=\"token punctuation\">]</span>\n - elements:\n           <span class=\"token number\">0</span>: 0x3b160019a04d <span class=\"token operator\">&lt;</span>ScopeInfo FUNCTION_SCOPE<span class=\"token operator\">></span>\n           <span class=\"token number\">1</span>: 0x3b160019a031 <span class=\"token operator\">&lt;</span>ScriptContext<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span>\n           <span class=\"token number\">2</span>: <span class=\"token number\">2</span> <span class=\"token comment\"># cntの値</span>\n\n<span class=\"token comment\"># counter1のcontextのprevious</span>\n--- previous context ---\n0x3b160019a031: <span class=\"token punctuation\">[</span>Context<span class=\"token punctuation\">]</span> <span class=\"token keyword\">in</span> OldSpace\n - elements:\n           <span class=\"token number\">0</span>: 0x3b1600199eb1 <span class=\"token operator\">&lt;</span>ScopeInfo SCRIPT_SCOPE<span class=\"token operator\">></span>\n           <span class=\"token number\">1</span>: 0x3b1600183c79 <span class=\"token operator\">&lt;</span>NativeContext<span class=\"token punctuation\">[</span><span class=\"token number\">284</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span>\n           <span class=\"token number\">2</span>: 0x3b160004aa19 <span class=\"token operator\">&lt;</span>JSFunction makeCounter <span class=\"token punctuation\">(</span>sfi <span class=\"token operator\">=</span> 0x3b1600199ee9<span class=\"token punctuation\">)</span><span class=\"token operator\">></span>\n           <span class=\"token number\">3</span>: 0x3b160004aa55 <span class=\"token operator\">&lt;</span>JSFunction <span class=\"token punctuation\">(</span>sfi <span class=\"token operator\">=</span> 0x3b160019a07d<span class=\"token punctuation\">)</span><span class=\"token operator\">></span> <span class=\"token comment\"># counter1</span>\n           <span class=\"token number\">4</span>: 0x3b160004aa85 <span class=\"token operator\">&lt;</span>JSFunction <span class=\"token punctuation\">(</span>sfi <span class=\"token operator\">=</span> 0x3b160019a07d<span class=\"token punctuation\">)</span><span class=\"token operator\">></span> <span class=\"token comment\"># counter2</span>\n\n<span class=\"token comment\"># counter2 (0x3b160004aa85) のデバッグプリント</span>\nDebugPrint: 0x3b160004aa85: <span class=\"token punctuation\">[</span>Function<span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\"># counter2のcontext</span>\n--- context ---\n0x3b160004aa71: <span class=\"token punctuation\">[</span>Context<span class=\"token punctuation\">]</span>\n - elements:\n           <span class=\"token number\">0</span>: 0x3b160019a04d <span class=\"token operator\">&lt;</span>ScopeInfo FUNCTION_SCOPE<span class=\"token operator\">></span>\n           <span class=\"token number\">1</span>: 0x3b160019a031 <span class=\"token operator\">&lt;</span>ScriptContext<span class=\"token punctuation\">[</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span>\n           <span class=\"token number\">2</span>: <span class=\"token number\">1</span> <span class=\"token comment\"># cntの値</span>\n\n<span class=\"token comment\"># counter2のcontextのprevious</span>\n--- previous context ---\n0x3b160019a031: <span class=\"token punctuation\">[</span>Context<span class=\"token punctuation\">]</span> <span class=\"token keyword\">in</span> OldSpace\n - elements:\n           <span class=\"token number\">0</span>: 0x3b1600199eb1 <span class=\"token operator\">&lt;</span>ScopeInfo SCRIPT_SCOPE<span class=\"token operator\">></span>\n           <span class=\"token number\">1</span>: 0x3b1600183c79 <span class=\"token operator\">&lt;</span>NativeContext<span class=\"token punctuation\">[</span><span class=\"token number\">284</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span>\n           <span class=\"token number\">2</span>: 0x3b160004aa19 <span class=\"token operator\">&lt;</span>JSFunction makeCounter <span class=\"token punctuation\">(</span>sfi <span class=\"token operator\">=</span> 0x3b1600199ee9<span class=\"token punctuation\">)</span><span class=\"token operator\">></span>\n           <span class=\"token number\">3</span>: 0x3b160004aa55 <span class=\"token operator\">&lt;</span>JSFunction <span class=\"token punctuation\">(</span>sfi <span class=\"token operator\">=</span> 0x3b160019a07d<span class=\"token punctuation\">)</span><span class=\"token operator\">></span> <span class=\"token comment\"># counter1</span>\n           <span class=\"token number\">4</span>: 0x3b160004aa85 <span class=\"token operator\">&lt;</span>JSFunction <span class=\"token punctuation\">(</span>sfi <span class=\"token operator\">=</span> 0x3b160019a07d<span class=\"token punctuation\">)</span><span class=\"token operator\">></span> <span class=\"token comment\"># counter2</span></code></pre></div>\n<p>まず、<code class=\"language-text\">counter1</code>の<code class=\"language-text\">context</code>を見てみましょう。<code class=\"language-text\">elements</code>に着目すると<code class=\"language-text\">2</code>が表示されています。同様に<code class=\"language-text\">counter2</code>の方は<code class=\"language-text\">1</code>が表示されていることから、これらは束縛された<code class=\"language-text\">cnt</code>の値であるようです。</p>\n<p>次に、<code class=\"language-text\">counter1</code>と<code class=\"language-text\">counter2</code>それぞれの<code class=\"language-text\">context</code>の<code class=\"language-text\">previous</code>を見てみます。すると、どちらも同じ内容が表示されているとわかります。それぞれの<code class=\"language-text\">elements</code>には、<code class=\"language-text\">makeCounter</code>の他に2つの<code class=\"language-text\">JSFunction</code>の束縛が表示されており、これらは<code class=\"language-text\">counter1</code>と<code class=\"language-text\">counter2</code>にアドレスが一致します。したがって、これらの<code class=\"language-text\">context</code>はグローバル環境に相当するもののようですね。</p>\n<p>全体的に、例の図と似た構造があるのを確認できました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 728px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f014a272088de35b9eed7beed0b3054f/d5a17/env9.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 82.28021978021978%; position: relative; bottom: 0; left: 0; background-image: url('data:image/svg+xml,%3csvg%20xmlns=\\'http://www.w3.org/2000/svg\\'%20width=\\'400\\'%20height=\\'329\\'%20viewBox=\\'0%200%20400%20329\\'%20preserveAspectRatio=\\'none\\'%3e%3cpath%20d=\\'M60%209l-2%202%202%203%202%202-2%203-2%202%202%203%203%202%202-2%202-3%203%202%203%203%202-3%203-3-2-2-3-2%203-3%202-3-2-2-3-2-2%202-3%202-2-2c-3-3-3-3-6%201m129%2014v8h203V16H189v7m-16-4l-7%201h-8v24h-16v8c0%208%200%208-2%208-6-2-7-2-7-1%201%201%200%201-2%201s-3-1-3-2l-1-2v2c0%202-1%202-3%202h-4v32h-5l-6-1c-1-2-5-1-5%201-1%202%202%205%204%203l7-1c7%200%207%200%207-18V62h5v32c0%2019%201%2025%201%2015V92h2a564%20564%200%20017%201l65-1h64v18h-12c-6%200-1%201%2013%201%2015%200%2020-1%2012-1h-11l-1-10V90h-74V78h16V44h-49V22h6l7%201%205-1%204-1-3-2h-6M66%2032v4l1%205v4H44a263%20263%200%200024%202%20841%20841%200%200024-2H69v-4l1-5c1-1-1-8-2-8l-2%204m77%2028v16h31l1-15V46l-16-1h-16v15m34%200v16h31V45h-31v15m-39%203h-4l-3-1h-3v14c0%2015%200%2015%206%2013h3l28%201h27V78h-49l-1-9v-8l-4%202m195%2030v7l-10%201-9%201-1%2018v19h-4l-4-1c0-2%200-2-4%200l-5%201v-11c0-9%200-12-2-14v1a240%20240%200%20012%2037v-12l4%202h5l4-1h5v12h9l10%201v7c0%2011-1%2011%2029%2011%2023%200%2028-1%2028-3h-2c-4%203-49%203-52%200-3-2-3-30%200-33v-2c-2%200-3%203-3%2010v8h-18v-49h18v8l1-9V86l-1%207M76%20107c-1%203%203%206%205%203l16-1h16v27H79v-5l1-6c2-2%201-5-2-5-2%200-4%203-2%204l1%207v5H19l24%201h24v2a562%20562%200%2001-1%207l1%2040v40h10v19l1%2019h32a236%20236%200%200138%201l4-2v16h8l8%201v31h4l4%201h7l3-2-3-1c-6-2-7-2-7-1%200%202-1%202-3%202h-3v-30l24-1h25v-15h4l5%201h5l4-2v11a319%20319%200%20010-23c0%2011%200%2011-2%2011-5-2-7-2-7-1l-4%201h-5v-16h-67v8c0%209%201%208-7%206l-2%201-32%201H79v-36h187v7h-12c-6%200-1%201%2013%201%2015%200%2020-1%2012-1h-11l-1-5v-4H79v-87h17c16%200%2017%200%2017%202%201%202%202%202%2015%202l15%201h4l5-2v16h8l8%201v31h4l4%201h6l4-2-3-1c-6-2-7-2-7-1l-3%201h-3v-29l24-1h25v-15h5l4%201h5l4-2v11a319%20319%200%20010-23c0%2010%200%2011-2%2011-4-2-7-2-7-1l-4%201h-5v-16h-67v8c0%208%200%208-2%208-5-2-7-2-7-1l-14%201c-14%200-16-1-12-3l3-1h-3c-2%201-2%201-2-13v-14l-17-1-17-1c-2-1-4-1-5%201m77%2033v15h31v-31h-31v16m33%200v15h32v-31h-32v16m-117-2l1%205v3l-1%2039v39h9l-1-43v-44h-4l-4%201m123%2052v8h5l6-1h1l20%201%2019-1h2a1129%201129%200%2000106%201h6v-16H192v8m102%2048a240%20240%200%20012%2037v-12l4%202h5l5-1h5v-10h19v-17l-1%208v7h-10l-9%201-1%204v5h-4l-4-1c0-1-2-1-7%201-2%200-2%200-2-11%200-9%200-12-2-14v1m-141%2024v16h31v-31h-31v15m34-14l-1%2015v15h32v-31h-15l-16%201m5%2065v8h5l6-1h1l20%201%2019-1h2l49%201a498%20498%200%200057%200h6v-16H192v8\\'%20fill=\\'%23d3d3d3\\'%20fill-rule=\\'evenodd\\'/%3e%3c/svg%3e'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/f014a272088de35b9eed7beed0b3054f/f4a91/env9.webp 728w,\n/static/f014a272088de35b9eed7beed0b3054f/e7b49/env9.webp 946w\"\n              sizes=\"(max-width: 728px) 100vw, 728px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/f014a272088de35b9eed7beed0b3054f/beb58/env9.png 728w,\n/static/f014a272088de35b9eed7beed0b3054f/d5a17/env9.png 946w\"\n            sizes=\"(max-width: 728px) 100vw, 728px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/f014a272088de35b9eed7beed0b3054f/beb58/env9.png\"\n            alt=\"最終的に、すべてのサンプルプログラムの実行が終わった時点の環境の図。詳細はSICPの説明の章を参照。\"\n            title=\"最終的に、すべてのサンプルプログラムの実行が終わった時点の環境の図。詳細はSICPの説明の章を参照。\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h3 id=\"v8まとめ\" style=\"position:relative;\"><a href=\"#v8%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"v8まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>V8まとめ</h3>\n<p>アロー関数の評価結果は<code class=\"language-text\">JSFunction</code>でした。これは関数（<code class=\"language-text\">[code]</code>）と環境（<code class=\"language-text\">[context]</code>）を持つためクロージャです。</p>\n<p><code class=\"language-text\">context</code>は束縛の集合（<code class=\"language-text\">elements</code>）と、外側の環境への参照（<code class=\"language-text\">previous</code>）を持っているため、環境に相当します。</p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>SICP、ECMAScript、V8を調べることで、それぞれにクロージャ、環境、束縛に相当する構造があることを確認しました。</p>\n<p>そもそもの発端は、<a href=\"https://blog.recruit.co.jp/rtc/2023/08/10/recruit-bootcamp-2023/\">会社の新人向けJavaScript研修</a>にサポート講師として参加した際、新人の方からの「クロージャとは何ですか？」という質問に、僕がうまく回答できなかったことでした。</p>\n<p>こういう素朴な疑問が、理解を深めるきっかけになったのは良かったです。研修というのは、新人だけでなく講師の知見を広げる場でもあるんだなぁと感じました。</p>\n<p>今回のことについてもっと知りたいなら、SICPの4章がおすすめです。環境モデルを含めたメタ循環評価器（ある言語で実装された、その言語自身の評価器）を作ることで理解が深まりますし、非決定性計算や論理プログラミングといった馴染みのないパラダイムに対して、環境モデルがどのように適用されるかというのは、むずかしいですが興味深いと感じました。</p>\n<p>JavaScriptのクロージャ周りで困った際には、ぜひ環境の図を描いてみてください。</p>\n<p>ありがとうございました。</p>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\">また、本記事の後半の説明に合わせて、一部の概念を統合したり、言い換えたりしています。<a href=\"#fnref-1\" class=\"footnote-backref\">↩</a></li>\n</ol>\n</div>","frontmatter":{"title":"「クロージャは関数と環境のペア」とは？（JavaScript）","date":"2023/12/02"},"fields":{"slug":"/「クロージャは関数と環境のペア」とは？（JavaScript）/"},"id":"3d71b3f9-8d6b-58a4-b6cb-8293daf99d74"},"firstImage":{"imageFile":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#f8f8f8","images":{"fallback":{"src":"/static/566007376866e5cae189b6c99d0e61f1/9b7f3/top.png","srcSet":"/static/566007376866e5cae189b6c99d0e61f1/e82f0/top.png 163w,\n/static/566007376866e5cae189b6c99d0e61f1/7230e/top.png 326w,\n/static/566007376866e5cae189b6c99d0e61f1/9b7f3/top.png 651w","sizes":"(min-width: 651px) 651px, 100vw"},"sources":[{"srcSet":"/static/566007376866e5cae189b6c99d0e61f1/f5d5d/top.webp 163w,\n/static/566007376866e5cae189b6c99d0e61f1/9696a/top.webp 326w,\n/static/566007376866e5cae189b6c99d0e61f1/4628f/top.webp 651w","type":"image/webp","sizes":"(min-width: 651px) 651px, 100vw"}]},"width":651,"height":418}}}},"relatedMarkdownRemarks":{"posts":[{"id":"fc7ce496-d3b3-5f39-a04e-8e2dfb960626","frontmatter":{"draft":null}},{"id":"5dba01b8-593d-5295-b135-16df1c6295e5","frontmatter":{"draft":null}},{"id":"84bf9a79-dd68-55d1-a1b3-60ffd3784554","frontmatter":{"draft":null}},{"id":"9f02de74-61a0-5daf-a048-1c1022e08fe4","frontmatter":{"draft":null}},{"id":"3c14921d-1ba3-5a7a-93a2-757f3a03ee3a","frontmatter":{"draft":null}},{"id":"89ddbcc0-ed71-5a69-9d55-9677eab3e6cf","frontmatter":{"draft":null}},{"id":"73ab4455-f04d-5320-bf3a-90b9f7441d13","frontmatter":{"draft":null}},{"id":"a091877c-69b8-59f9-8963-1af334fd573c","frontmatter":{"draft":null}},{"id":"29b79017-f96d-5b04-8d01-5b8ee761ebed","frontmatter":{"draft":null}},{"id":"1162dccb-e1bf-576d-a5c6-0993394feb0a","frontmatter":{"draft":true}},{"id":"f920a8a8-f5fe-57c9-8792-95c93d2b74eb","frontmatter":{"draft":null}},{"id":"27f10a38-0ecb-539f-a717-7e40a41bbd10","frontmatter":{"draft":null}},{"id":"c2db052c-95c6-5094-935b-9eb39f5c762a","frontmatter":{"draft":null}},{"id":"75696ec6-74a3-5046-8a3c-f39b36d92311","frontmatter":{"draft":null}},{"id":"1509de3c-7308-5e40-a885-f5ebdb089774","frontmatter":{"draft":null}},{"id":"3a3c4125-9986-53bb-8b96-ae29936c96ab","frontmatter":{"draft":null}},{"id":"ed7af7f9-75f5-59be-9063-de564576eed7","frontmatter":{"draft":true}},{"id":"c5e2431a-cf05-5024-b833-e1c69f680d44","frontmatter":{"draft":null}},{"id":"d29b4513-0609-5cfc-af49-817467dbed1f","frontmatter":{"draft":null}},{"id":"0116f663-28d1-507a-b5ab-b189801dd408","frontmatter":{"draft":true}},{"id":"82d43655-ea2a-52cd-97a3-16b7b28ad150","frontmatter":{"draft":null}},{"id":"01deffb8-0d62-54c6-9e41-20832cbc3c6e","frontmatter":{"draft":null}},{"id":"067a602f-4581-5707-b896-73190dd8c889","frontmatter":{"draft":null}},{"id":"0c5568c9-6d87-56ed-ab0e-caeb9c1aafa4","frontmatter":{"draft":null}},{"id":"1086a735-7173-58cc-a813-c540a563aedf","frontmatter":{"draft":false}},{"id":"12222bfa-2e8e-51ee-99d8-8a19902351f5","frontmatter":{"draft":null}},{"id":"2cfd9e33-b4e1-53e4-884d-d8a6760f3387","frontmatter":{"draft":true}},{"id":"2f30c3f1-0d66-590b-8dba-7836df701d46","frontmatter":{"draft":null}},{"id":"3908aafc-c8d3-5c67-821f-0866592449f2","frontmatter":{"draft":true}},{"id":"3b696b96-130d-50de-a673-dc1367f32387","frontmatter":{"draft":null}},{"id":"46a22c41-5455-557c-85d4-973a6e2220ee","frontmatter":{"draft":null}},{"id":"48c65a15-67ca-57d0-9edc-ebcb868f7ad2","frontmatter":{"draft":true}},{"id":"49cf25c1-03f6-575e-8c2f-638ccd6198ea","frontmatter":{"draft":null}},{"id":"4d43646f-8aa6-52b6-b0b6-5160f0be2b05","frontmatter":{"draft":null}},{"id":"4ed3b747-2001-54f4-9661-3acab89ce275","frontmatter":{"draft":null}},{"id":"4edc1b46-b395-5783-af6a-818b8fc9c2dc","frontmatter":{"draft":null}},{"id":"50951bb1-eb92-5663-a3d8-8f35f73a1322","frontmatter":{"draft":null}},{"id":"50d3cc2a-de7a-5b9a-a8d8-754415fe4d94","frontmatter":{"draft":null}},{"id":"5888c50d-8414-5e8f-b0dc-28a31b29053d","frontmatter":{"draft":null}},{"id":"63f3c7ad-6c59-52b5-9816-78fd348955ff","frontmatter":{"draft":true}},{"id":"69a4aa90-b728-522c-b34f-abee49825c45","frontmatter":{"draft":true}},{"id":"73d6ab42-b3e6-5663-a175-b1f3d69c29e1","frontmatter":{"draft":null}},{"id":"75550af2-8134-5467-a07d-abbb5a4f6b7c","frontmatter":{"draft":true}},{"id":"7778d041-a5bf-536a-a36f-c0dbc5e08ac7","frontmatter":{"draft":true}},{"id":"78349b16-6e41-5fef-ae38-bcdc5ff297ef","frontmatter":{"draft":true}},{"id":"7a8fc278-a847-5b68-8b74-a83193ba3f55","frontmatter":{"draft":null}},{"id":"7d6499d9-277c-5f07-b8b1-98ae40c50c42","frontmatter":{"draft":null}},{"id":"7d79eb4b-cd4a-5621-a67a-91d9a24dce05","frontmatter":{"draft":null}},{"id":"871ac696-39ea-5c64-94f3-5dc4b73b5770","frontmatter":{"draft":true}},{"id":"8b3e46c2-1a1e-5af0-8900-7972c7285d15","frontmatter":{"draft":null}},{"id":"8f7b1b24-7738-5b97-bfb6-fd763f11a664","frontmatter":{"draft":true}},{"id":"961ec1e6-3f2b-59d9-a33f-dad76cf67f47","frontmatter":{"draft":null}},{"id":"97f01467-e3a1-58e1-b2a4-db77354cc1a3","frontmatter":{"draft":null}},{"id":"9f24363b-ee3e-54bf-8a18-46ea3b269bea","frontmatter":{"draft":null}},{"id":"a190aac4-0483-5e02-b1d3-261f3b5f313a","frontmatter":{"draft":null}},{"id":"a6c64123-b824-5224-8027-90eb12040396","frontmatter":{"draft":null}},{"id":"b4251348-b618-5b5b-a2c8-e4c6b2431b83","frontmatter":{"draft":true}},{"id":"be594923-185e-5cca-95b6-5267b3c9fc8c","frontmatter":{"draft":null}},{"id":"bfee69af-7d7f-5d87-9680-d2e9b60f8416","frontmatter":{"draft":null}},{"id":"c2249b7b-b97e-5cf4-8ea9-8024e96851b7","frontmatter":{"draft":true}},{"id":"c6def021-b8da-5dbe-ad3e-811d9286424d","frontmatter":{"draft":true}},{"id":"c7a5adfb-149b-5469-ba35-7421e2101951","frontmatter":{"draft":null}},{"id":"cbdf3192-973c-5d87-9cf1-bb9110e9a169","frontmatter":{"draft":null}},{"id":"d4d1afa4-f2f9-5942-ae36-2826fb938af5","frontmatter":{"draft":null}},{"id":"db26c6b9-37b4-5cc4-b1ec-c61dc667863e","frontmatter":{"draft":null}},{"id":"dd0c41cf-0a03-5b89-b5a2-f64859aeae63","frontmatter":{"draft":null}},{"id":"e322eac2-bd89-5347-b20d-d050d303a6be","frontmatter":{"draft":null}},{"id":"e376b2d4-df91-5b82-af7a-a8d02763e922","frontmatter":{"draft":true}},{"id":"e4fb8478-b1ad-59eb-95e8-8c5e0500d3f4","frontmatter":{"draft":true}},{"id":"e83330dc-2312-5ae6-95fa-53e86909f42b","frontmatter":{"draft":true}},{"id":"eba9aa6a-6e21-5f1b-a0eb-7b6bfb1e04f1","frontmatter":{"draft":null}},{"id":"ebae7878-c4ee-505e-81e2-3d3fc47ea826","frontmatter":{"draft":true}},{"id":"f06a6ae0-e961-504c-8dab-a60489c0557a","frontmatter":{"draft":true}},{"id":"f49ce388-e81c-5425-af59-9902f125c20f","frontmatter":{"draft":null}},{"id":"f5a25ce1-67a6-51b2-9bf1-f9fbacb41ad1","frontmatter":{"draft":true}},{"id":"fd6eab68-17d3-5395-8b2b-54a6efe43ebb","frontmatter":{"draft":null}}]}},"pageContext":{"id":"3d71b3f9-8d6b-58a4-b6cb-8293daf99d74"}},"staticQueryHashes":["1530353647","2576926420","63159454"]}