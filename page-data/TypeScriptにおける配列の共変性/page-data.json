{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/TypeScriptにおける配列の共変性/","result":{"data":{"site":{"siteMetadata":{"siteUrl":"https://sititou70.github.io"}},"markdownRemark":{"excerpt":"本記事はRecruit Engineers Advent Calendar 2022の15日目です． でです． 突然ですが ここに型と型があります それぞれ，次のような値を持ちます． いま，です． という記号は2つの型のあいだに書いて，「左の型が右の型のサブタイプである」と読みます． TypeScript…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 728px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/00f23a0da5a379c700a254af121e9b07/46c41/top.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.62087912087912%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMBAgT/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIQAxAAAAGsJzixAf/EABoQAAMBAAMAAAAAAAAAAAAAAAACAwEEERL/2gAIAQEAAQUCmuV20FVRqtM3kOeuz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABwQAAEEAwEAAAAAAAAAAAAAAAEAAhAxEiEiQf/aAAgBAQAGPwI2AsmuOrEcryP/xAAbEAACAgMBAAAAAAAAAAAAAAAAAREhMUFRcf/aAAgBAQABPyHCA3BJQeQNGoX0bTma8G1qP//aAAwDAQACAAMAAAAQEM//xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAwEBPxAn/8QAFhEBAQEAAAAAAAAAAAAAAAAAEQEQ/9oACAECAQE/EKuf/8QAHRABAAICAgMAAAAAAAAAAAAAAQARIVExYUGBkf/aAAgBAQABPxC/kPVb0OfcUqjBMj5E1Btpuck2lkggEFI4p9iWA6qf/9k='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/00f23a0da5a379c700a254af121e9b07/f4a91/top.webp 728w,\n/static/00f23a0da5a379c700a254af121e9b07/d0bca/top.webp 1200w\"\n              sizes=\"(max-width: 728px) 100vw, 728px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/00f23a0da5a379c700a254af121e9b07/83881/top.jpg 728w,\n/static/00f23a0da5a379c700a254af121e9b07/46c41/top.jpg 1200w\"\n            sizes=\"(max-width: 728px) 100vw, 728px\"\n            type=\"image/jpeg\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/00f23a0da5a379c700a254af121e9b07/83881/top.jpg\"\n            alt=\"はんぺんのフリー画像\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>本記事は<a href=\"https://adventar.org/calendars/7972\">Recruit Engineers Advent Calendar 2022</a>の15日目です．</p>\n<p><code class=\"language-text\">typescript@4.9.4</code>で<code class=\"language-text\">strict: true</code>です．</p>\n<h2 id=\"突然ですが\" style=\"position:relative;\"><a href=\"#%E7%AA%81%E7%84%B6%E3%81%A7%E3%81%99%E3%81%8C\" aria-label=\"突然ですが permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>突然ですが</h2>\n<p>ここに<code class=\"language-text\">Animal</code>型と<code class=\"language-text\">Dog</code>型があります</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">Animal</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  animal<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">Dog</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  animal<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  dog<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>それぞれ，次のような値を持ちます．</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> animal<span class=\"token operator\">:</span> Animal <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  animal<span class=\"token operator\">:</span> <span class=\"token string\">\"string\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> dog<span class=\"token operator\">:</span> Dog <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  animal<span class=\"token operator\">:</span> <span class=\"token string\">\"string\"</span><span class=\"token punctuation\">,</span>\n  dog<span class=\"token operator\">:</span> <span class=\"token string\">\"string\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>いま，<code class=\"language-text\">Dog &lt;: Animal</code>です．</p>\n<p><code class=\"language-text\">&lt;:</code>という記号は2つの型のあいだに書いて，「左の型が右の型のサブタイプである」と読みます．</p>\n<p>TypeScriptの型システムは構造的なので，2つのオブジェクトがサブタイプ関係にあるには，<strong>それらに共通するプロパティについてもまた，サブタイプ関係が必要<sup id=\"fnref-1\"><a href=\"#fn-1\" class=\"footnote-ref\">1</a></sup>です</strong>．</p>\n<p>今回の例では，<code class=\"language-text\">Dog</code>と<code class=\"language-text\">Animal</code>に共通する<code class=\"language-text\">animal</code>プロパティについて<code class=\"language-text\">string &lt;: string</code>なのでOKです．</p>\n<p>TSでは，<code class=\"language-text\">S &lt;: T</code>ならば<code class=\"language-text\">T</code>型の変数に<code class=\"language-text\">S</code>型の値を代入できます．</p>\n<p>つまり，<code class=\"language-text\">Dog &lt;: Animal</code>なので <strong><code class=\"language-text\">Animal</code>型の変数に<code class=\"language-text\">Dog</code>型の値を代入できます．</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// できる</span>\n<span class=\"token keyword\">const</span> animalVariable<span class=\"token operator\">:</span> Animal <span class=\"token operator\">=</span> dog<span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"問題\" style=\"position:relative;\"><a href=\"#%E5%95%8F%E9%A1%8C\" aria-label=\"問題 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>問題</h2>\n<p>それでは，<strong><code class=\"language-text\">Animal[]</code>型の変数に<code class=\"language-text\">Dog[]</code>型の値を代入できるでしょうか？</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> dogArray<span class=\"token operator\">:</span> Dog<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>dog<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// これはできる？</span>\n<span class=\"token keyword\">const</span> animalArray<span class=\"token operator\">:</span> Animal<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> dogArray<span class=\"token punctuation\">;</span></code></pre></div>\n<p>―――――――――</p>\n<p>――――――</p>\n<p>―――</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 412px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/596992843d52a5934515185ff73dd294/5f37e/no_error.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.84466019417476%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABeklEQVR42mWS2XKCQBBFMS4B2WRxYBAVEXGXqFUmqeQhec3//89N96BUog+nmLlzey00w/bhBgmiNIftRQqH8WPYjCeU5vqkkY81J5D0Ja8vm5gbWp1QQoxmFBTjkC2wSTMkywuy6gvp6gI53aAqJtjujhDRFOPFid6+IbM17IGg4rJBMywfnkgxXx0woITncovjfInp9h3F8QtzYnb4xHR5RlUWeNuVqHYVxvkBefmC8vUHs/0HckKO59cOwwQiyepxVaVYdX0784i8llsXbjBSMQ6NXeuxunOMZjohLHcIa1Dvjs+c2KJR7ml05RcP+1M7bPdMBNEE/jBBr+/SToboGQ64UN8JauwAPElXr3WLPKx1yMfe7h80ra0jilJEImkCuIhJiRRuCN0cKFjXTQ+G5ZHXpm6ewfH/eOr2YfIevSGEnKgOvVDSwvdY70/Il3uMswIR/QVeGCOZFAjECB1KrnUMtO5QIzcPVEFxd+airY5+pb7X2mPCX55629J0hQLOAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/596992843d52a5934515185ff73dd294/8776a/no_error.webp 412w\"\n              sizes=\"(max-width: 412px) 100vw, 412px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/596992843d52a5934515185ff73dd294/5f37e/no_error.png 412w\"\n            sizes=\"(max-width: 412px) 100vw, 412px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/596992843d52a5934515185ff73dd294/5f37e/no_error.png\"\n            alt=\"animalArrayにdogArrayを代入してもエラーが表示されていない様子のスクリーンショット\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>答え：<strong>できます</strong></p>\n<p>（配列に共変性がある）</p>\n<p>―――</p>\n<p>――――――</p>\n<p>―――――――――</p>\n<h2 id=\"できて良いんだっけ\" style=\"position:relative;\"><a href=\"#%E3%81%A7%E3%81%8D%E3%81%A6%E8%89%AF%E3%81%84%E3%82%93%E3%81%A0%E3%81%A3%E3%81%91\" aria-label=\"できて良いんだっけ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>……できて良いんだっけ…？</h2>\n<p>いっしょに考えてみましょう．</p>\n<p><code class=\"language-text\">Animal[]</code>型の変数に<code class=\"language-text\">Dog[]</code>型の値を代入するためには，<code class=\"language-text\">Dog[] &lt;: Animal[]</code>が必要です．</p>\n<p>したがって，先ほどと同じように<strong>2つの配列に共通するすべてのプロパティについてもまた，サブタイプ関係が必要です．</strong></p>\n<p>配列の型は<code class=\"language-text\">lib.es5.d.ts</code>によって，以下のように定義されています．</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\"><span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/**\n   * Gets or sets the length of the array. This is a number one higher than the highest index in the array.\n   */</span>\n  length<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">/**\n   * Returns a string representation of an array.\n   */</span>\n  <span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">/**\n   * Returns a string representation of an array. The elements are converted to string using their toLocaleString methods.\n   */</span>\n  <span class=\"token function\">toLocaleString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>出典: <a href=\"https://github.com/microsoft/TypeScript/blob/main/lib/lib.es5.d.ts\">lib.es5.d.ts，TypeScript</a></p>\n</blockquote>\n<p>つまり，<code class=\"language-text\">length</code>，<code class=\"language-text\">toString</code>，<code class=\"language-text\">toLocalString</code>……すべてについてサブタイプ関係が必要です．</p>\n<p>ここでは特に<code class=\"language-text\">indexOf</code>プロパティに着目してみましょう．</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\">  <span class=\"token comment\">/**\n   * Returns the index of the first occurrence of a value in an array, or -1 if it is not present.\n   * @param searchElement The value to locate in the array.\n   * @param fromIndex The array index at which to begin the search. If fromIndex is omitted, the search starts at index 0.\n   */</span>\n  <span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>searchElement<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">,</span> fromIndex<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>出典: <a href=\"https://github.com/microsoft/TypeScript/blob/main/lib/lib.es5.d.ts\">lib.es5.d.ts，TypeScript</a></p>\n</blockquote>\n<p>ここで，</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">(searchElement: Dog, fromIndex?: number): number\n\n&lt;:\n\n(searchElement: Animal, fromIndex?: number): number</code></pre></div>\n<p>が必要なのですが，これは一般的には <strong>成り立ちません</strong></p>\n<p><strong><code class=\"language-text\">Animal</code>の入力を期待する関数</strong> を <strong><code class=\"language-text\">Dog</code>の入力を期待する関数</strong> で置き換えられないからです（反変性）</p>\n<p>以上を踏まえると，次のような意地悪ができます</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> dogArray<span class=\"token operator\">:</span> Dog<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>dog<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// dogArrayのindexOfを独自の関数に置き換える</span>\ndogArray<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">indexOf</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>dog<span class=\"token operator\">:</span> Dog<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Dog型の値を受け取り，Animal型にはないプロパティをわざと触る</span>\n  dog<span class=\"token punctuation\">.</span>dog<span class=\"token punctuation\">.</span><span class=\"token function\">charAt</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 適当に返す</span>\n  <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// 以上の置き換え自体は問題ない</span>\n<span class=\"token comment\">// dogArray.indexOfでDogの入力を期待することは正当</span>\n\n<span class=\"token comment\">// 問題はこの行．dogArrayをanimalArrayに代入できるなら……</span>\n<span class=\"token keyword\">const</span> animalArray<span class=\"token operator\">:</span> Animal<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> dogArray<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// そのあと例のindexOfにanimalを渡せてしまう</span>\nanimalArray<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>animal<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>このコードはtscによる型検査をパスします</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ npx tsc\n$ <span class=\"token comment\"># パス</span></code></pre></div>\n<p>しかし，ランタイムで落ちます</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ <span class=\"token function\">node</span> index.js\n/home/sititou70/ts-array-variant/index.js:11\n    dog.dog.charAt<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            ^\n\nTypeError: Cannot <span class=\"token builtin class-name\">read</span> properties of undefined <span class=\"token punctuation\">(</span>reading <span class=\"token string\">'charAt'</span><span class=\"token punctuation\">)</span>\n    at dogArray.indexOf <span class=\"token punctuation\">(</span>/home/sititou70/ts-array-variant/index.js:11:13<span class=\"token punctuation\">)</span>\n    at Object.<span class=\"token operator\">&lt;</span>anonymous<span class=\"token operator\">></span> <span class=\"token punctuation\">(</span>/home/sititou70/ts-array-variant/index.js:15:13<span class=\"token punctuation\">)</span>\n    at Module._compile <span class=\"token punctuation\">(</span>node:internal/modules/cjs/loader:1159:14<span class=\"token punctuation\">)</span>\n    at Module._extensions<span class=\"token punctuation\">..</span>js <span class=\"token punctuation\">(</span>node:internal/modules/cjs/loader:1213:10<span class=\"token punctuation\">)</span>\n    at Module.load <span class=\"token punctuation\">(</span>node:internal/modules/cjs/loader:1037:32<span class=\"token punctuation\">)</span>\n    at Module._load <span class=\"token punctuation\">(</span>node:internal/modules/cjs/loader:878:12<span class=\"token punctuation\">)</span>\n    at Function.executeUserEntryPoint <span class=\"token punctuation\">[</span>as runMain<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span>node:internal/modules/run_main:81:12<span class=\"token punctuation\">)</span>\n    at node:internal/main/run_main_module:23:47</code></pre></div>\n<p>このような挙動は，TypeScriptが型安全（健全）でないと言われる理由の1つです．</p>\n<p>しかし，これは<strong>わざと</strong>このような設計になっています．<a href=\"https://github.com/Microsoft/TypeScript/wiki/TypeScript-Design-Goals\">TypeScript Design Goals</a>によれば，</p>\n<blockquote>\n<p>Non-goals</p>\n<ol start=\"3\">\n<li>健全な、あるいは「証明できるほど正しい」型システムを適用する。その代わり、正しさと生産性のバランスをとること。</li>\n</ol>\n<p>出典: <a href=\"https://github.com/Microsoft/TypeScript/wiki/TypeScript-Design-Goals\">TypeScript Design Goals</a>，翻訳はDeepLによる</p>\n</blockquote>\n<p>とあります．この気持ちはよくわかります．</p>\n<h2 id=\"配列の共変性はどう実現されているか\" style=\"position:relative;\"><a href=\"#%E9%85%8D%E5%88%97%E3%81%AE%E5%85%B1%E5%A4%89%E6%80%A7%E3%81%AF%E3%81%A9%E3%81%86%E5%AE%9F%E7%8F%BE%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8B\" aria-label=\"配列の共変性はどう実現されているか permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>配列の共変性はどう実現されているか</h2>\n<p>配列が共変扱いなのはわかりました．では，それはTS自身の型システム内でどのように実現されているのでしょうか？</p>\n<h3 id=\"メソッド記法の使用\" style=\"position:relative;\"><a href=\"#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E8%A8%98%E6%B3%95%E3%81%AE%E4%BD%BF%E7%94%A8\" aria-label=\"メソッド記法の使用 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>メソッド記法の使用</h3>\n<p>まず，メソッド記法が一役買っています．</p>\n<p>説明の簡単のために，<code class=\"language-text\">indexOf</code>しかプロパティを持たない<code class=\"language-text\">MyArray</code>を作ってみます．</p>\n<p>以下の，2種類の<code class=\"language-text\">MyArray</code>をみてください</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\">MyArray1<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>elem<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">interface</span> <span class=\"token class-name\">MyArray2<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">indexOf</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>elem<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>一方はメソッド記法，他方は関数型の記法で書かれています．書き方は少し違いますが，どちらも同じようなことを書いていますね．</p>\n<p>しかし，以下のように挙動が大きく異なります．</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// これはできる</span>\n<span class=\"token keyword\">const</span> myDogArray1<span class=\"token operator\">:</span> MyArray1<span class=\"token operator\">&lt;</span>Dog<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>dog<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> myAnimalArray1<span class=\"token operator\">:</span> MyArray1<span class=\"token operator\">&lt;</span>Animal<span class=\"token operator\">></span> <span class=\"token operator\">=</span> myDogArray1<span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// これは型エラー</span>\n<span class=\"token keyword\">const</span> myDogArray2<span class=\"token operator\">:</span> MyArray2<span class=\"token operator\">&lt;</span>Dog<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>dog<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> myAnimalArray2<span class=\"token operator\">:</span> MyArray2<span class=\"token operator\">&lt;</span>Animal<span class=\"token operator\">></span> <span class=\"token operator\">=</span> myDogArray2<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//    ^^^^^^^^^^^^^^</span>\n<span class=\"token comment\">// 型 'MyArray2&lt;Dog>' を型 'MyArray2&lt;Animal>' に割り当てることはできません。</span>\n<span class=\"token comment\">//   プロパティ 'dog' は型 'Animal' にありませんが、型 'Dog' では必須です。ts(2322)</span></code></pre></div>\n<p>このように，メソッド記法では，関数型の記法に比べて<strong>引数の扱いがゆるくなります</strong>．<sup id=\"fnref-2\"><a href=\"#fn-2\" class=\"footnote-ref\">2</a></sup></p>\n<p>（恥ずかしながら，私はこの挙動を半年くらい前まで知りませんでした．そして知った当時はだいぶ驚きました）</p>\n<p>さて，思い返してみると，ライブラリの型定義は（配列に限らず）ほとんどメソッド記法で書かれていました．</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\"><span class=\"token builtin\">Array</span><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/**\n   * Gets or sets the length of the array. This is a number one higher than the highest index in the array.\n   */</span>\n  length<span class=\"token operator\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">/**\n   * Returns a string representation of an array.\n   */</span>\n  <span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">/**\n   * Returns a string representation of an array. The elements are converted to string using their toLocaleString methods.\n   */</span>\n  <span class=\"token function\">toLocaleString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>出典: <a href=\"https://github.com/microsoft/TypeScript/blob/main/lib/lib.es5.d.ts\">lib.es5.d.ts，TypeScript</a></p>\n</blockquote>\n<p>したがって，これらの引数はゆるめに扱われており，配列の共変性にも効果があるというわけです．</p>\n<h3 id=\"配列専用の型付け規則\" style=\"position:relative;\"><a href=\"#%E9%85%8D%E5%88%97%E5%B0%82%E7%94%A8%E3%81%AE%E5%9E%8B%E4%BB%98%E3%81%91%E8%A6%8F%E5%89%87\" aria-label=\"配列専用の型付け規則 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>配列専用の型付け規則</h3>\n<p>メソッド記法と変性の関係についてわかったところで，さっそく<code class=\"language-text\">lib.es5.d.ts</code>を次のように改造してみましょう．</p>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre class=\"language-diff\"><code class=\"language-diff\"><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span> /**\n<span class=\"token prefix unchanged\"> </span>  * Returns the index of the first occurrence of a value in an array, or -1 if it is not present.\n<span class=\"token prefix unchanged\"> </span>  * @param searchElement The value to locate in the array.\n<span class=\"token prefix unchanged\"> </span>  * @param fromIndex The array index at which to begin the search. If fromIndex is omitted, the search starts at index 0.\n<span class=\"token prefix unchanged\"> </span>  */\n</span><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span>  indexOf(searchElement: T, fromIndex?: number): number;\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>  indexOf: (searchElement: T, fromIndex?: number) => number;</span></code></pre></div>\n<p>これにより，問題のコードは型検査で失敗するようになるはずです．</p>\n<p>しかし，</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ npx tsc\n$ <span class=\"token comment\"># パス？？？</span></code></pre></div>\n<p>予想に反してパスしてしまいました．これが今回気づいたことです．</p>\n<p>原因を確かめるために，TypeScriptのコードを読んでみることにしました．これは初めてのことなので不安もありますが，がんばります．</p>\n<p>さて，型検査器のコードは<a href=\"https://github.com/microsoft/TypeScript\">microsoft/TypeScript</a>の<code class=\"language-text\">src/compiler/checker.ts</code>にあります．こちらのファイルは，現時点で47,206行（！？）あり，2.6MBもの容量があり，GitHubは表示を拒否します．</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 489px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7f3240fd07c370f00bc1dedde6e7db49/7bac6/checkerts_preview.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.68711656441718%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAACQUlEQVR42m1Ta3PaMBD05z6SgG1ZNn6DDQbzckiApG06k86kM+3//zubPQlchubDenWn0z1WsjNUMfy4hpcu4GUteQ5VbKDrA7GHz7UbJFCjAjdD3ePrIOj5Eo6nGZxMMYjn8HIeHjF5sUUw+w5VMWHZMWFqEn6+9Qll+Mudwqcb7/+EsiELFaW4Hfi4GSi4foih65M1PBWZ/YE/MklVmDE2g6dTRFnVJ7rzItOx4/oRyrLG89MLioLdhTmKqkVZt6jmW4M7JpPDOf2TZoXJbIm0bLDZPZsk0pRId+uGcDSrpnGBKEwQsrKr/2HIUQVS5Gy7Oj0xbZWYPbsvcRmcUT5Fvdyh2R4xWz0imywQxOMPMDnB2mpU9hwXU3a+Ic/gRFmNkqNM23uOtzZOFVGrqLTMAz75EuK7hOQQOYSdIJ2iePiLrPtNvCFp9ojrDsmM3W5eEZN3xxf8+PUH336+GU1lxOuk52KOYtth2SLM54Y1C+i0hhTS9AVcS9ciRTpmDO3rZJdwRAcdlwykNrygQLQ5bZ7t63E/0lgnVl9HFlm1RLs9QC7IHrJiq5Po6lQkuLA/0tEklI8ksbpIF1fB0gH/pMCMOraPW7o+dX4ZJ805YiRFQ30WiPlYz1olXI/yGulkhap7RXX/iqLpjD8p532cYfqkQ6OhVBnzDS27IxabA0ffY7F+xHyzJx7RrB6IHVqul534DoxjjLGPWO+eyAeMp2t7y1YXO7IVniyvP8r7i/DOCO2+/TuK/i85PyPR8B2xdZb0hNp+sgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/7f3240fd07c370f00bc1dedde6e7db49/33aa4/checkerts_preview.webp 489w\"\n              sizes=\"(max-width: 489px) 100vw, 489px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/7f3240fd07c370f00bc1dedde6e7db49/7bac6/checkerts_preview.png 489w\"\n            sizes=\"(max-width: 489px) 100vw, 489px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/7f3240fd07c370f00bc1dedde6e7db49/7bac6/checkerts_preview.png\"\n            alt=\"checker.tsファイルのプレビューをGitHubが拒否しているスクリーンショット\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>※<strong>あくまで念のために繰り返しますが，これは1つの<code class=\"language-text\">.ts</code>ファイルです．</strong></p>\n<p>さっそく不安が的中していますが，<em>覚悟</em> を決めて読んでいきます．</p>\n<p><code class=\"language-text\">tsc</code>コマンドのエントリーポイントから<code class=\"language-text\">console.log</code>や<code class=\"language-text\">console.trace</code>を仕込みつつ追っていくと，やがて<code class=\"language-text\">checker.ts</code>の<code class=\"language-text\">checkTypeRelatedTo</code>という関数にたどり着きました．</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">/**\n * Checks if 'source' is related to 'target' (e.g.: is a assignable to).\n * @param source The left-hand-side of the relation.\n * @param target The right-hand-side of the relation.\n * @param relation The relation considered. One of 'identityRelation', 'subtypeRelation', 'assignableRelation', or 'comparableRelation'.\n * Used as both to determine which checks are performed and as a cache of previously computed results.\n * @param errorNode The suggested node upon which all errors will be reported, if defined. This may or may not be the actual node used.\n * @param headMessage If the error chain should be prepended by a head message, then headMessage will be used.\n * @param containingMessageChain A chain of errors to prepend any new errors found.\n * @param errorOutputContainer Return the diagnostic. Do not log if 'skipLogging' is truthy.\n */</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">checkTypeRelatedTo</span><span class=\"token punctuation\">(</span>\n  source<span class=\"token operator\">:</span> Type<span class=\"token punctuation\">,</span>\n  target<span class=\"token operator\">:</span> Type<span class=\"token punctuation\">,</span>\n  relation<span class=\"token operator\">:</span> Map<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> RelationComparisonResult<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n  errorNode<span class=\"token operator\">:</span> Node <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span>\n  headMessage<span class=\"token operator\">?</span><span class=\"token operator\">:</span> DiagnosticMessage<span class=\"token punctuation\">,</span>\n  containingMessageChain<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> DiagnosticMessageChain <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span>\n  errorOutputContainer<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> errors<span class=\"token operator\">?</span><span class=\"token operator\">:</span> Diagnostic<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> skipLogging<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span> <span class=\"token punctuation\">{</span></code></pre></div>\n<blockquote>\n<p>出典: <a href=\"https://github.com/microsoft/TypeScript/blob/main/src/compiler/checker.ts\">checker.ts，TypeScript</a></p>\n</blockquote>\n<p>コイツは，2つの型の関係性をテストするための関数みたいです．今回の例だと<code class=\"language-text\">Dog[]</code>と<code class=\"language-text\">Animal[]</code>が<code class=\"language-text\">assignableRelation</code>にあるかどうかを検査するために呼ばれていました．</p>\n<details>\n<summary>\n  ところで，relationが取りうる値としてsubtypeRelationとassignableRelationという2つがありますが，これらは何が違うのでしょうか？\n</summary>\n<p>ここまで，サブタイプ関係と代入可能を同じような概念として暗黙的に扱ってきました．しかし，型検査器内ではこれらは区別されているということで，何が違うのか気になりますね．</p>\n<p>まぁ結論から言うと<strong>コードが長すぎてよくわからなかった</strong>のですが（すみません），サッと眺めた感じだと<code class=\"language-text\">assignableRelation</code>の方が<code class=\"language-text\">subtypeRelation</code>に比べてゆるい関係に見えました．基本的には両者に共通の処理が大半を占めつつも，例えば以下のようなコードがあり</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>relation <span class=\"token operator\">===</span> assignableRelation <span class=\"token operator\">||</span> relation <span class=\"token operator\">===</span> comparableRelation<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token comment\">// Type number is assignable to any computed numeric enum type or any numeric enum literal type, and</span>\n  <span class=\"token comment\">// a numeric literal type is assignable any computed numeric enum type or any numeric enum literal type</span>\n  <span class=\"token comment\">// with a matching value. These rules exist such that enums can be used for bit-flag purposes.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n    s <span class=\"token operator\">&amp;</span> TypeFlags<span class=\"token punctuation\">.</span>Number <span class=\"token operator\">&amp;&amp;</span>\n    <span class=\"token punctuation\">(</span>t <span class=\"token operator\">&amp;</span> TypeFlags<span class=\"token punctuation\">.</span>Enum <span class=\"token operator\">||</span>\n      <span class=\"token punctuation\">(</span>t <span class=\"token operator\">&amp;</span> TypeFlags<span class=\"token punctuation\">.</span>NumberLiteral <span class=\"token operator\">&amp;&amp;</span> t <span class=\"token operator\">&amp;</span> TypeFlags<span class=\"token punctuation\">.</span>EnumLiteral<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>出典: <a href=\"https://github.com/microsoft/TypeScript/blob/main/src/compiler/checker.ts\">checker.ts，TypeScript</a></p>\n</blockquote>\n<p>コメントには「<code class=\"language-text\">number</code>型は，enum型やenumリテラル型に代入可能．enumをフラグのように利用するケースがあるため」とあります．まさにその直後の<code class=\"language-text\">TypeFlags</code>はenumで，フラグのように使用されていますね．</p>\n<p>サンプルコードでも確認してみます．</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">enum</span> Flag <span class=\"token punctuation\">{</span>\n  <span class=\"token constant\">A</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n  <span class=\"token constant\">B</span> <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// numberがenumリテラル型に代入できる</span>\n<span class=\"token keyword\">const</span> flag<span class=\"token operator\">:</span> Flag<span class=\"token punctuation\">.</span><span class=\"token constant\">A</span> <span class=\"token operator\">=</span> <span class=\"token number\">123</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>おー，代入できます．</p>\n<p>このケースは<code class=\"language-text\">relation === assignableRelation</code>のif文の中にあるため，<code class=\"language-text\">assignableRelation</code>では有効ですが<code class=\"language-text\">subtypeRelation</code>では無効です．</p>\n<p><del>また，今回は見つけられませんでしたが，逆に<code class=\"language-text\">subtypeRelation</code>では有効だけど<code class=\"language-text\">assignableRelation</code>では無効なケースもあるかもしれません．</del> これは基本的になさそうです．代入可能関係はサブタイプ関係を拡張していると<a href=\"https://www.typescriptlang.org/docs/handbook/type-compatibility.html#subtype-vs-assignment\">ドキュメントに記載がありました．</a></p>\n<p>いずれにせよ，確かに<code class=\"language-text\">123 &lt;: Flag.A</code>は通常のサブタイプ関係では変な感じがしますから，新たに代入専用の関係を定義したほうが良かったのだろうなと解釈しました．</p>\n</details>\n<p>さて，<code class=\"language-text\">checkTypeRelatedTo</code>に入ってからはとても複雑な条件分岐や関数呼び出しが待ち構えているのですが，今回の場合は最終的に<code class=\"language-text\">structuredTypeRelatedToWorker</code>関数の以下の部分に入ります．</p>\n<p><code class=\"language-text\">// ダンプ</code>から始まるコメントは<code class=\"language-text\">console.log</code>で実際の値を確かめた結果です．</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">// ただし今回のケースに関係のない部分を一部省略しています</span>\n<span class=\"token comment\">// ダンプ：source === Array&lt;Dog></span>\n<span class=\"token comment\">// ダンプ：target === Array&lt;Animal></span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token function\">getObjectFlags</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> ObjectFlags<span class=\"token punctuation\">.</span>Reference <span class=\"token operator\">&amp;&amp;</span>\n  <span class=\"token function\">getObjectFlags</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> ObjectFlags<span class=\"token punctuation\">.</span>Reference <span class=\"token operator\">&amp;&amp;</span>\n  <span class=\"token punctuation\">(</span>source <span class=\"token keyword\">as</span> TypeReference<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>target <span class=\"token operator\">===</span> <span class=\"token punctuation\">(</span>target <span class=\"token keyword\">as</span> TypeReference<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>target <span class=\"token operator\">&amp;&amp;</span>\n  <span class=\"token operator\">!</span><span class=\"token function\">isTupleType</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n  <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span><span class=\"token function\">isMarkerType</span><span class=\"token punctuation\">(</span>source<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token function\">isMarkerType</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// We have type references to the same generic type, and the type references are not marker</span>\n  <span class=\"token comment\">// type references (which are intended by be compared structurally). Obtain the variance</span>\n  <span class=\"token comment\">// information for the type parameters and relate the type arguments accordingly.</span>\n  <span class=\"token comment\">// 訳すと：</span>\n  <span class=\"token comment\">//   同じジェネリクス型に対する2つの型があり，（Array&lt;Dog>とArray&lt;Animal>，今回はどちらもArrayに対する型）</span>\n  <span class=\"token comment\">//   それらはマーカータイプではなく（？　わからん）</span>\n  <span class=\"token comment\">//   構造的に比較されることを意図しています</span>\n  <span class=\"token comment\">//   型パラメタの引数に対する変性の情報を計算し（たぶんArray&lt;T>のTの変性を計算するということ）</span>\n  <span class=\"token comment\">//   それによって型引数を関連付けます（なるほど？）</span>\n\n  <span class=\"token comment\">// getVariancesが，さっき言っていた「Array&lt;T>のTの変性を計算する」やつと思われる</span>\n  <span class=\"token comment\">// ダンプ：(source as TypeReference).target === Array</span>\n  <span class=\"token keyword\">const</span> variances <span class=\"token operator\">=</span> <span class=\"token function\">getVariances</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>source <span class=\"token keyword\">as</span> TypeReference<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// ダンプ：variances === [VarianceFlags.Covariant]</span>\n  <span class=\"token comment\">// これはおそらくArrayの1つ目の型パラメタTが共変であることを表している</span>\n\n  <span class=\"token comment\">// relateVariancesは，[Dog]と[Animal]の関係を[VarianceFlags.Covariant]で検査すると思われる</span>\n  <span class=\"token comment\">// したがって結局Dog &lt;: Animalが検査される（共変）</span>\n  <span class=\"token keyword\">const</span> varianceResult <span class=\"token operator\">=</span> <span class=\"token function\">relateVariances</span><span class=\"token punctuation\">(</span>\n    <span class=\"token function\">getTypeArguments</span><span class=\"token punctuation\">(</span>source <span class=\"token keyword\">as</span> TypeReference<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// ダンプ：getTypeArguments(sourge) === [Dog]</span>\n    <span class=\"token function\">getTypeArguments</span><span class=\"token punctuation\">(</span>target <span class=\"token keyword\">as</span> TypeReference<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// ダンプ：getTypeArguments(target) === [Animal]</span>\n    variances<span class=\"token punctuation\">,</span> <span class=\"token comment\">// [VarianceFlags.Covariant]</span>\n    intersectionState <span class=\"token comment\">// なぞ．たぶん今回関係なし</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>varianceResult <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> varianceResult<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>出典: <a href=\"https://github.com/microsoft/TypeScript/blob/main/src/compiler/checker.ts\">checker.ts，TypeScript</a>，補足のコメントは筆者による</p>\n</blockquote>\n<p>というわけで，<code class=\"language-text\">getVariances</code>が<code class=\"language-text\">[VarianceFlags.Covariant]</code>を返す理由が気になります．さっそく定義を見てみると……</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> <span class=\"token function\">getVariances</span><span class=\"token punctuation\">(</span>type<span class=\"token operator\">:</span> GenericType<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> VarianceFlags<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Arrays and tuples are known to be covariant, no need to spend time computing this.</span>\n  <span class=\"token keyword\">return</span> type <span class=\"token operator\">===</span> globalArrayType <span class=\"token operator\">||</span>\n    type <span class=\"token operator\">===</span> globalReadonlyArrayType <span class=\"token operator\">||</span>\n    type<span class=\"token punctuation\">.</span>objectFlags <span class=\"token operator\">&amp;</span> ObjectFlags<span class=\"token punctuation\">.</span>Tuple\n    <span class=\"token operator\">?</span> arrayVariances\n    <span class=\"token operator\">:</span> <span class=\"token function\">getVariancesWorker</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">.</span><span class=\"token builtin\">symbol</span><span class=\"token punctuation\">,</span> type<span class=\"token punctuation\">.</span>typeParameters<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// ここでarrayVariancesは</span>\n<span class=\"token keyword\">const</span> arrayVariances <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>VarianceFlags<span class=\"token punctuation\">.</span>Covariant<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>出典: <a href=\"https://github.com/microsoft/TypeScript/blob/main/src/compiler/checker.ts\">checker.ts，TypeScript</a>，補足のコメントは筆者による</p>\n</blockquote>\n<p>あーやってる．これはやってますわ．</p>\n<p>コメントには「配列やタプルは共変なので変性を計算する必要はない」とあります．先程のダンプで<code class=\"language-text\">type</code>が<code class=\"language-text\">Array</code>なのは確認済みです．</p>\n<p><code class=\"language-text\">type</code>が<code class=\"language-text\">Array</code>の場合，<code class=\"language-text\">[VarianceFlags.Covariant]</code>という固定値が返されます．パフォーマンスを意図しての処理とも読めますが，実質的には配列を共変とする型付け規則の実装でもあります．</p>\n<p>それ以外の場合は<code class=\"language-text\">getVariancesWorker</code>という関数を呼び出して変性を計算しているようです．</p>\n<p>というわけで，<code class=\"language-text\">node_modules/typescript/lib/tsc.js</code>を以下のように変更します</p>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre class=\"language-diff\"><code class=\"language-diff\">function getVariances(type) {\n<span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span> return type === globalArrayType || type === globalReadonlyArrayType || type.objectFlags &amp; 8 ?\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span> return false ?\n</span><span class=\"token unchanged\"><span class=\"token prefix unchanged\"> </span>   arrayVariances :\n<span class=\"token prefix unchanged\"> </span>   getVariancesWorker(type.symbol, type.typeParameters);\n</span>}</code></pre></div>\n<p>「配列だろうが頑張って変性を計算しなさい！」と叱っておきました．これで再度型検査してみると……</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ npx tsc\nindex.ts:20:7 - error TS2322: Type <span class=\"token string\">'Dog[]'</span> is not assignable to <span class=\"token builtin class-name\">type</span> <span class=\"token string\">'Animal[]'</span><span class=\"token builtin class-name\">.</span>\n  Types of property <span class=\"token string\">'indexOf'</span> are incompatible.\n    Type <span class=\"token string\">'(searchElement: Dog, fromIndex?: number | undefined) => number'</span> is not assignable to <span class=\"token builtin class-name\">type</span> <span class=\"token string\">'(searchElement: Animal, fromIndex?: number | undefined) => number'</span><span class=\"token builtin class-name\">.</span>\n      Types of parameters <span class=\"token string\">'searchElement'</span> and <span class=\"token string\">'searchElement'</span> are incompatible.\n        Type <span class=\"token string\">'Animal'</span> is not assignable to <span class=\"token builtin class-name\">type</span> <span class=\"token string\">'Dog'</span><span class=\"token builtin class-name\">.</span>\n\n<span class=\"token number\">20</span> const animalArray: Animal<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> dogArray<span class=\"token punctuation\">;</span>\n         ~~~~~~~~~~~\n\n\nFound <span class=\"token number\">1</span> error <span class=\"token keyword\">in</span> index.ts:20</code></pre></div>\n<p>予想通りちゃんと落ちました！</p>\n<h2 id=\"おまけflowでは\" style=\"position:relative;\"><a href=\"#%E3%81%8A%E3%81%BE%E3%81%91flow%E3%81%A7%E3%81%AF\" aria-label=\"おまけflowでは permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>おまけ：Flowでは</h2>\n<p>配列は共変ではありません．</p>\n<p>今回のようなコードはデフォルトでエラーになります．</p>\n<div class=\"gatsby-highlight\" data-language=\"flow\"><pre class=\"language-flow\"><code class=\"language-flow\"><span class=\"token comment\">// @flow</span>\n\n<span class=\"token keyword\">type</span> Animal <span class=\"token operator\">=</span> <span class=\"token comment\">// ...省略...</span>\n<span class=\"token keyword\">type</span> Dog <span class=\"token operator\">=</span> <span class=\"token comment\">// ...省略...</span>\n\n<span class=\"token keyword\">const</span> animal <span class=\"token operator\">=</span> <span class=\"token comment\">// ...省略...</span>\n<span class=\"token keyword\">const</span> dog <span class=\"token operator\">=</span> <span class=\"token comment\">// ...省略...</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token literal-property property\">dogArray</span><span class=\"token operator\">:</span> Dog<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>dog<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token literal-property property\">animalArray</span><span class=\"token operator\">:</span> Animal<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> dogArray<span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ npx flow <span class=\"token parameter variable\">--version</span>\nFlow, a static <span class=\"token builtin class-name\">type</span> checker <span class=\"token keyword\">for</span> JavaScript, version <span class=\"token number\">0.195</span>.1\n$ npx flow check\nError ┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈┈ index.js:22:31\n\nCannot assign dogArray to animalArray because property dog is missing <span class=\"token keyword\">in</span> Animal <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> but exists <span class=\"token keyword\">in</span> Dog <span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">in</span> array\nelement. <span class=\"token punctuation\">[</span>prop-missing<span class=\"token punctuation\">]</span>\n\n     <span class=\"token number\">19</span>│ <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n     <span class=\"token number\">20</span>│\n <span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token number\">21</span>│ const dogArray: Dog<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>dog<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token number\">22</span>│ const animalArray: Animal<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> dogArray<span class=\"token punctuation\">;</span>\n     <span class=\"token number\">23</span>│\n\n\n\nFound <span class=\"token number\">1</span> error</code></pre></div>\n<h2 id=\"おまけ2javaでは\" style=\"position:relative;\"><a href=\"#%E3%81%8A%E3%81%BE%E3%81%912java%E3%81%A7%E3%81%AF\" aria-label=\"おまけ2javaでは permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>おまけ2：Javaでは</h2>\n<p>配列は共変です</p>\n<p>以下のコードは型検査に成功しますが実行時に失敗します<sup id=\"fnref-3\"><a href=\"#fn-3\" class=\"footnote-ref\">3</a></sup></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Animal</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Dog</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Animal</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Main</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Animal</span> animalArray<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Dog</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    animalArray<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Animal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ <span class=\"token function\">java</span> <span class=\"token parameter variable\">--version</span>\nopenjdk <span class=\"token number\">17.0</span>.5 <span class=\"token number\">2022</span>-10-18\nOpenJDK Runtime Environment Temurin-17.0.5+8 <span class=\"token punctuation\">(</span>build <span class=\"token number\">17.0</span>.5+8<span class=\"token punctuation\">)</span>\nOpenJDK <span class=\"token number\">64</span>-Bit Server VM Temurin-17.0.5+8 <span class=\"token punctuation\">(</span>build <span class=\"token number\">17.0</span>.5+8, mixed mode, sharing<span class=\"token punctuation\">)</span>\n$ javac main.java\n$ <span class=\"token comment\"># 型検査をパスするが</span>\n$ <span class=\"token function\">java</span> Main\nException <span class=\"token keyword\">in</span> thread <span class=\"token string\">\"main\"</span> java.lang.ArrayStoreException: Animal\n        at Main.main<span class=\"token punctuation\">(</span>main.java:7<span class=\"token punctuation\">)</span>\n$ <span class=\"token comment\"># ランタイムエラーになる</span></code></pre></div>\n<p>なんでこうなっているのか？というのがTAPLに書いてありました．</p>\n<blockquote>\n<p>元々この機能が導入されたのは、配列の一部分を複製するなどの一部の基本的な操作の型付けにおいて、パラメータ多相がないことを補うためであった。しかし現在、一般的には、これは言語設計の欠陥であると考えられている。</p>\n<p>出典: <a href=\"https://www.ohmsha.co.jp/book/9784274069116/\">型システム入門 プログラミング言語と型の理論</a>，p.155</p>\n</blockquote>\n<p>はえー．</p>\n<h2 id=\"まとめ\" style=\"position:relative;\"><a href=\"#%E3%81%BE%E3%81%A8%E3%82%81\" aria-label=\"まとめ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まとめ</h2>\n<p>TypeScriptの配列には共変性があります．これは，配列の型定義がメソッド記法で書かれていることと，配列専用の型付け規則によって実現されるようです．</p>\n<p>今回，TypeScriptの型検査器を初めて読んでみました．VS Codeで<code class=\"language-text\">checker.ts</code>を開いただけなのに，PCのファンが回りだし，メモリを700MB持っていかれました．ヤバいです．</p>\n<p>TypeScriptでは，健全性をある程度犠牲にして利便性とのバランスを取っています．それに比べてFlowは，より健全性を重視しているように感じました．</p>\n<p>TAPLによれば</p>\n<blockquote>\n<p>型検査を考慮して設計されていない言語に型システムを組み込むのは困難な問題である。</p>\n<p>出典: <a href=\"https://www.ohmsha.co.jp/book/9784274069116/\">型システム入門 プログラミング言語と型の理論</a>，p.7</p>\n</blockquote>\n<p>とあります．TypeScriptやFlowは，そもそも難しいことに挑戦してくれているんですね．後から型システムを導入しているわけですから，その方向性にバリエーションが生まれるのは，まぁあたりまえだよねという感じです．</p>\n<p>あとどうでもいいのですが，「反変」ってなんて読むのが正しいんですかね？　私は過去「はんぺん」と読んでいたのですが，ある日知り合いから「おでんかよｗｗｗ」とバカにされたのが悔しくて「はんへん」に矯正したという事情があります．だけどさっきWikipediaを見たら「はんぺん」って書いてあるじゃないですか．もう何がなんだか……．<sup id=\"fnref-4\"><a href=\"#fn-4\" class=\"footnote-ref\">4</a></sup></p>\n<p>最後に，本記事は<a href=\"https://adventar.org/calendars/7972\">Recruit Engineers Advent Calendar 2022</a>の15日目の記事でした．あまりぱっとしたネタが思いつかず，n番煎じみたいな記事になってしまいすみません．昨日は<a href=\"https://twitter.com/takepepe\">@Takepepe</a>さんによる「<a href=\"https://zenn.dev/takepepe/articles/nextjs-zod-gssp\">Next.js の Zod 活用術</a>」でした．明日は加納さんがなにかを書いてくれます．楽しみですね！</p>\n<h3 id=\"参考資料\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83%E8%B3%87%E6%96%99\" aria-label=\"参考資料 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考資料</h3>\n<ul>\n<li><a href=\"https://github.com/Microsoft/TypeScript/wiki/FAQ#why-are-function-parameters-bivariant\">Why are function parameters bivariant?, FAQ, microsoft/TypeScript</a></li>\n<li><a href=\"https://qiita.com/na-o-ys/items/aa56d678cdf0de2bdd79\">なぜ TypeScript の型システムが健全性を諦めているか</a></li>\n<li><a href=\"https://zenn.dev/f_subal/articles/what-is-bivariance-hack\">bivarianceHack とは何か、なぜ必要なのか</a></li>\n<li><a href=\"https://kgtkr.net/blog/2018/06/23/typescript-unsafe\">TypeScriptのunsafeな操作まとめ</a></li>\n</ul>\n<h3 id=\"フリー画像の出典\" style=\"position:relative;\"><a href=\"#%E3%83%95%E3%83%AA%E3%83%BC%E7%94%BB%E5%83%8F%E3%81%AE%E5%87%BA%E5%85%B8\" aria-label=\"フリー画像の出典 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>フリー画像の出典</h3>\n<ul>\n<li><a href=\"https://forest17.com/2r5/2r5l/r5l_8164.html\">r5l-8164　はんぺん「花ざかりの森」</a></li>\n</ul>\n<div class=\"footnotes\">\n<hr>\n<ol>\n<li id=\"fn-1\">TAPL p.143で言うところの深さ部分型付け，S-RcdDepth規則のことです．他にも幅部分型付けなどもあるので逆は成り立ちません．<a href=\"#fnref-1\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-2\">正確には双変となり，共変または反変を許すといったかんじになるのだそうですが詳しい説明は割愛します．気になる方は「bivarianceHack」と検索してみてください．また，この挙動は<code class=\"language-text\">strictFunctionTypes</code>オプションとはあまり関係ありません．今回の環境は<code class=\"language-text\">strict: true</code>であり，<code class=\"language-text\">strictFunctionTypes</code>も有効化されています．<a href=\"#fnref-2\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-3\">ちなみにこれは，TAPLにおける演習 15.5.3の解答でもあります．TAPLではこの演習は解答略とされているので，正確に著者が意図したものという保証はありませんが．<a href=\"#fnref-3\" class=\"footnote-backref\">↩</a></li>\n<li id=\"fn-4\">TAPLに読み方は載っていませんでしたし，検索してもWikipedia以外の情報が出てこないので詰んでいます．もしご存知でしたら助けてください．<a href=\"#fnref-4\" class=\"footnote-backref\">↩</a></li>\n</ol>\n</div>","frontmatter":{"title":"TypeScriptにおける配列の共変性","date":"2022/12/15"},"fields":{"slug":"/TypeScriptにおける配列の共変性/"},"id":"84bf9a79-dd68-55d1-a1b3-60ffd3784554"},"firstImage":{"imageFile":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#282828","images":{"fallback":{"src":"/static/00f23a0da5a379c700a254af121e9b07/8dbcc/top.jpg","srcSet":"/static/00f23a0da5a379c700a254af121e9b07/81bf6/top.jpg 300w,\n/static/00f23a0da5a379c700a254af121e9b07/3f4ea/top.jpg 600w,\n/static/00f23a0da5a379c700a254af121e9b07/8dbcc/top.jpg 1200w","sizes":"(min-width: 1200px) 1200px, 100vw"},"sources":[{"srcSet":"/static/00f23a0da5a379c700a254af121e9b07/9b21f/top.webp 300w,\n/static/00f23a0da5a379c700a254af121e9b07/9ff6b/top.webp 600w,\n/static/00f23a0da5a379c700a254af121e9b07/f2559/top.webp 1200w","type":"image/webp","sizes":"(min-width: 1200px) 1200px, 100vw"}]},"width":1200,"height":800}}}},"relatedMarkdownRemarks":{"posts":[{"id":"29b79017-f96d-5b04-8d01-5b8ee761ebed","frontmatter":{"draft":null}},{"id":"3a3c4125-9986-53bb-8b96-ae29936c96ab","frontmatter":{"draft":null}},{"id":"f920a8a8-f5fe-57c9-8792-95c93d2b74eb","frontmatter":{"draft":null}},{"id":"89ddbcc0-ed71-5a69-9d55-9677eab3e6cf","frontmatter":{"draft":null}},{"id":"82d43655-ea2a-52cd-97a3-16b7b28ad150","frontmatter":{"draft":null}},{"id":"f49ce388-e81c-5425-af59-9902f125c20f","frontmatter":{"draft":null}},{"id":"3c14921d-1ba3-5a7a-93a2-757f3a03ee3a","frontmatter":{"draft":null}},{"id":"5dba01b8-593d-5295-b135-16df1c6295e5","frontmatter":{"draft":null}},{"id":"3d71b3f9-8d6b-58a4-b6cb-8293daf99d74","frontmatter":{"draft":null}},{"id":"fc7ce496-d3b3-5f39-a04e-8e2dfb960626","frontmatter":{"draft":null}},{"id":"be594923-185e-5cca-95b6-5267b3c9fc8c","frontmatter":{"draft":null}},{"id":"50d3cc2a-de7a-5b9a-a8d8-754415fe4d94","frontmatter":{"draft":null}},{"id":"c2db052c-95c6-5094-935b-9eb39f5c762a","frontmatter":{"draft":null}},{"id":"75696ec6-74a3-5046-8a3c-f39b36d92311","frontmatter":{"draft":null}},{"id":"0bc9da5c-36cb-5e74-8b2f-bf514edbb710","frontmatter":{"draft":null}},{"id":"871ac696-39ea-5c64-94f3-5dc4b73b5770","frontmatter":{"draft":true}},{"id":"69a4aa90-b728-522c-b34f-abee49825c45","frontmatter":{"draft":true}},{"id":"50951bb1-eb92-5663-a3d8-8f35f73a1322","frontmatter":{"draft":null}},{"id":"1162dccb-e1bf-576d-a5c6-0993394feb0a","frontmatter":{"draft":true}},{"id":"73d6ab42-b3e6-5663-a175-b1f3d69c29e1","frontmatter":{"draft":null}},{"id":"0116f663-28d1-507a-b5ab-b189801dd408","frontmatter":{"draft":true}},{"id":"01deffb8-0d62-54c6-9e41-20832cbc3c6e","frontmatter":{"draft":null}},{"id":"067a602f-4581-5707-b896-73190dd8c889","frontmatter":{"draft":null}},{"id":"0c5568c9-6d87-56ed-ab0e-caeb9c1aafa4","frontmatter":{"draft":null}},{"id":"1086a735-7173-58cc-a813-c540a563aedf","frontmatter":{"draft":false}},{"id":"12222bfa-2e8e-51ee-99d8-8a19902351f5","frontmatter":{"draft":null}},{"id":"1509de3c-7308-5e40-a885-f5ebdb089774","frontmatter":{"draft":null}},{"id":"27f10a38-0ecb-539f-a717-7e40a41bbd10","frontmatter":{"draft":null}},{"id":"2cfd9e33-b4e1-53e4-884d-d8a6760f3387","frontmatter":{"draft":true}},{"id":"2f30c3f1-0d66-590b-8dba-7836df701d46","frontmatter":{"draft":null}},{"id":"3908aafc-c8d3-5c67-821f-0866592449f2","frontmatter":{"draft":true}},{"id":"3b696b96-130d-50de-a673-dc1367f32387","frontmatter":{"draft":null}},{"id":"46a22c41-5455-557c-85d4-973a6e2220ee","frontmatter":{"draft":null}},{"id":"48c65a15-67ca-57d0-9edc-ebcb868f7ad2","frontmatter":{"draft":true}},{"id":"49cf25c1-03f6-575e-8c2f-638ccd6198ea","frontmatter":{"draft":null}},{"id":"4d43646f-8aa6-52b6-b0b6-5160f0be2b05","frontmatter":{"draft":null}},{"id":"4ed3b747-2001-54f4-9661-3acab89ce275","frontmatter":{"draft":null}},{"id":"4edc1b46-b395-5783-af6a-818b8fc9c2dc","frontmatter":{"draft":null}},{"id":"4efc4f86-56aa-5ff4-8994-3946583906ad","frontmatter":{"draft":null}},{"id":"5010f43b-fdb5-5b2b-8f0c-3b7434219588","frontmatter":{"draft":null}},{"id":"5888c50d-8414-5e8f-b0dc-28a31b29053d","frontmatter":{"draft":null}},{"id":"63f3c7ad-6c59-52b5-9816-78fd348955ff","frontmatter":{"draft":true}},{"id":"6b318bb6-2c5f-5f38-93c7-5ed1cca1fff8","frontmatter":{"draft":null}},{"id":"73ab4455-f04d-5320-bf3a-90b9f7441d13","frontmatter":{"draft":null}},{"id":"75550af2-8134-5467-a07d-abbb5a4f6b7c","frontmatter":{"draft":true}},{"id":"7778d041-a5bf-536a-a36f-c0dbc5e08ac7","frontmatter":{"draft":true}},{"id":"78349b16-6e41-5fef-ae38-bcdc5ff297ef","frontmatter":{"draft":true}},{"id":"7a8fc278-a847-5b68-8b74-a83193ba3f55","frontmatter":{"draft":null}},{"id":"7d6499d9-277c-5f07-b8b1-98ae40c50c42","frontmatter":{"draft":true}},{"id":"7d79eb4b-cd4a-5621-a67a-91d9a24dce05","frontmatter":{"draft":null}},{"id":"8b3e46c2-1a1e-5af0-8900-7972c7285d15","frontmatter":{"draft":null}},{"id":"8f7b1b24-7738-5b97-bfb6-fd763f11a664","frontmatter":{"draft":true}},{"id":"961ec1e6-3f2b-59d9-a33f-dad76cf67f47","frontmatter":{"draft":null}},{"id":"97f01467-e3a1-58e1-b2a4-db77354cc1a3","frontmatter":{"draft":null}},{"id":"9f02de74-61a0-5daf-a048-1c1022e08fe4","frontmatter":{"draft":null}},{"id":"9f24363b-ee3e-54bf-8a18-46ea3b269bea","frontmatter":{"draft":null}},{"id":"a091877c-69b8-59f9-8963-1af334fd573c","frontmatter":{"draft":null}},{"id":"a190aac4-0483-5e02-b1d3-261f3b5f313a","frontmatter":{"draft":null}},{"id":"a6c64123-b824-5224-8027-90eb12040396","frontmatter":{"draft":null}},{"id":"b4251348-b618-5b5b-a2c8-e4c6b2431b83","frontmatter":{"draft":true}},{"id":"bfee69af-7d7f-5d87-9680-d2e9b60f8416","frontmatter":{"draft":null}},{"id":"c2249b7b-b97e-5cf4-8ea9-8024e96851b7","frontmatter":{"draft":true}},{"id":"c5e2431a-cf05-5024-b833-e1c69f680d44","frontmatter":{"draft":null}},{"id":"c6def021-b8da-5dbe-ad3e-811d9286424d","frontmatter":{"draft":true}},{"id":"c7a5adfb-149b-5469-ba35-7421e2101951","frontmatter":{"draft":null}},{"id":"cbdf3192-973c-5d87-9cf1-bb9110e9a169","frontmatter":{"draft":null}},{"id":"d29b4513-0609-5cfc-af49-817467dbed1f","frontmatter":{"draft":null}},{"id":"d4d1afa4-f2f9-5942-ae36-2826fb938af5","frontmatter":{"draft":null}},{"id":"db26c6b9-37b4-5cc4-b1ec-c61dc667863e","frontmatter":{"draft":null}},{"id":"dd0c41cf-0a03-5b89-b5a2-f64859aeae63","frontmatter":{"draft":null}},{"id":"e322eac2-bd89-5347-b20d-d050d303a6be","frontmatter":{"draft":null}},{"id":"e376b2d4-df91-5b82-af7a-a8d02763e922","frontmatter":{"draft":true}},{"id":"e4fb8478-b1ad-59eb-95e8-8c5e0500d3f4","frontmatter":{"draft":true}},{"id":"e83330dc-2312-5ae6-95fa-53e86909f42b","frontmatter":{"draft":true}},{"id":"eba9aa6a-6e21-5f1b-a0eb-7b6bfb1e04f1","frontmatter":{"draft":null}},{"id":"ebae7878-c4ee-505e-81e2-3d3fc47ea826","frontmatter":{"draft":true}},{"id":"ed7af7f9-75f5-59be-9063-de564576eed7","frontmatter":{"draft":true}},{"id":"f06a6ae0-e961-504c-8dab-a60489c0557a","frontmatter":{"draft":true}},{"id":"f5a25ce1-67a6-51b2-9bf1-f9fbacb41ad1","frontmatter":{"draft":true}},{"id":"fd6eab68-17d3-5395-8b2b-54a6efe43ebb","frontmatter":{"draft":null}}]}},"pageContext":{"id":"84bf9a79-dd68-55d1-a1b3-60ffd3784554"}},"staticQueryHashes":["1800451590","2576926420","63159454"],"slicesMap":{}}