{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/【Rust】400行以内でEthernet、ARP、IP、ICMPを書いてみるRTA-17:20:56/","result":{"data":{"site":{"siteMetadata":{"siteUrl":"https://sititou70.github.io"}},"markdownRemark":{"excerpt":"あけましておめでとうございます。sititou70です。 新年で暇でしょうがないので、RTAを走ることにしました。 レギュレーション Linux環境上のTAPデバイスを使って、 にICMP Echoを要求し、Replyを受信するRustのプログラムを作成する。 そのために、Ethernet、ARP、IP、ICMP…","html":"<p>あけましておめでとうございます。sititou70です。</p>\n<p>新年で暇でしょうがないので、RTAを走ることにしました。</p>\n<h2 id=\"レギュレーション\" style=\"position:relative;\"><a href=\"#%E3%83%AC%E3%82%AE%E3%83%A5%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3\" aria-label=\"レギュレーション permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>レギュレーション</h2>\n<ul>\n<li>Linux環境上のTAPデバイスを使って、<code class=\"language-text\">8.8.8.8</code> にICMP Echoを要求し、Replyを受信するRustのプログラムを作成する。</li>\n<li>そのために、Ethernet、ARP、IP、ICMPの基本的な実装を行う。</li>\n<li>あくまで速さを優先する。実装の綺麗さや正確さは問わない。</li>\n</ul>\n<h3 id=\"注意\" style=\"position:relative;\"><a href=\"#%E6%B3%A8%E6%84%8F\" aria-label=\"注意 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>注意</h3>\n<p>時系列で書いていくので、バグがあるコードも登場します。最終的なコードは以下のリポジトリを参照してください。</p>\n<p><a href=\"https://github.com/sititou70/rust-icmp\">https://github.com/sititou70/rust-icmp</a></p>\n<h2 id=\"開始\" style=\"position:relative;\"><a href=\"#%E9%96%8B%E5%A7%8B\" aria-label=\"開始 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>開始</h2>\n<p><code class=\"language-text\">2025-01-11T18:59:12+09:00</code>にタイマースタート、グッドラックです！</p>\n<h2 id=\"環境構築\" style=\"position:relative;\"><a href=\"#%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89\" aria-label=\"環境構築 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>環境構築</h2>\n<p>Rustをインストールします。</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">curl</span> <span class=\"token parameter variable\">--proto</span> <span class=\"token string\">'=https'</span> <span class=\"token parameter variable\">--tlsv1.2</span> <span class=\"token parameter variable\">-sSf</span> https://sh.rustup.rs <span class=\"token operator\">|</span> <span class=\"token function\">sh</span></code></pre></div>\n<p>VS Codeに<a href=\"https://marketplace.visualstudio.com/items?itemName=rust-lang.rust-analyzer\">rust-analyzer拡張</a>を導入します。</p>\n<p><code class=\"language-text\">cargo init</code> します。</p>\n<p>Wiresharkをインストールします。</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> wireshark</code></pre></div>\n<p>TAPデバイスをセットアップします。</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token assign-left variable\">TAP_NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"tap0\"</span>\n<span class=\"token assign-left variable\">TAP_ADDR</span><span class=\"token operator\">=</span><span class=\"token string\">\"192.168.70.1/24\"</span>\n<span class=\"token assign-left variable\">GATEWAY_DEVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"wlp0s20f3\"</span>\n\n<span class=\"token function\">sudo</span> <span class=\"token function\">ip</span> tuntap <span class=\"token function\">add</span> mode tap user <span class=\"token environment constant\">$USER</span> name <span class=\"token variable\">$TAP_NAME</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">ip</span> addr <span class=\"token function\">add</span> <span class=\"token variable\">$TAP_ADDR</span> dev <span class=\"token variable\">$TAP_NAME</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">ip</span> <span class=\"token function\">link</span> <span class=\"token builtin class-name\">set</span> <span class=\"token variable\">$TAP_NAME</span> up\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token number\">1</span> <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> /proc/sys/net/ipv4/ip_forward <span class=\"token operator\">></span>/dev/null\n<span class=\"token function\">sudo</span> iptables <span class=\"token parameter variable\">-A</span> FORWARD <span class=\"token parameter variable\">-o</span> <span class=\"token variable\">$TAP_NAME</span> <span class=\"token parameter variable\">-j</span> ACCEPT\n<span class=\"token function\">sudo</span> iptables <span class=\"token parameter variable\">-A</span> FORWARD <span class=\"token parameter variable\">-i</span> <span class=\"token variable\">$TAP_NAME</span> <span class=\"token parameter variable\">-j</span> ACCEPT\n<span class=\"token function\">sudo</span> iptables <span class=\"token parameter variable\">-t</span> nat <span class=\"token parameter variable\">-A</span> POSTROUTING <span class=\"token parameter variable\">-s</span> <span class=\"token variable\">$TAP_ADDR</span> <span class=\"token parameter variable\">-o</span> <span class=\"token variable\">$GATEWAY_DEVICE</span> <span class=\"token parameter variable\">-j</span> MASQUERADE</code></pre></div>\n<h2 id=\"tun_tapクレート\" style=\"position:relative;\"><a href=\"#tun_tap%E3%82%AF%E3%83%AC%E3%83%BC%E3%83%88\" aria-label=\"tun_tapクレート permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>tun_tapクレート</h2>\n<p>tun_tapクレートを使用すると、プログラムからTAPデバイスを簡単に利用できます。つまり、自分で <code class=\"language-text\">/dev/net/tun</code> をopenしてフラグやらなにやらをちくちく設定しなくて良いというわけです。最高ですね。</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">cargo</span> <span class=\"token function\">add</span> tun_tap</code></pre></div>\n<p>実際にtapデバイスを開いてみます。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> iface <span class=\"token operator\">=</span> <span class=\"token class-name\">Iface</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tap0\"</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Mode</span><span class=\"token punctuation\">::</span><span class=\"token class-name\">Tap</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Failed to create a TAP device\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>これを実行してエラーが出なければOKです。</p>\n<p>この <code class=\"language-text\">iface</code> には<a href=\"https://docs.rs/tun-tap/latest/tun_tap/struct.Iface.html#method.send\">send</a>とか<a href=\"https://docs.rs/tun-tap/latest/tun_tap/struct.Iface.html#method.recv\">recv</a>メソッドが生えているので、それらを使ってイーサネットフレームを送受信し放題ってわけですね。</p>\n<h2 id=\"arpの実装\" style=\"position:relative;\"><a href=\"#arp%E3%81%AE%E5%AE%9F%E8%A3%85\" aria-label=\"arpの実装 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ARPの実装</h2>\n<p>さて、<code class=\"language-text\">iface</code> を使用してさっそくICMP Echo要求を送信したいわけですが、現時点ではゲートウェイのハードウェアアドレスすらわかりません。なので、先にARPを実装します。</p>\n<p>ARPメッセージはざっくり以下のような構造になっています。カッコの中はオクテット数です。</p>\n<ul>\n<li>ハードウェアタイプ(2)：Ethernetの場合は1</li>\n<li>プロトコルタイプ(2)：上位プロトコルの種類。IPは0x0800</li>\n<li>ハードウェアアドレスサイズ(1)：Ethernetは6</li>\n<li>プロトコルアドレスサイズ(1)：IPは4</li>\n<li>オペレーション(2)：送信者の動作。要求は1、返信は2</li>\n<li>送信元ハードウェアアドレス(6)</li>\n<li>送信元プロトコルアドレス(4)</li>\n<li>送信先ハードウェアアドレス(6)</li>\n<li>送信先プロトコルアドレス(4)</li>\n</ul>\n<p>これを生成する関数、<code class=\"language-text\">create_arp_request_message</code> を作成します。今回は、バイト列を <code class=\"language-text\">Vec&lt;u8></code> で取り回すことにします。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">create_arp_request_message</span><span class=\"token punctuation\">(</span>\n    sender_ipaddr_str<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">str</span><span class=\"token punctuation\">,</span>\n    sender_hwaddr_str<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">str</span><span class=\"token punctuation\">,</span>\n    target_ipaddr_str<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">str</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">u8</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> hardware_type <span class=\"token operator\">=</span> <span class=\"token number\">1_u16</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_be_bytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_vec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> protocol_type <span class=\"token operator\">=</span> <span class=\"token number\">0x0800_u16</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_be_bytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_vec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// IPv4</span>\n    <span class=\"token keyword\">let</span> hardware_size <span class=\"token operator\">=</span> <span class=\"token macro property\">vec!</span><span class=\"token punctuation\">[</span><span class=\"token number\">6_u8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// ...</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>\n        hardware_type<span class=\"token punctuation\">,</span>\n        protocol_type<span class=\"token punctuation\">,</span>\n        hardware_size<span class=\"token punctuation\">,</span>\n        <span class=\"token comment\">// ...</span>\n    <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>特に難しい部分はありませんが、最終的にネットワークへ流すデータはネットワークエンディアン（ビッグエンディアン）であることに注意します。</p>\n<h2 id=\"ethernetの実装\" style=\"position:relative;\"><a href=\"#ethernet%E3%81%AE%E5%AE%9F%E8%A3%85\" aria-label=\"ethernetの実装 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ethernetの実装</h2>\n<p>ARP要求はEthernetで送信するので、同じように <code class=\"language-text\">create_ethernet_frame</code> を作成します。</p>\n<ul>\n<li>送信先アドレス(6)：xx:xx:xx:xx:xx:xx</li>\n<li>送信元アドレス(6)：xx:xx:xx:xx:xx:xx</li>\n<li>上位プロトコルのタイプ(2)：<a href=\"https://ja.wikipedia.org/wiki/EtherType\">EtherType</a></li>\n<li>データ(46〜1500)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">create_ethernet_frame</span><span class=\"token punctuation\">(</span>\n    protocol_type<span class=\"token punctuation\">:</span> <span class=\"token keyword\">u16</span><span class=\"token punctuation\">,</span>\n    dest_hwaddr_str<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">str</span><span class=\"token punctuation\">,</span>\n    src_hwaddr_str<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">str</span><span class=\"token punctuation\">,</span>\n    data<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">u8</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">u8</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> data<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">1500</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token macro property\">panic!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"too long data is not supported.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">let</span> dest_hwaddr <span class=\"token operator\">=</span> <span class=\"token function\">parse_hwaddr</span><span class=\"token punctuation\">(</span>dest_hwaddr_str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> src_hwaddr <span class=\"token operator\">=</span> <span class=\"token function\">parse_hwaddr</span><span class=\"token punctuation\">(</span>src_hwaddr_str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> protocol_type <span class=\"token operator\">=</span> protocol_type<span class=\"token punctuation\">.</span><span class=\"token function\">to_be_bytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_vec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> padding<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">u8</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token macro property\">vec!</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> data<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">46</span> <span class=\"token punctuation\">{</span>\n        padding<span class=\"token punctuation\">.</span><span class=\"token function\">resize</span><span class=\"token punctuation\">(</span><span class=\"token number\">46</span> <span class=\"token operator\">-</span> data<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>\n        dest_hwaddr<span class=\"token punctuation\">,</span>\n        src_hwaddr<span class=\"token punctuation\">,</span>\n        protocol_type<span class=\"token punctuation\">,</span>\n        data<span class=\"token punctuation\">.</span><span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        padding<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>dataが大きすぎる場合はパニックして楽をしています。今回扱うフレームは小さいものばかりなので問題ありません。</p>\n<p>dataが小さすぎる場合はパディングを行っています。衝突検知のための仕様だそうで、詳しくは謎ですが速さを優先して深入りしません。</p>\n<p><code class=\"language-text\">1500</code>、<code class=\"language-text\">46</code> などのマジックナンバーがハードコードされていますね。行儀の良さよりも速さを優先した結果です。</p>\n<p><code class=\"language-text\">parse_hwaddr</code> とかのユーティリティはよしなに作成しました。</p>\n<h2 id=\"arp要求を送ってみる\" style=\"position:relative;\"><a href=\"#arp%E8%A6%81%E6%B1%82%E3%82%92%E9%80%81%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B\" aria-label=\"arp要求を送ってみる permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ARP要求を送ってみる</h2>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">let</span> gateway_ipaddr <span class=\"token operator\">=</span> <span class=\"token string\">\"192.168.70.1\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> my_ipaddr <span class=\"token operator\">=</span> <span class=\"token string\">\"192.168.70.2\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> my_hwaddr <span class=\"token operator\">=</span> <span class=\"token string\">\"00:00:5e:00:53:01\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> arp_message <span class=\"token operator\">=</span> <span class=\"token function\">create_arp_request_message</span><span class=\"token punctuation\">(</span>my_ipaddr<span class=\"token punctuation\">,</span> my_hwaddr<span class=\"token punctuation\">,</span> gateway_ipaddr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> arp_frame <span class=\"token operator\">=</span> <span class=\"token function\">create_ethernet_frame</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x0806</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"ff:ff:ff:ff:ff:ff\"</span><span class=\"token punctuation\">,</span> my_hwaddr<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>arp_message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\niface<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>arp_frame<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>自分のハードウェアアドレスとIPアドレスを定義し、今回のゲートウェイのハードウェアアドレスを調べに行きます。</p>\n<p>イーサネットフレームのプロトコルタイプにはARP（<code class=\"language-text\">0x0806</code>）を設定し、ブロードキャスト（<code class=\"language-text\">\"ff:ff:ff:ff:ff:ff\"</code>）で送信します。</p>\n<p>デバッグのためにWiresharkを起動しておきます。なんか普通に起動するとtap0がWiresharkから見えないのでsudoで起動しました。確か何かしらのファイルの権限を調整すると、通常の起動でも動作するようにできた記憶がありますが、お行儀よりも速さを優先します。</p>\n<p>それではさっそくARP要求を投げてみましょう。</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token function\">cargo</span> run</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 653px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b9ac4be9e3e2e91fd6b3b6d15076172d/899f1/ss1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.05972434915773%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABv0lEQVR42lWRS28SURhA559okwKpWmyRFpDn8GwpKQxomZnCaDEqDC9bKIqJaYyuWqEIKiX2n2jiQjeu6qLV/pvjDW2adHFy7j3fTe7ikzzaC+xpE5+2Q9TYRdaauHJVvHqL6KMO3nwDv9rEu1FnQakiGx2iW13Cxda03d9o4MjWiW29wqO1kOT1BM3XBZ5tP6TWUWm9MWh0NzHbGpWWKtrmlMZLnUpbx9zVeb6TF60g3qjUxczsaJRFM6o5JNeyhbfvvHw+ijD5GqU/8HE49DMYBoVlBp9CHBwG6H/0CYs+Em0UYnIcEXO3aE5xdwmW2e85kRyWOfbUMMNqnFEtQb8cY9xM8eFpmPcFD72Sn95jPweGl/2iwBAflgJMaiHGlSBjM8SXSx9VQ0jB+TscB8L8TOX4ncryI6nwfTXDt5V1fq1lOVVU/grOczr/shrnD3TOlDynGZUzwUkyy5+13JQTgXRz5gazszPEw0HSyRVioQARQTwisxqVkf0elhbtuJ0OPEsOXPcWBItX5/k5K/Zbtiuk20oFW8bEoW2TMPdwi00HSl2CT7o4i23uis1Z02WsmcqF0xe2XDabYl7jPwPFJMhZ18YcAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/b9ac4be9e3e2e91fd6b3b6d15076172d/bfc64/ss1.webp 653w\"\n              sizes=\"(max-width: 653px) 100vw, 653px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/b9ac4be9e3e2e91fd6b3b6d15076172d/899f1/ss1.png 653w\"\n            sizes=\"(max-width: 653px) 100vw, 653px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/b9ac4be9e3e2e91fd6b3b6d15076172d/899f1/ss1.png\"\n            alt=\"Wiresharkのスクリーンショット。Sourceが53:01:08:06:00:01、Destinationがff:ff:00:00:5e:00となっている。またEthernetの上位プロトコルがIPv4と識別されている\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>全部おかしくて草。まずSourceとDestinationが変だし、ARPを送信したはずがIPv4と思われてます。</p>\n<h3 id=\"デバッグ\" style=\"position:relative;\"><a href=\"#%E3%83%87%E3%83%90%E3%83%83%E3%82%B0\" aria-label=\"デバッグ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>デバッグ</h3>\n<p>Wiresharkでフレームの中身を見てみると、</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">0000   ff ff 00 00 5e 00 53 01 08 06 00 01 08 00 06 04   ....^.S.........\n...</code></pre></div>\n<p>なんか先頭が欠けてるような気がするんですよね。<code class=\"language-text\">ff</code> が4個くらい足りなくない？</p>\n<p>念の為、以下のような <code class=\"language-text\">Vec&lt;u8></code> をダンプする関数を作って、プログラム側からフレームの中身を見てみます。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">dump_vec</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">u8</span><span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"{}\"</span><span class=\"token punctuation\">,</span>\n        data<span class=\"token punctuation\">.</span><span class=\"token function\">iter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token closure-params\"><span class=\"token closure-punctuation punctuation\">|</span>x<span class=\"token closure-punctuation punctuation\">|</span></span> <span class=\"token macro property\">format!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{:02x}\"</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">::</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token operator\">>></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>それをWiresharkのやつと比較してみると</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">プログラムでダンプしたフレーム:\nff ff ff ff ff ff 00 00 5e 00 53 01 08 06 00 01 08 00 06 04 ...\n\nWiresharkに表示されたフレーム:\n            ff ff 00 00 5e 00 53 01 08 06 00 01 08 00 06 04 ...</code></pre></div>\n<p>やっぱり先頭の4バイトが欠けて送信されてますよねこれ。</p>\n<p>なので、インターネットで「linux tap 4bytes missing」などと検索したところ、「<a href=\"https://stackoverflow.com/questions/43449664/why-the-leading-4bytes-data-missing-when-sending-raw-bytes-data-to-a-tap-device\">why the leading 4bytes data missing when sending raw bytes data to a tap device?</a>」という、同じ症状の民が見つかり、「TAPの <code class=\"language-text\">IFF_NO_PI</code> フラグの設定をミスってるよ」とのこと。</p>\n<p>公式ドキュメントによれば、</p>\n<blockquote>\n<p>IFF_NO_PI - Do not provide packet information</p>\n<p>If flag IFF_NO_PI is not set each frame format is::</p>\n<ul>\n<li>Flags [2 bytes]</li>\n<li>Proto [2 bytes]</li>\n<li>Raw protocol(IP, IPv6, etc) frame.</li>\n</ul>\n<p>出典：<a href=\"https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/Documentation/networking/tuntap.rst?id=HEAD\">https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/Documentation/networking/tuntap.rst?id=HEAD</a></p>\n</blockquote>\n<p>とあり、今回はEthernetフレームを直に書いているのでpacket informationなるものは不要そうです。</p>\n<p>というわけでこれはtun_tapクレートの不具合ですたぶん。</p>\n<p>なんとかして <code class=\"language-text\">IFF_NO_PI</code> を設定する方法を探す時間はないので、送信時には <code class=\"language-text\">Flags</code> と <code class=\"language-text\">Proto</code> にみせかけたゼロ埋めのパディングをはさみます。そして受信時には <code class=\"language-text\">Flags</code> と <code class=\"language-text\">Proto</code> を読み捨てます。</p>\n<h3 id=\"修正後\" style=\"position:relative;\"><a href=\"#%E4%BF%AE%E6%AD%A3%E5%BE%8C\" aria-label=\"修正後 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>修正後</h3>\n<p>送信処理と受信処理を清書します。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\">iface\n    <span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>\n        <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">[</span>\n            <span class=\"token macro property\">vec!</span><span class=\"token punctuation\">[</span><span class=\"token number\">0_u8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// for IFF_NO_PI</span>\n            arp_frame<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">to_vec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> gateway_hwaddr<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">loop</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> frame <span class=\"token operator\">=</span> <span class=\"token macro property\">vec!</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token number\">1500</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    iface<span class=\"token punctuation\">.</span><span class=\"token function\">recv</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> frame<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    frame<span class=\"token punctuation\">.</span><span class=\"token function\">drain</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">..</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// for IFF_NO_PI</span>\n\n    <span class=\"token comment\">// check</span>\n    <span class=\"token comment\">//// destination is my hwaddr</span>\n    <span class=\"token keyword\">if</span> frame<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">..</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token function\">parse_hwaddr</span><span class=\"token punctuation\">(</span>my_hwaddr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">//// type is arp</span>\n    <span class=\"token keyword\">if</span> frame<span class=\"token punctuation\">[</span><span class=\"token number\">12</span><span class=\"token punctuation\">..</span><span class=\"token number\">12</span> <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0x08_u8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x06_u8</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">let</span> message <span class=\"token operator\">=</span> <span class=\"token function\">get_ethernet_frame_data</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>frame<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//// opecode is reply</span>\n    <span class=\"token keyword\">if</span> message<span class=\"token punctuation\">[</span><span class=\"token number\">6</span><span class=\"token punctuation\">..</span><span class=\"token number\">6</span> <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token macro property\">vec!</span><span class=\"token punctuation\">[</span><span class=\"token number\">0x00</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x02</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    gateway_hwaddr <span class=\"token operator\">=</span> <span class=\"token function\">print_hwaddr</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>message<span class=\"token punctuation\">[</span><span class=\"token number\">8</span><span class=\"token punctuation\">..</span><span class=\"token number\">8</span> <span class=\"token operator\">+</span> <span class=\"token number\">6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_vec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"arp reply received, gateway_hwaddr: {}\"</span><span class=\"token punctuation\">,</span> gateway_hwaddr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>送信した後は、無限ループに入ってそれっぽいフレームを受信するまで待ちます。本当はここでどのようなチェックを行うかも仕様で決められてそうですが、今回は簡単さを優先しています。</p>\n<p>実行すると、gatewayのハードウェアアドレスが表示されました！</p>\n<p>かわいい〜〜！！</p>\n<h2 id=\"就寝\" style=\"position:relative;\"><a href=\"#%E5%B0%B1%E5%AF%9D\" aria-label=\"就寝 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>就寝</h2>\n<p><code class=\"language-text\">2025-01-12T02:00:00+09:00</code> とかなので流石に寝ます。</p>\n<h2 id=\"起床\" style=\"position:relative;\"><a href=\"#%E8%B5%B7%E5%BA%8A\" aria-label=\"起床 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>起床</h2>\n<p><code class=\"language-text\">2025-01-12T08:00:00+09:00</code> 頃に復帰しました。</p>\n<h2 id=\"icmpの実装\" style=\"position:relative;\"><a href=\"#icmp%E3%81%AE%E5%AE%9F%E8%A3%85\" aria-label=\"icmpの実装 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ICMPの実装</h2>\n<p>Echo要求メッセージは以下のような構造になっています。</p>\n<ul>\n<li>タイプ(1)：Echo要求は8。</li>\n<li>コード(1)：いまのところは0固定らしい</li>\n<li>チェックサム(2)：メッセージ全体から計算される</li>\n<li>識別子(2)：送信元で決める適当な値。プログラムのプロセスIDとかが使用されるらしい</li>\n<li>シーケンス番号(2)：同じ識別子で繰り返し要求する場合にインクリメントされる</li>\n<li>データ(可変)：適当。Replyで同じデータが返ってくる</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">create_icmp_echo_request_message</span><span class=\"token punctuation\">(</span>\n    identifire<span class=\"token punctuation\">:</span> <span class=\"token keyword\">u16</span><span class=\"token punctuation\">,</span>\n    sequence_number<span class=\"token punctuation\">:</span> <span class=\"token keyword\">u16</span><span class=\"token punctuation\">,</span>\n    data<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">u8</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">u8</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> message_type <span class=\"token operator\">=</span> <span class=\"token macro property\">vec!</span><span class=\"token punctuation\">[</span><span class=\"token number\">8_u8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// echo request</span>\n    <span class=\"token keyword\">let</span> code <span class=\"token operator\">=</span> <span class=\"token macro property\">vec!</span><span class=\"token punctuation\">[</span><span class=\"token number\">0_u8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// ...</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>\n        message_type<span class=\"token punctuation\">,</span>\n        code<span class=\"token punctuation\">,</span>\n        <span class=\"token comment\">// ...</span>\n    <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>最も厄介なのがチェックサムです。<a href=\"https://sititou70.github.io/%E3%83%97%E3%83%AD%E3%83%88%E3%82%B3%E3%83%AB%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%82%92%E5%86%99%E7%B5%8C%E3%81%97%E3%81%A6%E3%83%8D%E3%83%83%E3%83%88%E3%83%AF%E3%83%BC%E3%82%AF%E3%82%92%E5%AE%8C%E5%85%A8%E3%81%AB%E7%90%86%E8%A7%A3%E3%81%97%E3%81%9F%E3%81%8B%E3%81%A3%E3%81%9F%E6%97%A5%E8%A8%98/\">以前の記事</a>でもお世話になった、<a href=\"https://docs.google.com/presentation/d/1kjvdsM2Slfug4t4lQ5HRCitoTbH7edl-1OPtEaG53D8/edit#slide=id.gd326ebd0a8_0_798\">micropsのスライドの、チェックサムの計算方法</a>を参照します。</p>\n<p>おおざっぱな理解としては、対象のデータを2バイトごとに区切って整数とみなして合計し、補数やらなにやらを取れば良いそうです。以下のように実装しました。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">checksum16</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">u8</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> init<span class=\"token punctuation\">:</span> <span class=\"token keyword\">u32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token keyword\">u16</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> sum <span class=\"token operator\">=</span> init\n        <span class=\"token operator\">+</span> data\n            <span class=\"token punctuation\">.</span><span class=\"token function\">chunks</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token closure-params\"><span class=\"token closure-punctuation punctuation\">|</span>chunk<span class=\"token closure-punctuation punctuation\">|</span></span> <span class=\"token keyword\">u32</span><span class=\"token punctuation\">::</span><span class=\"token function\">from_be_bytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> chunk<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> chunk<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token closure-params\"><span class=\"token closure-punctuation punctuation\">|</span>x<span class=\"token punctuation\">,</span> y<span class=\"token closure-punctuation punctuation\">|</span></span> x <span class=\"token operator\">+</span> y<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">while</span> sum <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xffff0000</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n        sum <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>sum <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x0000ffff</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>sum <span class=\"token operator\">>></span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>sum <span class=\"token keyword\">as</span> <span class=\"token keyword\">u16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>2バイトごとに区切るので、<code class=\"language-text\">chunks(2)</code> したあと <code class=\"language-text\">map</code> で処理して <code class=\"language-text\">reduce</code> すればいいですね。</p>\n<h2 id=\"ipの実装\" style=\"position:relative;\"><a href=\"#ip%E3%81%AE%E5%AE%9F%E8%A3%85\" aria-label=\"ipの実装 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>IPの実装</h2>\n<p><code class=\"language-text\">8.8.8.8</code> にICMPメッセージを送るので、当たり前ですがIPの実装が必要です。IPパケットの構造は以下のようになります。</p>\n<ul>\n<li>バージョン(4ビット)：IPv4は4</li>\n<li>ヘッダ長(4ビット)：ヘッダの長さ。4オクテット単位。拡張情報が無いなら5</li>\n<li>サービス種別(1)：<a href=\"https://ja.wikipedia.org/wiki/Quality_of_Service\">QoS</a>機能？今回はとりあえず0</li>\n<li>全長(2)：IPヘッダを含むパケット全体の長さ</li>\n<li>識別子(2)：フラグメントの制御に使われる。割愛</li>\n<li>フラグ(3ビット)：フラグメントの制御に使われる。割愛</li>\n<li>断片位置(13ビット)：フラグメントの制御に使われる。割愛</li>\n<li>生存時間(1)：パケットの生存期間。ルータを通るたびにデクリメントされ、0になると破棄される。パケットがネットワーク上を無限ループするのを防ぐ。今回は255を設定。</li>\n<li>プロトコル(1)：上位のプロトコル番号。<a href=\"https://ja.wikipedia.org/wiki/%E3%83%97%E3%83%AD%E3%83%88%E3%82%B3%E3%83%AB%E7%95%AA%E5%8F%B7%E4%B8%80%E8%A6%A7\">ICMPは1</a></li>\n<li>チェックサム(2)</li>\n<li>送信元アドレス(4)</li>\n<li>宛先アドレス(4)</li>\n<li>拡張情報：なぞ</li>\n<li>データ(可変長)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">create_ip_packet</span><span class=\"token punctuation\">(</span>\n    protocol<span class=\"token punctuation\">:</span> <span class=\"token keyword\">u8</span><span class=\"token punctuation\">,</span>\n    id<span class=\"token punctuation\">:</span> <span class=\"token keyword\">u16</span><span class=\"token punctuation\">,</span>\n    src_ipaddr_str<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">str</span><span class=\"token punctuation\">,</span>\n    dest_ipaddr_str<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token keyword\">str</span><span class=\"token punctuation\">,</span>\n    data<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">u8</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">u8</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> internet_header_length <span class=\"token operator\">=</span> <span class=\"token number\">20_u8</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// min ip header size</span>\n    <span class=\"token keyword\">let</span> version_and_ihl <span class=\"token operator\">=</span> <span class=\"token macro property\">vec!</span><span class=\"token punctuation\">[</span><span class=\"token number\">4</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">4</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xf0</span> <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span>internet_header_length <span class=\"token operator\">>></span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x0f</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> type_of_service <span class=\"token operator\">=</span> <span class=\"token macro property\">vec!</span><span class=\"token punctuation\">[</span><span class=\"token number\">0_u8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// ...</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>\n        version_and_ihl<span class=\"token punctuation\">,</span>\n        type_of_service<span class=\"token punctuation\">,</span>\n        <span class=\"token comment\">// ...</span>\n    <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>チェックサムの計算には、先程の <code class=\"language-text\">checksum16</code> が使えます。</p>\n<h2 id=\"icmp要求を送ってみる\" style=\"position:relative;\"><a href=\"#icmp%E8%A6%81%E6%B1%82%E3%82%92%E9%80%81%E3%81%A3%E3%81%A6%E3%81%BF%E3%82%8B\" aria-label=\"icmp要求を送ってみる permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ICMP要求を送ってみる</h2>\n<p>以下のコードを実行してみると……</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">let</span> icmp_target_ipaddr <span class=\"token operator\">=</span> <span class=\"token string\">\"8.8.8.8\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> icmp_data <span class=\"token operator\">=</span> <span class=\"token string\">\"test test test test test test test test test test test test !\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> icmp_message <span class=\"token operator\">=</span>\n    <span class=\"token function\">create_icmp_echo_request_message</span><span class=\"token punctuation\">(</span><span class=\"token namespace\">process<span class=\"token punctuation\">::</span></span><span class=\"token function\">id</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> <span class=\"token keyword\">u16</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>icmp_data<span class=\"token punctuation\">.</span><span class=\"token function\">as_bytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_vec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> icmp_packet <span class=\"token operator\">=</span> <span class=\"token function\">create_ip_packet</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">123</span><span class=\"token punctuation\">,</span> my_ipaddr<span class=\"token punctuation\">,</span> icmp_target_ipaddr<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>icmp_message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> icmp_frame <span class=\"token operator\">=</span> <span class=\"token function\">create_ethernet_frame</span><span class=\"token punctuation\">(</span><span class=\"token number\">0x0800</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>gateway_hwaddr<span class=\"token punctuation\">,</span> my_hwaddr<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>icmp_packet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\niface\n    <span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>\n        <span class=\"token operator\">&amp;</span><span class=\"token punctuation\">[</span>\n            <span class=\"token macro property\">vec!</span><span class=\"token punctuation\">[</span><span class=\"token number\">0_u8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// for IFF_NO_PI</span>\n            icmp_frame<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">]</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">to_vec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">thread 'main' panicked at src/util.rs:126:62:\nindex out of bounds: the len is 1 but the index is 1</code></pre></div>\n<p>はい、<a href=\"https://rta-play.info/meaning/oob/\">Out of Bounds</a>です。</p>\n<p>どうやらチェックサムの <code class=\"language-text\">chunks(2)</code> で、データが奇数個の時に2人組を作れなくて怒ってるみたいです。<a href=\"https://dic.nicovideo.jp/a/%E3%81%AF%E3%81%84%E3%80%81%E4%BA%8C%E4%BA%BA%E7%B5%84%E3%81%A4%E3%81%8F%E3%81%A3%E3%81%A6%E3%83%BC\">小学生時代のトラウマが蘇りますね</a>。</p>\n<p>というわけで、端数が出たらそれも <code class=\"language-text\">sum</code> に足してやるようにします。<code class=\"language-text\">chunks</code> とか <code class=\"language-text\">map</code> とか <code class=\"language-text\">reduce</code> とかはやめて、以下のように書き直しました。漢は黙ってwhileループですよ。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">checksum16</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">:</span> <span class=\"token operator\">&amp;</span><span class=\"token class-name\">Vec</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">u8</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> init<span class=\"token punctuation\">:</span> <span class=\"token keyword\">u32</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token keyword\">u16</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> sum <span class=\"token operator\">=</span> init<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> index <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">while</span> index <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token operator\">&lt;</span> data<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        sum <span class=\"token operator\">+=</span> <span class=\"token keyword\">u32</span><span class=\"token punctuation\">::</span><span class=\"token function\">from_be_bytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">[</span>index <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        index <span class=\"token operator\">+=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> index <span class=\"token operator\">&lt;</span> data<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        sum <span class=\"token operator\">+=</span> <span class=\"token keyword\">u32</span><span class=\"token punctuation\">::</span><span class=\"token function\">from_be_bytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">while</span> sum <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xffff0000</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">{</span>\n        sum <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>sum <span class=\"token operator\">&amp;</span> <span class=\"token number\">0x0000ffff</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>sum <span class=\"token operator\">>></span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>sum <span class=\"token keyword\">as</span> <span class=\"token keyword\">u16</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>で、再度実行してみるとWiresharkくんに怒られました。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 451px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1de6767564a2d6c6f3c8bf3998d7dda5/3dce8/ss2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 20.842572062084255%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAABE0lEQVR42lWQ2U7CYBSE+yaAURZN2FqWUmiBChS95ClQ2YpGIUaCIlgkRI0immBYEuJbfv7hzosvM+dM5mYkWfbTuU4wGVs4o2OmkzLO0GRwn+Xt5ZThwKTf03f36DHP8CHLbTcp/irPjsb46T+SogQ4r8p0Oxatpk6rodG2c3RvCly1M7RbJvWaQe0iRe/uBLuZ46yq0qwrIouLThxb6KUtfCOG5HLt4fH4qFRKFEsqmUwYQw+hKH6iUT+GEUZLHZGIB0inw+RzIZKJQyIRr8i9KLJv54PBA2IxH5LbvU/ZCrFeWqx+ijt+tyWWiyJfszyrRZbNssx2XRATJNmsDD7fNWaC+SzN4ltn/qHxOlVF1+APLNqmXgnFxdcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/1de6767564a2d6c6f3c8bf3998d7dda5/922c0/ss2.webp 451w\"\n              sizes=\"(max-width: 451px) 100vw, 451px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/1de6767564a2d6c6f3c8bf3998d7dda5/3dce8/ss2.png 451w\"\n            sizes=\"(max-width: 451px) 100vw, 451px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/1de6767564a2d6c6f3c8bf3998d7dda5/3dce8/ss2.png\"\n            alt=\"Wiresharkのスクリーンショット。ICMPのチェックサムが間違っていると表示されている。ペイロードでは0x9fb8だが、正しくは0x3f19であることが表示されている。\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>ICMPのチェックサムが間違っているとのこと。ご丁寧に正しいチェックサムまで併記されてて便利ですね。</p>\n<p>結論としては端数の計算が間違っていて、以下のように修正しました。</p>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre class=\"language-diff\"><code class=\"language-diff\"><span class=\"token deleted-sign deleted\"><span class=\"token prefix deleted\">-</span> sum += u32::from_be_bytes([0, 0, 0, data[index]]);\n</span><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span> sum += u32::from_be_bytes([0, 0, data[index], 0]);</span></code></pre></div>\n<p>エンディアンの認識を間違ってましたね。</p>\n<p>これで再度実行すると……</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 728px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/715b55b407394f28f3c1b11a6352b1c3/bcd01/ss3.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 7.280219780219779%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAABCAYAAADeko4lAAAACXBIWXMAAAsTAAALEwEAmpwYAAAASklEQVR42hWKwQ2AIBAEbZgocrGAUw5aEETERtf1MdlsZqZgDRILxC74o5EKpxVz7Ahp4Pdb7mTA28N/QxJdfrGyXfSE39lznRZ8FxQze90tdWgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/715b55b407394f28f3c1b11a6352b1c3/f4a91/ss3.webp 728w,\n/static/715b55b407394f28f3c1b11a6352b1c3/ede6e/ss3.webp 840w\"\n              sizes=\"(max-width: 728px) 100vw, 728px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/715b55b407394f28f3c1b11a6352b1c3/beb58/ss3.png 728w,\n/static/715b55b407394f28f3c1b11a6352b1c3/bcd01/ss3.png 840w\"\n            sizes=\"(max-width: 728px) 100vw, 728px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/715b55b407394f28f3c1b11a6352b1c3/beb58/ss3.png\"\n            alt=\"Wiresharkのスクリーンショット。Seq 3の行は、192.168.70.2から8.8.8.8へのICMP Echo要求が送信されたことを示している。Seq 5の行は、8.8.8.8から192.178.70.2へ応答が返ってきていることを示している。\"\n            title=\"\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p><code class=\"language-text\">8.8.8.8</code> からお返事が来てる！やった〜〜！</p>\n<p>受信用のコードも書きます。ホントはここでもチェックの手順が仕様で決まっているのですが、今回は雰囲気で済ませます。</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token keyword\">loop</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mut</span> frame <span class=\"token operator\">=</span> <span class=\"token macro property\">vec!</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token number\">1500</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    iface<span class=\"token punctuation\">.</span><span class=\"token function\">recv</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">mut</span> frame<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">unwrap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    frame<span class=\"token punctuation\">.</span><span class=\"token function\">drain</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">..</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// for IFF_NO_PI</span>\n\n    <span class=\"token comment\">// check</span>\n    <span class=\"token comment\">//// destination is my hwaddre</span>\n    <span class=\"token keyword\">if</span> frame<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">..</span><span class=\"token number\">6</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token function\">parse_hwaddr</span><span class=\"token punctuation\">(</span>my_hwaddr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">//// type is IPv4</span>\n    <span class=\"token keyword\">if</span> frame<span class=\"token punctuation\">[</span><span class=\"token number\">12</span><span class=\"token punctuation\">..</span><span class=\"token number\">12</span> <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0x08_u8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0x00_u8</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">let</span> packet <span class=\"token operator\">=</span> <span class=\"token function\">get_ethernet_frame_data</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>frame<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//// version is 4</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>packet<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;</span> <span class=\"token number\">0xf0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">>></span> <span class=\"token number\">4</span> <span class=\"token operator\">!=</span> <span class=\"token number\">4_u8</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">//// protocol is icmp</span>\n    <span class=\"token keyword\">if</span> packet<span class=\"token punctuation\">[</span><span class=\"token number\">9</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">//// source addr is icmp_target_ipaddr</span>\n    <span class=\"token keyword\">if</span> packet<span class=\"token punctuation\">[</span><span class=\"token number\">12</span><span class=\"token punctuation\">..</span><span class=\"token number\">12</span> <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token function\">parse_ipaddr</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>icmp_target_ipaddr<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">let</span> message <span class=\"token operator\">=</span> <span class=\"token function\">get_ip_packet_data</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>packet<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//// type is reply</span>\n    <span class=\"token keyword\">if</span> message<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token number\">0_u8</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">let</span> data <span class=\"token operator\">=</span> <span class=\"token function\">get_icmp_message_data</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//// data is icmp_data</span>\n    <span class=\"token keyword\">if</span> data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">..</span>icmp_data<span class=\"token punctuation\">.</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> icmp_data<span class=\"token punctuation\">.</span><span class=\"token function\">as_bytes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_vec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token macro property\">println!</span><span class=\"token punctuation\">(</span>\n        <span class=\"token string\">\"icmp reply received from {}\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token function\">print_ipaddr</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>packet<span class=\"token punctuation\">[</span><span class=\"token number\">12</span><span class=\"token punctuation\">..</span><span class=\"token number\">12</span> <span class=\"token operator\">+</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">to_vec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>というわけで、最終的なコードを実行して問題がなければ……</p>\n<p>タイマーストップです！</p>\n<h2 id=\"完走した感想\" style=\"position:relative;\"><a href=\"#%E5%AE%8C%E8%B5%B0%E3%81%97%E3%81%9F%E6%84%9F%E6%83%B3\" aria-label=\"完走した感想 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>完走した感想</h2>\n<p>終了時刻は <code class=\"language-text\">2025-01-12T12:20:08+09:00</code>、記録は17:20:56でした。このカテゴリを走っている人が他にいないので、これが世界記録です。</p>\n<p>実際、ネットワークとかRustとかが久々すぎてミスが多かったり、Wiresharkで検証できることをコードで書いてて後から気づいて消したりと、チャートがボロボロだったので、もっと良いタイムを狙えた気がします。</p>\n<p>今回書いたコードは、テストコードを除くと374行でした。<a href=\"https://x.com/pandax381/status/1547489422954070021\">毎回参考にさせていただいているpandax381さんの資料</a>にある、<a href=\"https://github.com/pandax381/microps\">比較的読みやすい実装</a>でさえ、プロトコルやインターフェースの管理機構、非同期処理機構、ARPのキャッシュ機構、ルーティングテーブルの実装などを含んでいて、今回のより複雑です。</p>\n<p>なので、今回のコードは簡単すぎてプロトコルの実装と呼べるのかも怪しいのですが、勉強や趣味の目的には良いかもしれません。</p>\n<p>大切に育てたICMPメッセージが立派になって（Replyになって）戻ってくるのを見ると、親としての誇りを感じます。</p>\n<p>気が向いたら走ってみるとおもしろいかもしれません。</p>","frontmatter":{"title":"【Rust】400行以内でEthernet、ARP、IP、ICMPを書いてみるRTA 17:20:56","date":"2025/01/12"},"fields":{"slug":"/【Rust】400行以内でEthernet、ARP、IP、ICMPを書いてみるRTA-17:20:56/"},"id":"addc6dab-2819-51f8-a0f5-c48cb138eef1"},"firstImage":{"imageFile":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#282828","images":{"fallback":{"src":"/static/b9ac4be9e3e2e91fd6b3b6d15076172d/1b190/ss1.png","srcSet":"/static/b9ac4be9e3e2e91fd6b3b6d15076172d/a49a0/ss1.png 163w,\n/static/b9ac4be9e3e2e91fd6b3b6d15076172d/fd18a/ss1.png 327w,\n/static/b9ac4be9e3e2e91fd6b3b6d15076172d/1b190/ss1.png 653w","sizes":"(min-width: 653px) 653px, 100vw"},"sources":[{"srcSet":"/static/b9ac4be9e3e2e91fd6b3b6d15076172d/f755b/ss1.webp 163w,\n/static/b9ac4be9e3e2e91fd6b3b6d15076172d/fce8f/ss1.webp 327w,\n/static/b9ac4be9e3e2e91fd6b3b6d15076172d/54cc5/ss1.webp 653w","type":"image/webp","sizes":"(min-width: 653px) 653px, 100vw"}]},"width":653,"height":242.00000000000003}}}},"relatedMarkdownRemarks":{"posts":[{"id":"4d43646f-8aa6-52b6-b0b6-5160f0be2b05","frontmatter":{"draft":null}},{"id":"5dba01b8-593d-5295-b135-16df1c6295e5","frontmatter":{"draft":null}},{"id":"4efc4f86-56aa-5ff4-8994-3946583906ad","frontmatter":{"draft":null}},{"id":"75696ec6-74a3-5046-8a3c-f39b36d92311","frontmatter":{"draft":null}},{"id":"84bf9a79-dd68-55d1-a1b3-60ffd3784554","frontmatter":{"draft":null}},{"id":"f920a8a8-f5fe-57c9-8792-95c93d2b74eb","frontmatter":{"draft":null}},{"id":"c2db052c-95c6-5094-935b-9eb39f5c762a","frontmatter":{"draft":null}},{"id":"0116f663-28d1-507a-b5ab-b189801dd408","frontmatter":{"draft":true}},{"id":"3b696b96-130d-50de-a673-dc1367f32387","frontmatter":{"draft":null}},{"id":"63f3c7ad-6c59-52b5-9816-78fd348955ff","frontmatter":{"draft":true}},{"id":"89ddbcc0-ed71-5a69-9d55-9677eab3e6cf","frontmatter":{"draft":null}},{"id":"fc7ce496-d3b3-5f39-a04e-8e2dfb960626","frontmatter":{"draft":null}},{"id":"ebae7878-c4ee-505e-81e2-3d3fc47ea826","frontmatter":{"draft":true}},{"id":"82d43655-ea2a-52cd-97a3-16b7b28ad150","frontmatter":{"draft":null}},{"id":"69a4aa90-b728-522c-b34f-abee49825c45","frontmatter":{"draft":true}},{"id":"871ac696-39ea-5c64-94f3-5dc4b73b5770","frontmatter":{"draft":true}},{"id":"3a3c4125-9986-53bb-8b96-ae29936c96ab","frontmatter":{"draft":null}},{"id":"3d71b3f9-8d6b-58a4-b6cb-8293daf99d74","frontmatter":{"draft":null}},{"id":"5010f43b-fdb5-5b2b-8f0c-3b7434219588","frontmatter":{"draft":null}},{"id":"01deffb8-0d62-54c6-9e41-20832cbc3c6e","frontmatter":{"draft":null}},{"id":"067a602f-4581-5707-b896-73190dd8c889","frontmatter":{"draft":null}},{"id":"0bc9da5c-36cb-5e74-8b2f-bf514edbb710","frontmatter":{"draft":null}},{"id":"0c5568c9-6d87-56ed-ab0e-caeb9c1aafa4","frontmatter":{"draft":null}},{"id":"1086a735-7173-58cc-a813-c540a563aedf","frontmatter":{"draft":false}},{"id":"1162dccb-e1bf-576d-a5c6-0993394feb0a","frontmatter":{"draft":true}},{"id":"12222bfa-2e8e-51ee-99d8-8a19902351f5","frontmatter":{"draft":null}},{"id":"1509de3c-7308-5e40-a885-f5ebdb089774","frontmatter":{"draft":null}},{"id":"27f10a38-0ecb-539f-a717-7e40a41bbd10","frontmatter":{"draft":null}},{"id":"29b79017-f96d-5b04-8d01-5b8ee761ebed","frontmatter":{"draft":null}},{"id":"2cfd9e33-b4e1-53e4-884d-d8a6760f3387","frontmatter":{"draft":true}},{"id":"2f30c3f1-0d66-590b-8dba-7836df701d46","frontmatter":{"draft":null}},{"id":"32eca2a3-4169-543c-9c2b-2c11988b3ffb","frontmatter":{"draft":null}},{"id":"3908aafc-c8d3-5c67-821f-0866592449f2","frontmatter":{"draft":true}},{"id":"3c14921d-1ba3-5a7a-93a2-757f3a03ee3a","frontmatter":{"draft":null}},{"id":"46a22c41-5455-557c-85d4-973a6e2220ee","frontmatter":{"draft":null}},{"id":"48c65a15-67ca-57d0-9edc-ebcb868f7ad2","frontmatter":{"draft":true}},{"id":"49cf25c1-03f6-575e-8c2f-638ccd6198ea","frontmatter":{"draft":null}},{"id":"4ed3b747-2001-54f4-9661-3acab89ce275","frontmatter":{"draft":null}},{"id":"4edc1b46-b395-5783-af6a-818b8fc9c2dc","frontmatter":{"draft":null}},{"id":"50951bb1-eb92-5663-a3d8-8f35f73a1322","frontmatter":{"draft":null}},{"id":"50d3cc2a-de7a-5b9a-a8d8-754415fe4d94","frontmatter":{"draft":null}},{"id":"5888c50d-8414-5e8f-b0dc-28a31b29053d","frontmatter":{"draft":null}},{"id":"6b318bb6-2c5f-5f38-93c7-5ed1cca1fff8","frontmatter":{"draft":null}},{"id":"73ab4455-f04d-5320-bf3a-90b9f7441d13","frontmatter":{"draft":null}},{"id":"73d6ab42-b3e6-5663-a175-b1f3d69c29e1","frontmatter":{"draft":null}},{"id":"75550af2-8134-5467-a07d-abbb5a4f6b7c","frontmatter":{"draft":true}},{"id":"7778d041-a5bf-536a-a36f-c0dbc5e08ac7","frontmatter":{"draft":true}},{"id":"78349b16-6e41-5fef-ae38-bcdc5ff297ef","frontmatter":{"draft":true}},{"id":"7a8fc278-a847-5b68-8b74-a83193ba3f55","frontmatter":{"draft":null}},{"id":"7d6499d9-277c-5f07-b8b1-98ae40c50c42","frontmatter":{"draft":true}},{"id":"7d79eb4b-cd4a-5621-a67a-91d9a24dce05","frontmatter":{"draft":null}},{"id":"8b3e46c2-1a1e-5af0-8900-7972c7285d15","frontmatter":{"draft":null}},{"id":"8f7b1b24-7738-5b97-bfb6-fd763f11a664","frontmatter":{"draft":true}},{"id":"961ec1e6-3f2b-59d9-a33f-dad76cf67f47","frontmatter":{"draft":null}},{"id":"97f01467-e3a1-58e1-b2a4-db77354cc1a3","frontmatter":{"draft":null}},{"id":"9f02de74-61a0-5daf-a048-1c1022e08fe4","frontmatter":{"draft":null}},{"id":"9f24363b-ee3e-54bf-8a18-46ea3b269bea","frontmatter":{"draft":null}},{"id":"a091877c-69b8-59f9-8963-1af334fd573c","frontmatter":{"draft":null}},{"id":"a190aac4-0483-5e02-b1d3-261f3b5f313a","frontmatter":{"draft":null}},{"id":"a6c64123-b824-5224-8027-90eb12040396","frontmatter":{"draft":null}},{"id":"b4251348-b618-5b5b-a2c8-e4c6b2431b83","frontmatter":{"draft":true}},{"id":"be594923-185e-5cca-95b6-5267b3c9fc8c","frontmatter":{"draft":null}},{"id":"bfee69af-7d7f-5d87-9680-d2e9b60f8416","frontmatter":{"draft":null}},{"id":"c2249b7b-b97e-5cf4-8ea9-8024e96851b7","frontmatter":{"draft":true}},{"id":"c5e2431a-cf05-5024-b833-e1c69f680d44","frontmatter":{"draft":null}},{"id":"c6def021-b8da-5dbe-ad3e-811d9286424d","frontmatter":{"draft":true}},{"id":"c7a5adfb-149b-5469-ba35-7421e2101951","frontmatter":{"draft":null}},{"id":"cbdf3192-973c-5d87-9cf1-bb9110e9a169","frontmatter":{"draft":null}},{"id":"d29b4513-0609-5cfc-af49-817467dbed1f","frontmatter":{"draft":null}},{"id":"d4d1afa4-f2f9-5942-ae36-2826fb938af5","frontmatter":{"draft":null}},{"id":"db26c6b9-37b4-5cc4-b1ec-c61dc667863e","frontmatter":{"draft":null}},{"id":"dd0c41cf-0a03-5b89-b5a2-f64859aeae63","frontmatter":{"draft":null}},{"id":"e322eac2-bd89-5347-b20d-d050d303a6be","frontmatter":{"draft":null}},{"id":"e376b2d4-df91-5b82-af7a-a8d02763e922","frontmatter":{"draft":true}},{"id":"e4fb8478-b1ad-59eb-95e8-8c5e0500d3f4","frontmatter":{"draft":true}},{"id":"e83330dc-2312-5ae6-95fa-53e86909f42b","frontmatter":{"draft":true}},{"id":"eba9aa6a-6e21-5f1b-a0eb-7b6bfb1e04f1","frontmatter":{"draft":null}},{"id":"ed7af7f9-75f5-59be-9063-de564576eed7","frontmatter":{"draft":true}},{"id":"f06a6ae0-e961-504c-8dab-a60489c0557a","frontmatter":{"draft":true}},{"id":"f0a0e8a2-4d0b-510e-98c2-233ad96f11c2","frontmatter":{"draft":null}},{"id":"f49ce388-e81c-5425-af59-9902f125c20f","frontmatter":{"draft":null}},{"id":"f5a25ce1-67a6-51b2-9bf1-f9fbacb41ad1","frontmatter":{"draft":true}},{"id":"fd6eab68-17d3-5395-8b2b-54a6efe43ebb","frontmatter":{"draft":null}}]}},"pageContext":{"id":"addc6dab-2819-51f8-a0f5-c48cb138eef1"}},"staticQueryHashes":["1800451590","2576926420","63159454"],"slicesMap":{}}